---
title: Sticky Session (AWS 에서 설정하기)
author: keencho
date: 2023-07-03 08:12:00 +0900
categories: [AWS]
tags: [AWS, Application Load Balancer, SAML]
---

# **Sticky Session**

## **1. 개요**  
최근 외부 시스템과 로그인 처리를 연동해야할 일이 있었는데, 해당 시스템은 [SAML](https://ko.wikipedia.org/wiki/SAML)기반 인증 방식 을 사용하고 있었다.  

카카오, 네이버, 구글등은 로그인을 Oauth 2.0 기반의 사용자 인증 기능을 제공하는데, 개인적으로는 SAML 인증 방식은 처음 접해봤다.  

가이드 문서가 잘 되어 있어서 개발환경 / 테스트 환경에서는 문제없이 개발 및 테스트를 진행했다. 그러나 라이브 서버에 배포했을때 문제가 발생했다.
짧지 않은 시간동안 끙끙 앓다가 어느순간 머리를 스치듯 한 생각이 지나갔다.  

`세션 인증 방식을 사용하고 있어 요청 / 응답하는 서버가 다르면 에러가 발생한다?` 라는 생각이다. 실제로 확인해보니, A 인스턴스가 요청한 인증을 B 인스턴스가 받아서 처리하면 에러가 발생한다.  

그렇다면 만약 최초 접속을 A 인스턴스로 하였다면 그 이후의 모든 요청은 A 인스턴스로 라우팅 될 수 있도록 조치가 필요하다. 이때 필요한 것이 Sticky Session 기능이다. nginx로 치면 ip_hash와 비슷하다고 볼 수 있겠다.    

라이브 서버는 Application Load Balancer를 사용하고 있는데 다행히 설정 하나로 Sticky Session 설정이 가능하다.  

## **2. 왜 발생하지?**  
> :exclamation: 개인적으로 기억을 정리하기 위한 문단입니다. 궁금하지 않으신 분들은 다음 문단으로 넘어가 주세요.  

근데 뭔가 이상하다. SAML 토큰에는 일반적으로 서명(signature)이 포함되어 있어 토큰의 무결성을 보장한다. 따라서 요청 서버와 응답 서버가 다르더라도 서명 검증을 통해 SAML 토큰의 유효성을 확인할 수 있다.  

물론 이를 위해선 요청 서버와 인증 서버간 적절한 키 or 인증서 공유가 이루어져야 한다. 나의 경우 이러한 키를 전달받아 적용한 상태였다.  

그런데도 에러가 발생해 라이브러리 코드를 까봤다.
