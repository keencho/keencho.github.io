---
title: AWS 와 함께하는 클라우드 기반  CI/CD 서버 구축 - 6. 무중단 배포 준비
author: keencho
date: 2022-06-12 20:12:00 +0900
categories: [AWS]
tags: [AWS, DevOps]
---

# **무중단 배포 준비 / 수행**

## **S3 접근 IAM 사용자 생성**  
무중단 배포의 흐름은 코드 커밋 -> 커밋 트리거로 github action 수행 -> gradle 빌드 -> jar 파일 s3 전송 -> code deploy 트리거 -> code deploy가 배포 수행 으로 이루어 집니다.  

그 중 github action으로 빌드한 jar 파을 s3에 전송하려면 권한이 있어야 하겠죠? 권한을 가진 사용자를 만들어 보겠습니다.  IAM -> 사용자 생성으로 사용자 추가 화면으로 이동합니다.  

![deploy-ready-2](/assets/img/custom/aws-cicd/build/deploy-ready-2.jpg)  
자격 증명 유형은 프로그래밍 방식 액세스를 선택합니다.  

![deploy-ready-3](/assets/img/custom/aws-cicd/build/deploy-ready-3.jpg)  
정책 필터에 `AmazonS3FullAccess || AWSCodeDeployFullAccess` 를 검색해 나온 두가지 정책을 연결합니다. 그 후 쭉쭉 넘겨 사용자를 생성합니다.  

마지막 5단계에 도달하면 액세스 키와 비밀 액세스 키를 다운받을 수 있는 화면이 나타납니다. 이 자격 증명 csv는 해당 화면에서만 다운받을 수 있으니 잘 저장해 두도록 합니다.  
![deploy-ready-4](/assets/img/custom/aws-cicd/build/deploy-ready-4.jpg)  

## **S3 버킷 생성**  
사용자를 생성하였으니 S3 버킷을 생성하겠습니다. AWS 콘솔 -> S3 -> 버킷 만들기 로 이동하여 버킷을 생성합니다. 이때 모든 퍼블릭 액세스를 차단합니다.  
![deploy-ready-5](/assets/img/custom/aws-cicd/build/deploy-ready-5.jpg)  

## **Github Repository 생성 및 코드 commit & push**  
간단한 Spring boot 어플리케이션을 만들어 Github에 올립니다.  

```java
@RestController
@SpringBootApplication
public class SimpleApplication {

    public static void main(String[] args) {
        SpringApplication.run(SimpleApplication.class, args);
    }

    @GetMapping("/ip")
    public Map<String, String> ip(HttpServletRequest request) throws UnknownHostException {
        return new HashMap<>() {{
            put("hostIp", InetAddress.getLocalHost().getHostAddress());
            put("accessIp", request.getHeader("x-forwarded-for"));
        }};
    }

}
```  

## **Github Repository에 시크릿 키 등록**  
Github Action에 시크릿 키를 그대로 노출시키면 보안상 큰 문제가 되겠죠? 따라서 Workflow에서 변수를 사용할 수 있도록 설정에 시크릿 키를 등록하도록 하겠습니다.  

![deploy-ready-6](/assets/img/custom/aws-cicd/build/deploy-ready-6.jpg)  
위 캡쳐와 같이 repository -> settings -> 좌측 secrets -> actions 로 이동하며 IAM 사용자 생성 마지막 단계에서 저장해 두었던 키값들을 등록합니다.  

## **Github Action Job 설정**  
github workflow에서 s3로 빌드된 jar 파일을 옮기는 job을 추가합니다. .github/workflows/gradle.yml 파일을 만들고 아래 내용을 넣으면 됩니다.

```yml
name: github action codedeploy CI/CD

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Gradlew permission
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build

      - name: Make Directory
        run: mkdir dist

      - name: Copy jar
        run: cp ./build/libs/*.jar ./dist/

      - name: zip
        run: tar -zcvf deploy.tar.gz ./dist

      - name: Upload to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          aws s3 cp \
          --region ap-northeast-2 \
          --acl private \
          ./deploy.tar.gz \
          s3://keencho-codedeploy-s3-bucket/${{ github.run_number }}/deploy.tar.gz  \
```  

run_number를 사용하지 않으면 action이 수행될때마다 새로운 파일이 overwirte 되기 때문에 백업 파일을 남길수 없습니다. 따라서 run_number를 사용하여 백업 파일을 남길수 있도록 하였습니다.  

이제 repository에 push 하고 actions탭에 들어가 작업이 잘 수행되는지 확인합니다. 작업이 모두 성공하였다면 s3로 이동해 deploy.tar.gz 파일이 업로드외어 있는지 확인합니다.  
![deploy-ready-7](/assets/img/custom/aws-cicd/build/deploy-ready-7.jpg)  
![deploy-ready-8](/assets/img/custom/aws-cicd/build/deploy-ready-8.jpg)  




