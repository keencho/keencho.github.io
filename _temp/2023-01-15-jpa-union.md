---
title: JPA 에서 UNION 사용하기
author: keencho
date: 2023-01-15 14:12:00 +0900
categories: [JPA]
tags: [JPA, Hibernate, Spring Data JPA, QueryDSL]
---

// https://github.com/querydsl/querydsl/issues/3438

# **JPA 에서 union 사용하기**
JPA 환경에서 집합 연산자(UNION, UNION ALL, INTERSECT, EXCEPT)를 사용할 수 있을까요? JPA의 버전이 3.1까지 올라왔어도 아직 이에대한 명세, 지원은 없는 것으로 보입니다.
native sql로 작성하면 안되는 쿼리는 없긴 합니다만, 추상화된 SQL을 사용할 수 없다는 단점이 존재합니다. (물론 메인 DB 종류를 휙휙 바꿔버리는 일은 거의 없겠죠)  

Hibernate가 이에 대한 해답이 될 수 있는데요, Hibernate6 버전부터는 집합 연산자들을 지원하기 시작했으며 QueryDSL은 `JPASQLQuery` 클래스를 사용하면 일반적인 native sql보다는 type-safe 하게 쿼리 작성이 가능합니다.
이 포스팅에서는 간단한 예제로 JPA 환경에서 `UNION`을 사용하는 방법에 대해 알아보고자 합니다.

# **예제 세팅**
TODO: gradle file  

![ERD](/assets/img/custom/jpa-union/ERD.JPG)  
`Order` 라는 파티션 테이블이 존재해야 하는데 모종의 이유로 파티션 테이블을 사용하지 못하고 주기적으로 테이블을 직접 분리해야 하는 상황이라고 가정합니다.  

요청받은 데이터의 조건은 다음과 같습니다.

> 1. Order 테이블을 상속하는 모든 테이블의 주문을 합쳐 주세요.
> 2. 22년 6월 데이터는 받는분의 성씨가 '김'씨인 주문만 조회해 주세요.
> 3. 23년 1월 데이터는 상품가격이 10만원 이상인 주문만 조회해 주세요.
> 4. 합쳐진 주문에서 상태값이 'FAILED'인 주문은 제외해 주세요.

이를 sql로 표현하면 다음과 같이 간단히 표현할 수 있습니다. (PostgreSQL 기준)  

```sql
select o.*
from (
         select *
         from order_2206
         where order_2206.toname like '김%'
         union all
         select *
         from order_2209
         union all
         select *
         from order_2211
         union all
         select *
         from order_2212
         union all
         select *
         from order_2301
         where order_2301.itemprice >= 100000
     ) as o
where status <> 'FAILED'
```  

FROM 절에 서브쿼리를 써야하고 그 서브쿼리는 UNION ALL 을 사용합니다. 이제 위 sql문을 JPA로 옮겨보려고 합니다. 

## **1. Hibernate**
[Hibernate는 6 버전부터 집합 연산자들에 대한 지원을 시작하였습니다.](https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#hql-set-operators)
이로써 JPQL과 Criteria API 에서 UNION을 사용할 수 있게 되었습니다. 이게 가능한 이유는 `SQM (Semantic Query Model)` 때문인데요, SQM에 대해서는 [이 문서](https://github.com/hibernate/hibernate-orm/blob/main/design/sqm.adoc)를 읽어보시기 바랍니다.

Hibernate6 이전 버전들의 경우 Criteria API -> JPQL / HQL -> SQL 로 변환되었던 것에 비해 Hibernate6부터는 Criteria APi와 JPQL / HQL이 모두 SQM으로 컴파일되고 최종적으로 이 SQM이 SQL로 변환된다고 하네요.
쿼리 모델을 통합함으로써 Hibernate Criteria Query가 JPA (JPQL) 스펙에서 지원하지 않는 기능들을 지원할 수 있게 되었다고 합니다. 그중 하나가 UNION인 셈이죠.  

참고로 [FROM 절에서의 서브쿼리](https://in.relation.to/2022/06/24/hibernate-orm-61-features/) 또한 Hibernate 6.1 버전부터 지원하기 시작했습니다. 
현재 기준으로 아직 Final 버전이 나오진 않았지만 [Hibernate 6.2 버전부터는 WITH절 또한 지원](https://hibernate.atlassian.net/browse/HHH-15328) 예정이라고 하니, 웬만한 쿼리는 native sql을 사용하지 않아도 될 날이 올수도 있겠네요.
