---
title: JPA 에서 UNION 사용하기
author: keencho
date: 2023-01-15 14:12:00 +0900
categories: [JPA]
tags: [JPA, Hibernate, Spring Data JPA, QueryDSL]
---

# **JPA 에서 union 사용하기**
JPA 환경에서 집합 연산자(UNION, UNION ALL, INTERSECT, EXCEPT)를 사용할 수 있을까요? JPA의 버전이 3.1까지 올라왔어도 아직 이에대한 명세, 지원은 없는 것으로 보입니다.
native sql로 작성하면 안되는 쿼리는 없긴 합니다만, 추상화된 SQL을 사용할 수 없다는 단점이 존재합니다. (물론 메인 DB 종류를 휙휙 바꿔버리는 일은 거의 없겠죠)

Hibernate6 버전부터는 집합 연산자들을 지원하기 시작했으며 QueryDSL은 `JPASQLQuery` 클래스를 사용하면 일반적인 native sql보다는 type-safe 하게 쿼리 작성이 가능합니다.
이 포스팅에서는 간단한 예제로 JPA 환경에서 `UNION`을 사용하는 방법에 대해 알아보고자 합니다.

# **예제 세팅**
TODO: gradle file

## **1. Hibernate**
[Hibernate는 6 버전부터 집합 연산자들에 대한 지원을 시작하였습니다.](https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#hql-set-operators)
이로써 JPQL과 Criteria API 에서 UNION을 사용할 수 있게 되었습니다. 이게 가능한 이유는 `SQM (Semantic Query Model)` 때문인데요, SQM에 대해서는 [이 문서](https://github.com/hibernate/hibernate-orm/blob/main/design/sqm.adoc)를 읽어보시기 바랍니다.

Hibernate6 이전 버전들의 경우 Criteria API -> JPQL / HQL -> SQL 로 변환되었던 것에 비해 Hibernate6부터는 Criteria APi와 JPQL / HQL이 모두 SQM으로 컴파일되고 최종적으로 이 SQM이 SQL로 변환된다고 하네요.
쿼리 모델을 통합함으로써 Hibernate Criteria Query가 JPA (JPQL) 스펙에서 지원하지 않는 기능들을 지원할 수 있게 되었다고 합니다. 그중 하나가 UNION인 셈이죠.
