<!DOCTYPE html><html lang="ko-KS" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 6. CodeDeploy 연동 / 마무리" /><meta name="author" content="keencho" /><meta property="og:locale" content="ko_KS" /><meta name="description" content="AWS를 사용해 무중단 배포 자동화 환경 구축하기 시리즈 개요 VPC와 기본 리소스 VPC와 기본 리소스 생성하기 어플리케이션 구축 및 로드밸런서 적용 AWS 리소스 세팅 CodeDeploy 연동 / 마무리" /><meta property="og:description" content="AWS를 사용해 무중단 배포 자동화 환경 구축하기 시리즈 개요 VPC와 기본 리소스 VPC와 기본 리소스 생성하기 어플리케이션 구축 및 로드밸런서 적용 AWS 리소스 세팅 CodeDeploy 연동 / 마무리" /><link rel="canonical" href="https://keencho.github.io/posts/aws-cicd-6/" /><meta property="og:url" content="https://keencho.github.io/posts/aws-cicd-6/" /><meta property="og:site_name" content="keencho’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-17T20:12:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 6. CodeDeploy 연동 / 마무리" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@keencho" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"keencho"},"dateModified":"2022-07-18T11:47:46+09:00","datePublished":"2022-06-17T20:12:00+09:00","description":"AWS를 사용해 무중단 배포 자동화 환경 구축하기 시리즈 개요 VPC와 기본 리소스 VPC와 기본 리소스 생성하기 어플리케이션 구축 및 로드밸런서 적용 AWS 리소스 세팅 CodeDeploy 연동 / 마무리","headline":"AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 6. CodeDeploy 연동 / 마무리","mainEntityOfPage":{"@type":"WebPage","@id":"https://keencho.github.io/posts/aws-cicd-6/"},"url":"https://keencho.github.io/posts/aws-cicd-6/"}</script><title>AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 6. CodeDeploy 연동 / 마무리 | keencho's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="keencho's blog"><meta name="application-name" content="keencho's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/custom/keencho.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">keencho's blog</a></div><div class="site-subtitle font-italic">이것저것 정리하는 블로그.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/keencho" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['seyoung050412','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 6. CodeDeploy 연동 / 마무리</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 6. CodeDeploy 연동 / 마무리</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1655464320" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 17, 2022 </em> </span><div class="d-flex justify-content-between"> <span> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3768 words"> <em>20 min</em> read</span></div></div></div><div class="post-content"><h1 id="aws를-사용해-무중단-배포-자동화-환경-구축하기-시리즈"><strong>AWS를 사용해 무중단 배포 자동화 환경 구축하기 시리즈</strong></h1><ol><li><a href="/posts/aws-cicd-1">개요</a><li><a href="/posts/aws-cicd-2">VPC와 기본 리소스</a><li><a href="/posts/aws-cicd-3">VPC와 기본 리소스 생성하기</a><li><a href="/posts/aws-cicd-4">어플리케이션 구축 및 로드밸런서 적용</a><li><a href="/posts/aws-cicd-5">AWS 리소스 세팅</a><li><strong>CodeDeploy 연동 / 마무리</strong></ol><h1 id="codedeploy-연동--마무리"><strong>CodeDeploy 연동 / 마무리</strong></h1><h2 id="s3-접근-iam-사용자-생성"><span class="mr-2"><strong>S3 접근 IAM 사용자 생성</strong></span><a href="#s3-접근-iam-사용자-생성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>무중단 배포의 흐름은 <code class="language-plaintext highlighter-rouge">코드 커밋 - 커밋 트리거로 github action 수행 - gradle 빌드 - jar 파일 s3 전송 - code deploy 트리거 - code deploy가 배포 수행</code> 으로 이루어 집니다.</p><p>그 중 github action으로 빌드한 jar 파을 s3에 전송하려면 권한이 있어야 하겠죠? 권한을 가진 사용자를 만들어 보겠습니다. IAM -&gt; 사용자 생성으로 사용자 추가 화면으로 이동합니다.</p><p><img data-src="/assets/img/custom/aws-cicd/build/deploy-ready-2.jpg" alt="deploy-ready-2" data-proofer-ignore><br /> 자격 증명 유형은 프로그래밍 방식 액세스를 선택합니다.</p><p><img data-src="/assets/img/custom/aws-cicd/build/deploy-ready-3.jpg" alt="deploy-ready-3" data-proofer-ignore><br /> 정책 필터에 <code class="language-plaintext highlighter-rouge">AmazonS3FullAccess || AWSCodeDeployFullAccess</code> 를 검색해 나온 두가지 정책을 연결합니다. 그 후 쭉쭉 넘겨 사용자를 생성합니다.</p><p>마지막 5단계에 도달하면 액세스 키와 비밀 액세스 키를 다운받을 수 있는 화면이 나타납니다. 이 자격 증명 csv는 해당 화면에서만 다운받을 수 있으니 잘 저장해 두도록 합니다.<br /> <img data-src="/assets/img/custom/aws-cicd/build/deploy-ready-4.jpg" alt="deploy-ready-4" data-proofer-ignore></p><h2 id="s3-버킷-생성"><span class="mr-2"><strong>S3 버킷 생성</strong></span><a href="#s3-버킷-생성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>사용자를 생성하였으니 S3 버킷을 생성하겠습니다. AWS 콘솔 -&gt; S3 -&gt; 버킷 만들기 로 이동하여 버킷을 생성합니다. 이때 모든 퍼블릭 액세스를 차단합니다.<br /> <img data-src="/assets/img/custom/aws-cicd/build/deploy-ready-5.jpg" alt="deploy-ready-5" data-proofer-ignore></p><h2 id="github-repository-생성-및-코드-commit--push"><span class="mr-2"><strong>Github Repository 생성 및 코드 commit &amp; push</strong></span><a href="#github-repository-생성-및-코드-commit--push" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>간단한 Spring boot 어플리케이션을 만들어 Github에 올립니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="nd">@RestController</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">SimpleApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/ip"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">ip</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UnknownHostException</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"hostIp"</span><span class="o">,</span> <span class="nc">InetAddress</span><span class="o">.</span><span class="na">getLocalHost</span><span class="o">().</span><span class="na">getHostAddress</span><span class="o">());</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"accessIp"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"x-forwarded-for"</span><span class="o">));</span>
        
        <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><h2 id="github-repository에-시크릿-키-등록"><span class="mr-2"><strong>Github Repository에 시크릿 키 등록</strong></span><a href="#github-repository에-시크릿-키-등록" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Github Action에 시크릿 키를 그대로 노출시키면 보안상 큰 문제가 되겠죠? 따라서 Workflow에서 변수를 사용할 수 있도록 설정에 시크릿 키를 등록하도록 하겠습니다.</p><p><img data-src="/assets/img/custom/aws-cicd/build/deploy-ready-6.jpg" alt="deploy-ready-6" data-proofer-ignore><br /> 위 캡쳐와 같이 repository -&gt; settings -&gt; 좌측 secrets -&gt; actions 로 이동하며 IAM 사용자 생성 마지막 단계에서 저장해 두었던 키값들을 등록합니다.</p><h2 id="s3에-업로드하기"><span class="mr-2"><strong>S3에 업로드하기</strong></span><a href="#s3에-업로드하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>github workflow에서 s3로 빌드된 jar 파일을 옮기는 job을 추가합니다. .github/workflows/gradle.yml 파일을 만들고 아래 내용을 넣으면 됩니다.</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">github action codedeploy CI/CD</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">master"</span> <span class="pi">]</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">master"</span> <span class="pi">]</span>

<span class="na">permissions</span><span class="pi">:</span>
  <span class="na">contents</span><span class="pi">:</span> <span class="s">read</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>

    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up JDK </span><span class="m">11</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-java@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">java-version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">11'</span>
          <span class="na">distribution</span><span class="pi">:</span> <span class="s1">'</span><span class="s">temurin'</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Gradlew permission</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">chmod +x gradlew</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build with Gradle</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">./gradlew clean build</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make Directory</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">mkdir dist</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Copy jar</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">cp ./build/libs/*.jar ./dist/</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">zip</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">tar -zcvf deploy.tar.gz ./dist</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Upload to S3</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">AWS_ACCESS_KEY_ID</span><span class="pi">:</span> <span class="s">$</span>
          <span class="na">AWS_SECRET_ACCESS_KEY</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">aws s3 cp \</span>
          <span class="s">--region ap-northeast-2 \</span>
          <span class="s">--acl private \</span>
          <span class="s">./deploy.tar.gz \</span>
          <span class="s">s3://keencho-codedeploy-s3-bucket/$/deploy.tar.gz  \</span>
</pre></table></code></div></div><p>run_number를 사용하지 않으면 action이 수행될때마다 새로운 파일이 overwirte 되기 때문에 백업 파일을 남길수 없습니다. 따라서 run_number를 사용하여 백업 파일을 남길수 있도록 하였습니다.</p><p>이제 repository에 push 하고 actions탭에 들어가 작업이 잘 수행되는지 확인합니다. 작업이 모두 성공하였다면 s3로 이동해 deploy.tar.gz 파일이 업로드외어 있는지 확인합니다.<br /> <img data-src="/assets/img/custom/aws-cicd/build/deploy-ready-7.jpg" alt="deploy-ready-7" data-proofer-ignore><br /> <img data-src="/assets/img/custom/aws-cicd/build/deploy-ready-8.jpg" alt="deploy-ready-8" data-proofer-ignore></p><h2 id="codedeploy-호출"><span class="mr-2"><strong>CodeDeploy 호출</strong></span><a href="#codedeploy-호출" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>s3에 파일이 잘 업로드 되었으니 CodeDeploy를 호출해야 합니다. 스크립트를 수정하기 전 기존 AutoScaling Group에 포함된 인스턴스에 CodeDeploy Agent가 실행중인지 체크하세요.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>sudo service codedeploy-agent status

The AWS CodeDeploy agent is running as PID 23029
</pre></table></code></div></div><p>다음은 스크립트를 수정해 보겠습니다.</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">github action codedeploy CI/CD</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">master"</span> <span class="pi">]</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">master"</span> <span class="pi">]</span>

<span class="na">permissions</span><span class="pi">:</span>
  <span class="na">contents</span><span class="pi">:</span> <span class="s">read</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>

    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>

    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up JDK </span><span class="m">11</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-java@v3</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">java-version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">11'</span>
        <span class="na">distribution</span><span class="pi">:</span> <span class="s1">'</span><span class="s">temurin'</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Gradlew permission</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">chmod +x gradlew</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build with Gradle</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">./gradlew clean build</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make Directory</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">mkdir dist</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Copy jar</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">cp ./build/libs/*.jar ./dist/</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">zip</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">tar -zcvf deploy.tar.gz ./dist</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure AWS Credentials</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">aws-region</span><span class="pi">:</span> <span class="s">ap-northeast-2</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Upload to S3</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">aws s3 cp \</span>
        <span class="s">--region ap-northeast-2 \</span>
        <span class="s">--acl private \</span>
        <span class="s">./deploy.tar.gz \</span>
        <span class="s">s3://keencho-codedeploy-s3-bucket/$/deploy.tar.gz  \</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Call CodeDeploy</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">aws deploy create-deployment \</span>
        <span class="s">--application-name keencho-codedeploy-app \</span>
        <span class="s">--deployment-group-name keencho-codedeploy-app-group \</span>
        <span class="s">--region ap-northeast-2 \</span>
        <span class="s">--s3-location bucket=keencho-codedeploy-s3-bucket,bundleType=tgz,key=$/deploy.tar.gz \</span>

</pre></table></code></div></div><p>aws 인증부분을 <code class="language-plaintext highlighter-rouge">Configure AWS Credentials</code>로 따로 뻈고, <code class="language-plaintext highlighter-rouge">Call CodeDeploy</code> 부분을 추가하였습니다. application-name과 deployment-group-name 이 aws콘솔상의 이름과 일치하는지 다시한번 확인해 보세요.</p><p>이제 다시 github action을 실행시키고 CodeDeploy 콘솔로 이동하여 배포가 진행되는지 확인합니다.</p><blockquote><p><code class="language-plaintext highlighter-rouge">CodeDeploy agent was not able to receive the lifecycle event. Check the CodeDeploy agent logs on your host and make sure the agent is running and can connect to the CodeDeploy server.</code> 라는 에러메시지가 뜨면서 CodeDeploy가 더이상 진행되지 않는다면 이는 CodeDeploy Agent가 설치되어 있지 않다는 뜻입니다.<br /> 앞 포스팅에서 언급한 것처럼 쉘 스크립트의 첫번째 부분에서 -xe를 제거해 보시고, 그래도 안된다면 구글링을 통해 CodeDeploy Agent를 실행시키는 방법을 찾아보세요.</p></blockquote><p><code class="language-plaintext highlighter-rouge">The CodeDeploy agent did not find an AppSpec file within the unpacked revision directory at revision-relative path "appspec.yml"</code> 라는 메시지가 뜨며 배포가 실패한다면 지금까지는 성공입니다.</p><h2 id="appspecyml-세팅"><span class="mr-2"><strong>appspec.yml 세팅</strong></span><a href="#appspecyml-세팅" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>CodeDeploy는 AppSpec file을 배포 관리 yaml 파일로 사용합니다. 이전에 만든 템플릿에는 codedeploy-agent 설치 까지만 진행했었는데요, nginx나 기타 필요한 세팅은 이곳에서 진행됩니다.</p><p>배포될 스프링 부트 프로젝트의 root에서 <code class="language-plaintext highlighter-rouge">codedeploy</code> 라는 폴더를 만들고 appspec.yml 파일을 생성하고 아래 내용을 붙여넣습니다.</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="m">0.0</span>
<span class="na">os</span><span class="pi">:</span> <span class="s">linux</span>
<span class="na">files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">source</span><span class="pi">:</span>  <span class="s">/</span>
    <span class="na">destination</span><span class="pi">:</span> <span class="s">/home/ec2-user</span>
<span class="na">permissions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">object</span><span class="pi">:</span> <span class="s">/</span>
    <span class="na">pattern</span><span class="pi">:</span> <span class="s2">"</span><span class="s">**"</span>
    <span class="na">owner</span><span class="pi">:</span> <span class="s">ec2-user</span>
    <span class="na">group</span><span class="pi">:</span> <span class="s">ec2-user</span>
<span class="na">hooks</span><span class="pi">:</span>
  <span class="na">AfterInstall</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">location</span><span class="pi">:</span> <span class="s">init.sh</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="m">300</span>
      <span class="na">runas</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">ApplicationStart</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">location</span><span class="pi">:</span> <span class="s">deploy.sh</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="m">300</span>
      <span class="na">runas</span><span class="pi">:</span> <span class="s">ec2-user</span>
  <span class="na">ValidateService</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">location</span><span class="pi">:</span> <span class="s">validate.sh</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="m">200</span>
      <span class="na">runas</span><span class="pi">:</span> <span class="s">ec2-user</span>
</pre></table></code></div></div><p>위 파일을 보시면 <code class="language-plaintext highlighter-rouge">hooks</code> 섹션을 확인하실 수 있습니다. hooks 섹션은 이름에서도 유추 가능하듯이 인스턴스 배포시 각각 한번 실행됩니다. 각각의 훅이 실행되는 시점에 대한 자세한 내용은 <a href="https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/reference-appspec-file-structure-hooks.html#appspec-hooks-server">이곳</a>을 참고 하세요.</p><p>많은 훅들이 있지만 여기서 사용할 훅은 세가지 입니다. 그중 먼저 AfterInstall 훅에 사용될 스크립트를 정의해 보겠습니다.</p><h5 id="afterinstall"><span class="mr-2"><strong>AfterInstall</strong></span><a href="#afterinstall" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>appspec.yml 파일이 위치한 곳에 init.sh 파일을 생성합니다.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="c"># 타임존 세팅</span>
<span class="nb">rm</span> /etc/localtime
<span class="nb">ln</span> <span class="nt">-s</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime

<span class="c"># nginx 설치</span>
amazon-linux-extras <span class="nb">install </span>nginx1 <span class="nt">-y</span>
systemctl <span class="nb">enable </span>nginx
systemctl start nginx
<span class="nb">chmod </span>755 /var/log/nginx

<span class="c"># nginx config file 위치 이동</span>
<span class="nb">mv</span> /home/ec2-user/nginx/<span class="k">*</span>.conf /etc/nginx/conf.d/
<span class="nb">rm</span> <span class="nt">-rf</span> /home/ec2-user/nginx

systemctl restart nginx

<span class="c"># open jdk 11 설치</span>
amazon-linux-extras <span class="nb">install </span>java-openjdk11 <span class="nt">-y</span>

<span class="c"># deploy.sh 권한 변경</span>
<span class="nb">chmod</span> +x /home/ec2-user/deploy.sh
</pre></table></code></div></div><p>타임존 세팅, nginx 설치, nginx config 설정, open jdk 11 설치, deploy.sh 권한 변경 작업이 이루어집니다. 이것이 시작 템플릿의 사용자 데이터에서 nginx나 jdk등을 설치하지 않는 이유입니다.</p><p>위 스크립트를 보시면 중간에 미리 정의해둔 nginx config 파일을 옮기는 부분이 있습니다. 프로젝트 root &gt; codedeploy &gt; nginx 폴더를 생성하고 nginx.conf 파일을 만들고 아래 내용을 작성하겠습니다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>server {

        set $proxy_pass http://127.0.0.1:8090;

        listen 80;

        location /health {
            access_log off;
            return 200;
        }

        location / {
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name;
            proxy_read_timeout 120;

            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;

            proxy_pass $proxy_pass;
        }
}
</pre></table></code></div></div><p>이전 포스팅에서 로드밸랜서 / 대상그룹에 대해 알아본 적이 있습니다. 테스트 어플리케이션도 하나 만들었지요. 그때 <code class="language-plaintext highlighter-rouge">/health</code> 경로에 대해 200 상태값을 반환하도록 설정하였었는데요, 여기서도 동일합니다. 대상 그룹이 새로운 인스턴스의 health 상태를 체크하기 위해 사용됩니다.</p><h5 id="applicationstart"><span class="mr-2"><strong>ApplicationStart</strong></span><a href="#applicationstart" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>인스턴스 세팅이 끝났으니 SpringBoot 어플리케이션을 실행하는 스크립트가 필요합니다. appspec.yml 파일이 위치한 곳에 deploy.yml 파일을 생성합니다.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="nb">nohup </span>java <span class="nt">-jar</span> <span class="nt">-Dserver</span>.port<span class="o">=</span>8090 /home/ec2-user/application.jar 1&gt; /dev/null 2&gt;&amp;1 &amp;
<span class="nb">sleep </span>30s
</pre></table></code></div></div><p>스프링부트의 포트와 nginx의 포트가 일치하는지 확인합니다.</p><h5 id="validateservice"><span class="mr-2"><strong>ValidateService</strong></span><a href="#validateservice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>혹시 스프링부트가 뜨지 않았다면 어떻게 할까요?(예를들어 하이버네이트의 스키마 검증…) 타겟그룹은 <code class="language-plaintext highlighter-rouge">현재인스턴스/health</code> 경로로 health-check 를 진행하였기 때문에 인스턴스 내부의 어플리케이션이 정상적으로 동작하는지 까지는 확인하지 않습니다. 따라서 여기서는 별도의 스크립트를 통해 어플리케이션이 잘 시작되었는지 확인하겠습니다.</p><p>일단 스프링부트 어플리케이션에 메소드를 추가해 보겠습니다. 단순히 200 상태값을 체크하는데 사용되는 메소드 입니다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>@GetMapping("/script-health-check")
    public ResponseEntity&lt;?&gt; scriptHealthCheck() {
        return ResponseEntity.ok().build();
    }

</pre></table></code></div></div><p>appspec.yml 파일이 위치한 곳에 validate.sh 파일을 생성합니다.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
validate <span class="o">()</span> <span class="o">{</span>
	<span class="nv">count</span><span class="o">=</span>1
	<span class="k">while</span> <span class="o">[</span> <span class="k">${</span><span class="nv">count</span><span class="k">}</span> <span class="nt">-le</span> 11 <span class="o">]</span><span class="p">;</span> <span class="k">do
		</span><span class="nv">response</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">--write-out</span> <span class="s1">'%{http_code}'</span> <span class="nt">--silent</span> <span class="nt">--output</span> /dev/null <span class="nv">$1</span><span class="si">)</span>

		<span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">response</span><span class="k">}</span> <span class="nt">-eq</span> 200 <span class="o">]</span><span class="p">;</span> <span class="k">then
			</span><span class="nb">break
		</span><span class="k">else
			if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">count</span><span class="k">}</span> <span class="nt">-eq</span> 11 <span class="o">]</span><span class="p">;</span> <span class="k">then
				</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2"> 어플리케이션 검증 실패"</span>
				<span class="nb">exit </span>1
			<span class="k">fi

			</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2"> 어플리케이션 검증 재시도... </span><span class="k">${</span><span class="nv">count</span><span class="k">}</span><span class="s2">"</span>
			<span class="nb">sleep </span>10s
			<span class="nv">count</span><span class="o">=</span><span class="k">$((</span>count <span class="o">+</span> <span class="m">1</span><span class="k">))</span>
		<span class="k">fi
	done</span>

<span class="o">}</span>

validate <span class="s2">"localhost:8090/script-health-check"</span> <span class="s2">"샘플"</span>
</pre></table></code></div></div><p>총 열번, 각 시도마다 10초의 유휴시간을 가지는 검증 스크립트 입니다. 검증에 실패한다면 exit1 코드를 통해 CodeDeploy 배포가 종료되게 됩니다.</p><h5 id="gradleyml-최종수정"><span class="mr-2"><strong>gradle.yml 최종수정</strong></span><a href="#gradleyml-최종수정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>필요한 스크립트들이 스프링부터 jar 파일과 같이 압축될수 있도록 yml 파일을 최종 수정합니다.</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">github action codedeploy CI/CD</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">master"</span> <span class="pi">]</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">master"</span> <span class="pi">]</span>

<span class="na">permissions</span><span class="pi">:</span>
  <span class="na">contents</span><span class="pi">:</span> <span class="s">read</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>

    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up JDK </span><span class="m">11</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-java@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">java-version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">11'</span>
          <span class="na">distribution</span><span class="pi">:</span> <span class="s1">'</span><span class="s">temurin'</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Gradlew permission</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">chmod +x gradlew</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build with Gradle</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">./gradlew clean build</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make Directory</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">mkdir dist</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Move Jar</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">mv ./build/libs/*.jar ./dist/application.jar</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Move CodeDeploy Script</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">mv ./codedeploy/* ./dist/</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">zip</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">tar -zcvf deploy.tar.gz ./dist</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure AWS Credentials</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">$</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">$</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">ap-northeast-2</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Upload to S3</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">aws s3 cp \</span>
          <span class="s">--region ap-northeast-2 \</span>
          <span class="s">--acl private \</span>
          <span class="s">./deploy.tar.gz \</span>
          <span class="s">s3://keencho-codedeploy-s3-bucket/$/deploy.tar.gz  \</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Call CodeDeploy</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">aws deploy create-deployment \</span>
          <span class="s">--application-name keencho-codedeploy-app \</span>
          <span class="s">--deployment-group-name keencho-codedeploy-app-group \</span>
          <span class="s">--region ap-northeast-2 \</span>
          <span class="s">--s3-location bucket=keencho-codedeploy-s3-bucket,bundleType=tgz,key=$/deploy.tar.gz \</span>


</pre></table></code></div></div><blockquote><p>Move CodeDeploy Script 부분이 추가되었습니다.</p></blockquote><h2 id="결과-확인"><span class="mr-2"><strong>결과 확인</strong></span><a href="#결과-확인" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>이제 필요한 스크립트는 모두 작성되었습니다. Github에 push하여 결과를 확인합니다.</p><p>CodeDeploy 콘솔에서 작업이 성공적으로 끝난것을 확인하였다면 로드밸런서의 DNS 를 통해 사이트로 접속하여 결과물을 확인합니다. 결과를 확인하였다면 이제는 스프링부트 어플리케이션에 테스트 메소드를 추가하여 다시한번 CodeDeploy 배포를 수행해 보세요.</p><p>CodeDeploy 를 확인하면서 수시로 사이트에 접속해 보세요. 이전 어플리케이션과 최신 어플리케이션이 번갈아가며 호출되는것을 확인할 수 있습니다. 로드밸런서가 어떤 식으로 동작하는지 파악 / 확인하는것은 중요합니다. (포스팅에서 사용된 형태의 스프링 부트 어플리케이션을 사용하셨다면 ec2 인스턴스의 private ip로 확인할 수 있습니다.)</p><blockquote><p>이 시점에서 만약 CodeDeploy Task가 시작조차 못하고 첫번째 단계인 Application Stop 에서 멈춰버린다면, 새로운 인스턴스에 CodeDeploy Agent가 설치되지 않았음을 의미합니다.<br /> /var/log/cloud-init-output.log 에서 확인하실 수 있는데요, 제 경우는 실수로 NAT 게이트웨이를 삭제해 외부 인터넷 연결이 되지 않아 yum 패키지를 다운받을 수 없어 에러가 발생 하였습니다.<br /> 다양한 원인이 있을 수 있으므로 문제 발생시 위 로그를 확인해 보세요.</p></blockquote><p><img data-src="/assets/img/custom/aws-cicd/build/deploy-ready-9.jpg" alt="deploy-ready-9" data-proofer-ignore><br /> <em>모든 TASK가 성공하였습니다!</em></p><h1 id="마무리"><strong>마무리</strong></h1><p>이 시리즈에서는 VPC생성, 서브넷 생성부터 Github Action, CodeDeploy까지 진행해 보았습니다. 사실 실제 프로덕션 환경에서는 실경써줘야할 부분이 더 많습니다.</p><p>예를들어 CodeDeploy 배포에 실패한 경우 CodeDeploy 에 의해 새롭게 시작된 Auto Scaling Group은 자동종료되지 않기 때문에 새로운 인스턴스가 실행된 상태(아무것도 하지 않는 상태)로 멈추어 이중 과금이 발생합니다. 따라서 이에 대응할 전략이 필요합니다. 제 경우 CodeDeploy의 성공 / 실패 여부를 30초마다 Polling 하는 스크립트를 Jenkins에 포함시켜서 실패한 경우 미리 정의해둔 롤백 람다를 호출하는 방식을 사용하고 있습니다.</p><p>세세한 부분까지 신경쓰지 못했지만 이 포스팅이 AWS를 이용해 무중단 배포를 구현하시려는 분들께 도움이 되길 바랍니다.</p><blockquote><p>이 포스팅에서 사용된 전체 코드는 <a href="https://github.com/keencho/github-action-codedeploy-sample">이곳</a> 에서 확인하실 수 있습니다.</p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/aws/'>AWS</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >AWS</a> <a href="/tags/devops/" class="post-tag no-text-decoration" >DevOps</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AWS%EB%A5%BC+%EC%82%AC%EC%9A%A9%ED%95%B4+%EB%AC%B4%EC%A4%91%EB%8B%A8+%EB%B0%B0%ED%8F%AC+%EC%9E%90%EB%8F%99%ED%99%94+%ED%99%98%EA%B2%BD+%EA%B5%AC%EC%B6%95%ED%95%98%EA%B8%B0+-+6.+CodeDeploy+%EC%97%B0%EB%8F%99+%2F+%EB%A7%88%EB%AC%B4%EB%A6%AC+-+keencho%27s+blog&url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Faws-cicd-6%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AWS%EB%A5%BC+%EC%82%AC%EC%9A%A9%ED%95%B4+%EB%AC%B4%EC%A4%91%EB%8B%A8+%EB%B0%B0%ED%8F%AC+%EC%9E%90%EB%8F%99%ED%99%94+%ED%99%98%EA%B2%BD+%EA%B5%AC%EC%B6%95%ED%95%98%EA%B8%B0+-+6.+CodeDeploy+%EC%97%B0%EB%8F%99+%2F+%EB%A7%88%EB%AC%B4%EB%A6%AC+-+keencho%27s+blog&u=https%3A%2F%2Fkeencho.github.io%2Fposts%2Faws-cicd-6%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Faws-cicd-6%2F&text=AWS%EB%A5%BC+%EC%82%AC%EC%9A%A9%ED%95%B4+%EB%AC%B4%EC%A4%91%EB%8B%A8+%EB%B0%B0%ED%8F%AC+%EC%9E%90%EB%8F%99%ED%99%94+%ED%99%98%EA%B2%BD+%EA%B5%AC%EC%B6%95%ED%95%98%EA%B8%B0+-+6.+CodeDeploy+%EC%97%B0%EB%8F%99+%2F+%EB%A7%88%EB%AC%B4%EB%A6%AC+-+keencho%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/jpa-flush/">JPA & Hibernate Flush Mode</a><li><a href="/posts/aws-cicd-1/">AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 1. 개요</a><li><a href="/posts/terraform-aws-infra-6/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)</a><li><a href="/posts/aapt2-arm/">Arm 아키텍처에서 AAPT2 빌드 도구 사용하기</a><li><a href="/posts/terraform-aws-infra-1/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 1. 개요</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/aws-cicd-1/"><div class="card-body"> <em class="small" data-ts="1624271520" data-df="ll" > Jun 21, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 1. 개요</h3><div class="text-muted small"><p> AWS를 사용해 무중단 배포 자동화 환경 구축하기 시리즈 개요 VPC와 기본 리소스 VPC와 기본 리소스 생성하기 어플리케이션 구축 및 로드밸런서 적용 AWS 리소스 세팅 CodeDeploy 연동 / 마무리 개요 AWS를 이용하여 가장 기본적인 형태의 인프라를 구축하고 GithubAction - CodeDeploy 를 이용하...</p></div></div></a></div><div class="card"> <a href="/posts/aws-cicd-2/"><div class="card-body"> <em class="small" data-ts="1624360320" data-df="ll" > Jun 22, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 2. VPC와 기본 리소스</h3><div class="text-muted small"><p> AWS를 사용해 무중단 배포 자동화 환경 구축하기 시리즈 개요 VPC와 기본 리소스 VPC와 기본 리소스 생성하기 어플리케이션 구축 및 로드밸런서 적용 AWS 리소스 세팅 CodeDeploy 연동 / 마무리 VPC와 기본 리소스 서버 구축의 첫번째 단계로 AWS의 VPC (Virtual Private Cloud) 와 기본 리...</p></div></div></a></div><div class="card"> <a href="/posts/aws-cicd-3/"><div class="card-body"> <em class="small" data-ts="1624670880" data-df="ll" > Jun 26, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 3. VPC와 기본 리소스 생성하기</h3><div class="text-muted small"><p> AWS를 사용해 무중단 배포 자동화 환경 구축하기 시리즈 개요 VPC와 기본 리소스 VPC와 기본 리소스 생성하기 어플리케이션 구축 및 로드밸런서 적용 AWS 리소스 세팅 CodeDeploy 연동 / 마무리 VPC와 기본 리소스 생성하기 AWS 콘솔을 사용해 직접 VPC와 필요한 리소스들을 생성해 보겠습니다. VPC 생성하...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/aws-cicd-5/" class="btn btn-outline-primary" prompt="Older"><p>AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 5. AWS 리소스 세팅</p></a> <a href="/posts/aws-alb-ssl/" class="btn btn-outline-primary" prompt="Newer"><p>AWS Application Load Balancer에 SSL 인증서 적용하기</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/keencho">keencho</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
