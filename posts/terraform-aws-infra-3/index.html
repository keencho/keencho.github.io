<!DOCTYPE html><html lang="ko-KS" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Terraform으로 AWS 무중단 배포 인프라 구성하기 - 3. 네트워크" /><meta name="author" content="keencho" /><meta property="og:locale" content="ko_KS" /><meta name="description" content="Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리" /><meta property="og:description" content="Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리" /><link rel="canonical" href="https://keencho.github.io/posts/terraform-aws-infra-3/" /><meta property="og:url" content="https://keencho.github.io/posts/terraform-aws-infra-3/" /><meta property="og:site_name" content="keencho’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-02-03T08:12:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Terraform으로 AWS 무중단 배포 인프라 구성하기 - 3. 네트워크" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@keencho" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"keencho"},"dateModified":"2024-06-22T14:59:22+09:00","datePublished":"2024-02-03T08:12:00+09:00","description":"Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리","headline":"Terraform으로 AWS 무중단 배포 인프라 구성하기 - 3. 네트워크","mainEntityOfPage":{"@type":"WebPage","@id":"https://keencho.github.io/posts/terraform-aws-infra-3/"},"url":"https://keencho.github.io/posts/terraform-aws-infra-3/"}</script><title>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 3. 네트워크 | keencho's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="keencho's blog"><meta name="application-name" content="keencho's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end">
<div class="profile-wrapper text-center">
<div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/custom/keencho.jpg" alt="avatar" onerror="this.style.display='none'"> </a>
</div>
<div class="site-title mt-3"> <a href="/">keencho's blog</a>
</div>
<div class="site-subtitle font-italic">이것저것 정리하는 블로그.</div>
</div>
<ul class="w-100">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a>
</li>
<li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a>
</li>
</ul>
<div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/keencho" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20['seyoung050412','gmail.com'].join('@')" aria-label="email"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> </a>
</div>
</div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 3. 네트워크</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div>
<i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel">Cancel</span>
</div></div><div id="main-wrapper" class="d-flex justify-content-center">
<div id="main" class="container pl-xl-4 pr-xl-4">
<div class="row">
<div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2">
<h1 data-toc-skip>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 3. 네트워크</h1>
<div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1706915520" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 3, 2024 </em> </span><div class="d-flex justify-content-between"> <span> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2186 words"> <em>12 min</em> read</span>
</div>
</div>
</div>
<div class="post-content">
<h1 id="terraform으로-aws-무중단-배포-인프라-구성하기"><strong>Terraform으로 AWS 무중단 배포 인프라 구성하기</strong></h1>
<ol>
<li><a href="/posts/terraform-aws-infra-1">개요</a></li>
<li><a href="/posts/terraform-aws-infra-2">기초</a></li>
<li><strong>네트워크</strong></li>
<li><a href="/posts/terraform-aws-infra-4">테스트 환경</a></li>
<li><a href="/posts/terraform-aws-infra-5">운영환경 (프론트)</a></li>
<li><a href="/posts/terraform-aws-infra-6">운영환경 (백엔드)</a></li>
<li><a href="/posts/terraform-aws-infra-7">마무리</a></li>
</ol>
<h1 id="terraform으로-aws-ecs-무중단-배포-인프라-구성하기---3-네트워크"><strong>Terraform으로 AWS ECS 무중단 배포 인프라 구성하기 - 3. 네트워크</strong></h1>
<p>이번 포스팅부터 본격적으로 AWS 리소스를 생성한다. 그 첫번째로 인프라 구성에 가장 기본이 되는 네트워크 관련 리소스(vpc, subnet 등…)부터 생성한다.</p>
<p>이 글에선 vpc, subnet등이 무엇인지 설명하진 않는다. <a href="https://keencho.github.io/posts/aws-cicd-1/">이 시리즈</a> 를 따라가다 보면 개념들을 확인할 수 있으니 모르시는 분들은 읽어보시기 바란다.</p>
<p>시작하기전 기초 코드를 작성한다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td>
<td class="rouge-code"><pre><span class="c1"># main.tf</span>
<span class="nx">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/aws"</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt; 4.16"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">required_version</span> <span class="o">=</span> <span class="s2">"&gt;= 1.2.0"</span>
<span class="p">}</span>

<span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>

  <span class="nx">default_tags</span> <span class="p">{</span>
    <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">Project</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">app_project_name</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"app_name"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The name of application"</span>
  <span class="nx">type</span> <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">default</span> <span class="o">=</span> <span class="s2">"app"</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"app_project_name"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The name of Project"</span>
  <span class="nx">type</span> <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">default</span> <span class="o">=</span> <span class="s2">"appProject"</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>전역적으로 <code class="language-plaintext highlighter-rouge">Project</code> 태그를 세팅하였다. 한 계정에 프로젝트가 1개이면 상관없지만, 프로젝트가 N개라면 프로젝트를 분리하여 지정했을 시 프로젝트 별로 비용을 확인할 수 있기 때문에 편리하다.</p>
<h2 id="변수">
<span class="mr-2"><strong>변수</strong></span><a href="#%EB%B3%80%EC%88%98" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p><a href="https://developer.hashicorp.com/terraform/language/values/variables">변수</a>를 활용한다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td>
<td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"aws_region"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The AWS region to deploy the VPC in"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="s2">"ap-northeast-2"</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"availability_zones"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"List of availability zones to use"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"vpc_cidr"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The CIDR block for the VPC"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="s2">"10.0.0.0/16"</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"public_subnet_cidrs"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The CIDR blocks for the public subnets"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="p">[</span><span class="s2">"10.0.1.0/24"</span><span class="p">,</span> <span class="s2">"10.0.2.0/24"</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"private_subnet_cidrs"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The CIDR blocks for the private subnets"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="p">[</span><span class="s2">"10.0.3.0/24"</span><span class="p">,</span> <span class="s2">"10.0.4.0/24"</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"db_subnet_cidrs"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The CIDR blocks for the DB subnets"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="p">[</span><span class="s2">"10.0.5.0/24"</span><span class="p">,</span> <span class="s2">"10.0.6.0/24"</span><span class="p">]</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>위 변수들은 네트워크 리소스 생성에 필요한 변수들이다. 이 예제에서는 a, b 2개의 가용존을 사용한다. 만약 a, b, c, d 모두 사용하고 싶다면</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td>
<td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"availability_zones"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"List of availability zones to use"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">,</span> <span class="s2">"c"</span><span class="p">,</span> <span class="s2">"d"</span><span class="p">]</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>위와 깉이 기본 값만 수정해주면 쉽게 가용존을 확장할 수 있다. (물론 서브넷 cidr 도 수정해 줘야 한다.) 웹 콘솔 환경에서 하나하나 클릭하면서 생성할때와 비교해 봤을때 생산성이 눈에 띄게 늘어남을 확인할 수 있을 것이다.</p>
<h2 id="리소스">
<span class="mr-2"><strong>리소스</strong></span><a href="#%EB%A6%AC%EC%86%8C%EC%8A%A4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<h3 id="1-vpc">
<span class="mr-2"><strong>1. VPC</strong></span><a href="#1-vpc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_vpc"</span> <span class="s2">"vpc"</span> <span class="p">{</span>
  <span class="nx">cidr_block</span>           <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">vpc_cidr</span>
  <span class="nx">enable_dns_support</span>   <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">enable_dns_hostnames</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"${var.app_name}-vpc"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>첫번째로 VPC를 생성한다.</p>
<h3 id="2-internet-gateway">
<span class="mr-2"><strong>2. Internet Gateway</strong></span><a href="#2-internet-gateway" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_internet_gateway"</span> <span class="s2">"igw"</span> <span class="p">{</span>
  <span class="nx">vpc_id</span> <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"${var.app_name}-igw"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>다음으로 퍼블릭 서브넷에 붙일 용도로 Internet Gateway를 생성한다.</p>
<h3 id="3-nat-gateway">
<span class="mr-2"><strong>3. NAT Gateway</strong></span><a href="#3-nat-gateway" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_eip"</span> <span class="s2">"nat"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">public_subnet_cidrs</span><span class="p">)</span>
  <span class="nx">vpc</span>   <span class="o">=</span> <span class="kc">true</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"${var.app_name}-nat-eip-${element(var.availability_zones, count.index)}"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_nat_gateway"</span> <span class="s2">"nat"</span> <span class="p">{</span>
  <span class="nx">count</span>         <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">public_subnet_cidrs</span><span class="p">)</span>
  <span class="nx">allocation_id</span> <span class="o">=</span> <span class="nx">aws_eip</span><span class="p">.</span><span class="nx">nat</span><span class="p">[</span><span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">id</span>
  <span class="nx">subnet_id</span>     <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">aws_subnet</span><span class="p">.</span><span class="nx">public</span><span class="p">[*].</span><span class="nx">id</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"${var.app_name}-nat-${element(var.availability_zones, count.index)}"</span>
  <span class="p">}</span>

  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_internet_gateway</span><span class="p">.</span><span class="nx">igw</span><span class="p">]</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>다음으로 프라이빗 서브넷에 붙일 용도로 NAT Gateway를 생성한다. NAT Gateway는 탄력적 ip를 필요로 하기 때문에 이 또한 생성한다.</p>
<h3 id="4-routing-table">
<span class="mr-2"><strong>4. Routing Table</strong></span><a href="#4-routing-table" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_route_table"</span> <span class="s2">"rt-public"</span> <span class="p">{</span>
  <span class="nx">vpc_id</span> <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"${var.app_name}-rt-public"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_main_route_table_association"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">vpc_id</span>         <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">route_table_id</span> <span class="o">=</span> <span class="nx">aws_route_table</span><span class="p">.</span><span class="nx">rt-public</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_route"</span> <span class="s2">"route-public"</span> <span class="p">{</span>
  <span class="nx">route_table_id</span>         <span class="o">=</span> <span class="nx">aws_route_table</span><span class="p">.</span><span class="nx">rt-public</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">destination_cidr_block</span> <span class="o">=</span> <span class="s2">"0.0.0.0/0"</span>
  <span class="nx">gateway_id</span>             <span class="o">=</span> <span class="nx">aws_internet_gateway</span><span class="p">.</span><span class="nx">igw</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_route_table"</span> <span class="s2">"rt-private"</span> <span class="p">{</span>
  <span class="nx">count</span>  <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_cidrs</span><span class="p">)</span>
  <span class="nx">vpc_id</span> <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"${var.app_name}-rt-private-${element(var.availability_zones, count.index)}"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_route"</span> <span class="s2">"route-private"</span> <span class="p">{</span>
  <span class="nx">count</span>                <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_cidrs</span><span class="p">)</span>
  <span class="nx">route_table_id</span>       <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">aws_route_table</span><span class="p">.</span><span class="nx">rt-private</span><span class="p">[*].</span><span class="nx">id</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
  <span class="nx">destination_cidr_block</span> <span class="o">=</span> <span class="s2">"0.0.0.0/0"</span>
  <span class="nx">nat_gateway_id</span>       <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">aws_nat_gateway</span><span class="p">.</span><span class="nx">nat</span><span class="p">[*].</span><span class="nx">id</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>다음으로 라우팅 테이블을 생성한다. 1개의 퍼블릭 라우팅 테이블과 각각의 존에 존재하는 2개의 프라이빗 라우팅 테이블을 생성하였으며 퍼블릭 라우팅 테이블을 기본 라우팅 테이블로 지정한다.</p>
<p>퍼블릭 서브넷의 아웃바운드 트래픽은 Internet Gateway로, 프라이빗 서브넷의 아웃바운드 트래픽은 NAT Gateway로 전송한다.</p>
<blockquote><p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> VPC 생성시 AWS는 기본적으로 라우팅 테이블을 하나 생성한다. 위 구성에서 생성한 라우팅 테이블과는 전혀 관련없는 라우팅 테이블이다. 뭔가 깔끔(?) 하게 구성하려면 콘솔에서 혹은 CLI로 직접 해당 라우팅 테이블을 삭제하면 된다. (Terraform 차원에서는 살짝 어려운듯 하다.) 여기서는 진행하지 않는다.</p></blockquote>
<h3 id="5-subnet">
<span class="mr-2"><strong>5. Subnet</strong></span><a href="#5-subnet" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_subnet"</span> <span class="s2">"public"</span> <span class="p">{</span>
  <span class="nx">count</span>                   <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">public_subnet_cidrs</span><span class="p">)</span>
  <span class="nx">vpc_id</span>                  <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">cidr_block</span>              <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">public_subnet_cidrs</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
  <span class="nx">map_public_ip_on_launch</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">availability_zone</span>       <span class="o">=</span> <span class="s2">"${var.aws_region}${element(var.availability_zones, count.index)}"</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"${var.app_name}-subnet-public-${element(var.availability_zones, count.index)}"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_subnet"</span> <span class="s2">"private"</span> <span class="p">{</span>
  <span class="nx">count</span>             <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_cidrs</span><span class="p">)</span>
  <span class="nx">vpc_id</span>            <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">cidr_block</span>        <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_cidrs</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
  <span class="nx">availability_zone</span> <span class="o">=</span> <span class="s2">"${var.aws_region}${element(var.availability_zones, count.index)}"</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"${var.app_name}-subnet-private-${element(var.availability_zones, count.index)}"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_subnet"</span> <span class="s2">"private-db"</span> <span class="p">{</span>
  <span class="nx">count</span>             <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">db_subnet_cidrs</span><span class="p">)</span>
  <span class="nx">vpc_id</span>            <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">cidr_block</span>        <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">db_subnet_cidrs</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
  <span class="nx">availability_zone</span> <span class="o">=</span> <span class="s2">"${var.aws_region}${element(var.availability_zones, count.index)}"</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"${var.app_name}-subnet-db-private-${element(var.availability_zones, count.index)}"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>한개의 퍼블릭 서브넷과 4개의 프라이빗 서브넷 (2 for app, 2 for db)을 생성한다.</p>
<h3 id="6-subnet-association">
<span class="mr-2"><strong>6. Subnet Association</strong></span><a href="#6-subnet-association" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_route_table_association"</span> <span class="s2">"rt-public-association"</span> <span class="p">{</span>
  <span class="nx">count</span>          <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">public_subnet_cidrs</span><span class="p">)</span>
  <span class="nx">subnet_id</span>      <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">aws_subnet</span><span class="p">.</span><span class="nx">public</span><span class="p">[*].</span><span class="nx">id</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
  <span class="nx">route_table_id</span> <span class="o">=</span> <span class="nx">aws_route_table</span><span class="p">.</span><span class="nx">rt-public</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_route_table_association"</span> <span class="s2">"rt-private-association"</span> <span class="p">{</span>
  <span class="nx">count</span>          <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_cidrs</span><span class="p">)</span>
  <span class="nx">subnet_id</span>      <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">aws_subnet</span><span class="p">.</span><span class="nx">private</span><span class="p">[*].</span><span class="nx">id</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
  <span class="nx">route_table_id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">aws_route_table</span><span class="p">.</span><span class="nx">rt-private</span><span class="p">[*].</span><span class="nx">id</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_route_table_association"</span> <span class="s2">"rt-private-db-association"</span> <span class="p">{</span>
  <span class="nx">count</span>          <span class="o">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">db_subnet_cidrs</span><span class="p">)</span>
  <span class="nx">subnet_id</span>      <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">aws_subnet</span><span class="p">.</span><span class="nx">private-db</span><span class="p">[*].</span><span class="nx">id</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
  <span class="nx">route_table_id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">aws_route_table</span><span class="p">.</span><span class="nx">rt-private</span><span class="p">[*].</span><span class="nx">id</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>마지막으로 서브넷과 라우팅 테이블들을 명시적으로 연결한다.</p>
<h2 id="리소스-맵">
<span class="mr-2"><strong>리소스 맵</strong></span><a href="#%EB%A6%AC%EC%86%8C%EC%8A%A4-%EB%A7%B5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p><img data-src="/assets/img/custom/terraform-aws-infra/vpc-resource-map.png" alt="리소스 맵" data-proofer-ignore></p>
<p>VPC 콘솔로 들어가 리소스 맵을 확인해 보자. 위와같이 리소스가 구성되어 있으면 된다. 더욱더 확실하게 확인하려면 각각의 리소스 콘솔로 이동하여 확인해보자.</p>
<h2 id="route-53--ssl-인증서">
<span class="mr-2"><strong>Route 53 &amp; SSL 인증서</strong></span><a href="#route-53--ssl-%EC%9D%B8%EC%A6%9D%EC%84%9C" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>원할한 진행을 위해 Route 53 호스팅 영억을 생성하고 AWS Certificate Manager를 통해 SSL 인증서를 발급받아 두도록 하겠다. (추후 CloudFront 구성시 대체 도메인을 연결해야 하는데, 이때 SSL 인증서가 필수이다.)</p>
<p>각각의 record는 그때그때 추가하도록 한다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_route53_zone"</span> <span class="s2">"keencho"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"keencho.com"</span>

  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">prevent_destroy</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"app-keencho-route53"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_route53_record"</span> <span class="s2">"app-certificate-validation"</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">dvo</span> <span class="nx">in</span> <span class="nx">aws_acm_certificate</span><span class="p">.</span><span class="nx">ssl-certificate</span><span class="p">.</span><span class="nx">domain_validation_options</span> <span class="o">:</span> <span class="nx">dvo</span><span class="p">.</span><span class="nx">domain_name</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">name</span>   <span class="o">=</span> <span class="nx">dvo</span><span class="p">.</span><span class="nx">resource_record_name</span>
      <span class="nx">record</span> <span class="o">=</span> <span class="nx">dvo</span><span class="p">.</span><span class="nx">resource_record_value</span>
      <span class="nx">type</span>   <span class="o">=</span> <span class="nx">dvo</span><span class="p">.</span><span class="nx">resource_record_type</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">allow_overwrite</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">name</span>            <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">records</span>         <span class="o">=</span> <span class="p">[</span><span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">record</span><span class="p">]</span>
  <span class="nx">ttl</span>             <span class="o">=</span> <span class="mi">60</span>
  <span class="nx">type</span>            <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">type</span>
  <span class="nx">zone_id</span>         <span class="o">=</span> <span class="nx">aws_route53_zone</span><span class="p">.</span><span class="nx">keencho</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_acm_certificate"</span> <span class="s2">"ssl-certificate"</span> <span class="p">{</span>
  <span class="nx">domain_name</span>       <span class="o">=</span> <span class="s2">"*.keencho.com"</span>
  <span class="nx">validation_method</span> <span class="o">=</span> <span class="s2">"DNS"</span>

  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">create_before_destroy</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_acm_certificate_validation"</span> <span class="s2">"ssl-certificate-validation"</span> <span class="p">{</span>
  <span class="nx">certificate_arn</span>         <span class="o">=</span> <span class="nx">aws_acm_certificate</span><span class="p">.</span><span class="nx">ssl-certificate</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">validation_record_fqdns</span> <span class="o">=</span> <span class="p">[</span><span class="nx">for</span> <span class="nx">record</span> <span class="nx">in</span> <span class="nx">aws_route53_record</span><span class="p">.</span><span class="nx">app-certificate-validation</span> <span class="o">:</span> <span class="nx">record</span><span class="p">.</span><span class="nx">fqdn</span><span class="p">]</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>AWS Certificate Manager에 SSL 인증서를 추가하고 Route 53 CNAME 레코드를 통해 손쉽게 검증할 수 있다.</p>
<p>주의할 점이 있다. 현 시점 생성된 SSL 인증서는 서울 리전 (ap-northeast-2)에 존재한다. 추후 CloudFront 생성시에는 버지니아 북부 (us-east-1) 에 존재하는 SSL 인증서만 사용할 수 있다. 따라서 us-ease-1 리전에도 인증서를 추가해 주도록 하겠다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
<td class="rouge-code"><pre><span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">alias</span>  <span class="o">=</span> <span class="s2">"us-east-1"</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="s2">"us-east-1"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_acm_certificate"</span> <span class="s2">"ssl-certificate-virginia"</span> <span class="p">{</span>
  <span class="nx">domain_name</span>       <span class="o">=</span> <span class="s2">"*.keencho.com"</span>
  <span class="nx">validation_method</span> <span class="o">=</span> <span class="s2">"DNS"</span>
  <span class="nx">provider</span> <span class="o">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">us-east-1</span>

  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">create_before_destroy</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>어떤 로직이 숨겨져 있는지 모르겠지만 위 인증서도 앞서 진행한 <code class="language-plaintext highlighter-rouge">ssl-certificate-validation</code> 검증을 통해 검증받을 수 있다. (별도의 검증 리소스 블락이 필요하지 않음.) 따라서 생성후 조금만 기다리면 상태가 변경됨을 확인할 수 있다.</p>
<p>만약 도메인을 외부 도메인 업체 (가비아, 후이즈 등) 에서 구매하였다면 해당 업체 관리화면으로 이동해 네임서버를 AWS가 생성한 네임서버로 변경하도록 하자. 변경하지 않으면 무용지물이다.</p>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="/categories/aws/">AWS</a>, <a href="/categories/terraform/">Terraform</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration">AWS</a> <a href="/tags/ecs/" class="post-tag no-text-decoration">ECS</a>
</div>
<div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div>
<div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Terraform%EC%9C%BC%EB%A1%9C+AWS+%EB%AC%B4%EC%A4%91%EB%8B%A8+%EB%B0%B0%ED%8F%AC+%EC%9D%B8%ED%94%84%EB%9D%BC+%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0+-+3.+%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC+-+keencho%27s+blog&amp;url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fterraform-aws-infra-3%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Terraform%EC%9C%BC%EB%A1%9C+AWS+%EB%AC%B4%EC%A4%91%EB%8B%A8+%EB%B0%B0%ED%8F%AC+%EC%9D%B8%ED%94%84%EB%9D%BC+%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0+-+3.+%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC+-+keencho%27s+blog&amp;u=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fterraform-aws-infra-3%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fterraform-aws-infra-3%2F&amp;text=Terraform%EC%9C%BC%EB%A1%9C+AWS+%EB%AC%B4%EC%A4%91%EB%8B%A8+%EB%B0%B0%ED%8F%AC+%EC%9D%B8%ED%94%84%EB%9D%BC+%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0+-+3.+%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC+-+keencho%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span>
</div>
</div>
</div>
</div></div>
<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">
<div class="access">
<div id="access-lastmod" class="post">
<div class="panel-heading">Recently Updated</div>
<ul class="post-content pl-0 pb-1 ml-1 mt-2">
<li><a href="/posts/jpa-flush/">JPA &amp; Hibernate Flush Mode</a></li>
<li><a href="/posts/aws-cicd-1/">AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 1. 개요</a></li>
<li><a href="/posts/terraform-aws-infra-6/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)</a></li>
<li><a href="/posts/aapt2-arm/">Arm 아키텍처에서 AAPT2 빌드 도구 사용하기</a></li>
<li><a href="/posts/terraform-aws-infra-1/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 1. 개요</a></li>
</ul>
</div>
<div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5">
<div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
<nav id="toc" data-toggle="toc"></nav>
</div>
</div>
</div>
<div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4">
<div id="related-posts" class="mt-5 mb-2 mb-sm-4">
<h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
<div class="card-deck mb-4">
<div class="card"> <a href="/posts/terraform-aws-infra-4/"><div class="card-body"> <em class="small" data-ts="1708729920" data-df="ll"> Feb 24, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 4. 테스트 환경</h3>
<div class="text-muted small"><p> Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리 Terraform으로 AWS ECS 무중단 배포 인프라 구성하기 - 4. 테스트 환경 이번 포스팅에서는 테스트 환경을 구성한다. 테스트 환경은 운영환경과는 다르게 백엔드, 프론트엔드, d...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/terraform-aws-infra-5/"><div class="card-body"> <em class="small" data-ts="1712963520" data-df="ll"> Apr 13, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 5. 운영환경 (프론트)</h3>
<div class="text-muted small"><p> Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리 Terraform으로 AWS ECS 무중단 배포 인프라 구성하기 - 5. 운영환경 (프론트) 프론트 운영환경을 구축한다. 리소스 1. S3 버킷 먼저 S3 버킷을 생성한다. 1 2 3...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/terraform-aws-infra-6/"><div class="card-body"> <em class="small" data-ts="1715987520" data-df="ll"> May 18, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)</h3>
<div class="text-muted small"><p> Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리 Terraform으로 AWS ECS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드) 백엔드 운영환경을 구축한다. 리소스 1. RDS RDS를 생성한다. 1 2 3 4 5 6 ...</p></div>
</div></a>
</div>
</div>
</div>
<div class="post-navigation d-flex justify-content-between"> <a href="/posts/terraform-aws-infra-2/" class="btn btn-outline-primary" prompt="Older"><p>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 2. 기초</p></a> <a href="/posts/terraform-aws-infra-4/" class="btn btn-outline-primary" prompt="Newer"><p>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 4. 테스트 환경</p></a>
</div>
</div></div>
<footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0">
<div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/keencho">keencho</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div>
<div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div>
</div></footer>
</div>
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content">
<div id="search-hints"><div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a>
</div>
</div></div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false">
<div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">×</span> </button>
</div>
<div class="toast-body text-center pt-0">
<p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
<button type="button" class="btn btn-primary" aria-label="Update"> Update </button>
</div>
</div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
