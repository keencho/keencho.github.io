<!DOCTYPE html><html lang="ko-KS" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)" /><meta name="author" content="keencho" /><meta property="og:locale" content="ko_KS" /><meta name="description" content="Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리" /><meta property="og:description" content="Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리" /><link rel="canonical" href="https://keencho.github.io/posts/terraform-aws-infra-6/" /><meta property="og:url" content="https://keencho.github.io/posts/terraform-aws-infra-6/" /><meta property="og:site_name" content="keencho’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-05-18T08:12:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@keencho" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"keencho"},"dateModified":"2025-03-17T17:33:20+09:00","datePublished":"2024-05-18T08:12:00+09:00","description":"Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리","headline":"Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)","mainEntityOfPage":{"@type":"WebPage","@id":"https://keencho.github.io/posts/terraform-aws-infra-6/"},"url":"https://keencho.github.io/posts/terraform-aws-infra-6/"}</script><title>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드) | keencho's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="keencho's blog"><meta name="application-name" content="keencho's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end">
<div class="profile-wrapper text-center">
<div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/custom/keencho.jpg" alt="avatar" onerror="this.style.display='none'"> </a>
</div>
<div class="site-title mt-3"> <a href="/">keencho's blog</a>
</div>
<div class="site-subtitle font-italic">이것저것 정리하는 블로그.</div>
</div>
<ul class="w-100">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a>
</li>
<li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a>
</li>
</ul>
<div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/keencho" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20['seyoung050412','gmail.com'].join('@')" aria-label="email"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> </a>
</div>
</div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div>
<i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel">Cancel</span>
</div></div><div id="main-wrapper" class="d-flex justify-content-center">
<div id="main" class="container pl-xl-4 pr-xl-4">
<div class="row">
<div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2">
<h1 data-toc-skip>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)</h1>
<div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1715987520" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 18, 2024 </em> </span><div class="d-flex justify-content-between"> <span> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4135 words"> <em>22 min</em> read</span>
</div>
</div>
</div>
<div class="post-content">
<h1 id="terraform으로-aws-무중단-배포-인프라-구성하기"><strong>Terraform으로 AWS 무중단 배포 인프라 구성하기</strong></h1>
<ol>
<li><a href="/posts/terraform-aws-infra-1">개요</a></li>
<li><a href="/posts/terraform-aws-infra-2">기초</a></li>
<li><a href="/posts/terraform-aws-infra-3">네트워크</a></li>
<li><a href="/posts/terraform-aws-infra-4">테스트 환경</a></li>
<li><a href="/posts/terraform-aws-infra-5">운영환경 (프론트)</a></li>
<li><strong>운영환경 (백엔드)</strong></li>
<li><a href="/posts/terraform-aws-infra-7">마무리</a></li>
</ol>
<h1 id="terraform으로-aws-ecs-무중단-배포-인프라-구성하기---6-운영환경-백엔드"><strong>Terraform으로 AWS ECS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)</strong></h1>
<p>백엔드 운영환경을 구축한다.</p>
<h2 id="리소스">
<span class="mr-2"><strong>리소스</strong></span><a href="#%EB%A6%AC%EC%86%8C%EC%8A%A4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<h3 id="1-rds">
<span class="mr-2"><strong>1. RDS</strong></span><a href="#1-rds" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>RDS를 생성한다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_security_group"</span> <span class="s2">"app-rds-sg"</span> <span class="p">{</span>

  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"app-rds-sg"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"security group for rds"</span>
  <span class="nx">vpc_id</span>      <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">description</span> <span class="o">=</span> <span class="s2">"postgresSQL"</span>
    <span class="nx">from_port</span>   <span class="o">=</span> <span class="mi">5432</span>
    <span class="nx">to_port</span>     <span class="o">=</span> <span class="mi">5432</span>
    <span class="nx">protocol</span>    <span class="o">=</span> <span class="s2">"tcp"</span>
    <span class="nx">cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">egress</span> <span class="p">{</span>
    <span class="nx">from_port</span>   <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">to_port</span>     <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">protocol</span>    <span class="o">=</span> <span class="s2">"-1"</span>
    <span class="nx">cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"app-rds-sg"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_db_subnet_group"</span> <span class="s2">"app-rds-subnet-group"</span> <span class="p">{</span>
  <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"app-rds-subnet-group"</span>
  <span class="nx">subnet_ids</span> <span class="o">=</span> <span class="nx">aws_subnet</span><span class="p">.</span><span class="nx">public</span><span class="p">[*].</span><span class="nx">id</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"app-rds-subnet-group"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_db_instance"</span> <span class="s2">"app-rds"</span> <span class="p">{</span>
  <span class="nx">db_name</span>              <span class="o">=</span> <span class="s2">"app"</span>
  <span class="nx">identifier</span>           <span class="o">=</span> <span class="s2">"app-rds"</span>
  <span class="nx">engine</span>               <span class="o">=</span> <span class="s2">"postgres"</span>
  <span class="nx">engine_version</span>       <span class="o">=</span> <span class="s2">"15.8"</span>
  <span class="nx">storage_type</span>         <span class="o">=</span> <span class="s2">"gp2"</span>
  <span class="nx">allocated_storage</span>    <span class="o">=</span> <span class="mi">20</span>
  <span class="nx">instance_class</span>       <span class="o">=</span> <span class="s2">"db.t3.micro"</span>
  <span class="nx">username</span>             <span class="o">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">db-username</span> <span class="c1"># secret</span>
  <span class="nx">password</span>             <span class="o">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">db-password</span> <span class="c1"># secret</span>
  <span class="nx">parameter_group_name</span> <span class="o">=</span> <span class="s2">"default.postgres15"</span>
  <span class="nx">skip_final_snapshot</span>  <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">publicly_accessible</span>  <span class="o">=</span> <span class="kc">true</span>

  <span class="nx">vpc_security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">app-rds-sg</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="nx">db_subnet_group_name</span> <span class="o">=</span> <span class="nx">aws_db_subnet_group</span><span class="err">.</span><span class="nx">app-rds-subnet-group</span><span class="p">.</span><span class="nx">name</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>rds가 생성되었다면 db 접속하여 유저, database 등 앱에 필요한 리소스들을 설정한다.</p>
<blockquote><p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> 편의상 publicly_accessible, subnet group, security group을 퍼블릭으로 설정했다. 당연히 특정 bastion 어플리케이션환경 혹은 bastion host 에서만 접근 가능하게 해야한다.</p></blockquote>
<h3 id="2-efs">
<span class="mr-2"><strong>2. EFS</strong></span><a href="#2-efs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>로그를 저장할 EFS 저장소를 생성한다. 2049 포트를 열어야 하며 네트워크상 프라이빗 서브넷에 위치하도록 하였다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_security_group"</span> <span class="s2">"app-efs-sg"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"app-efs-sg"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"security group for ecs service"</span>
  <span class="nx">vpc_id</span>      <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">description</span> <span class="o">=</span> <span class="s2">"allow 2049"</span>
    <span class="nx">from_port</span>   <span class="o">=</span> <span class="mi">2049</span>
    <span class="nx">to_port</span>     <span class="o">=</span> <span class="mi">2049</span>
    <span class="nx">protocol</span>    <span class="o">=</span> <span class="s2">"tcp"</span>
    <span class="nx">cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">egress</span> <span class="p">{</span>
    <span class="nx">from_port</span>   <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">to_port</span>     <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">protocol</span>    <span class="o">=</span> <span class="s2">"-1"</span>
    <span class="nx">cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"app-efs-sg"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_efs_file_system"</span> <span class="s2">"app-efs"</span> <span class="p">{</span>
  <span class="nx">encrypted</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">performance_mode</span> <span class="o">=</span> <span class="s2">"generalPurpose"</span>
  <span class="nx">throughput_mode</span> <span class="o">=</span> <span class="s2">"bursting"</span>

  <span class="nx">lifecycle_policy</span> <span class="p">{</span>
    <span class="nx">transition_to_ia</span> <span class="o">=</span> <span class="s2">"AFTER_90_DAYS"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_efs_mount_target"</span> <span class="s2">"app-efs-target"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="s2">"${length(aws_subnet.private.*.id)}"</span>
  <span class="nx">file_system_id</span>  <span class="o">=</span> <span class="s2">"${aws_efs_file_system.app-efs.id}"</span>
  <span class="nx">subnet_id</span> <span class="o">=</span> <span class="s2">"${element(aws_subnet.private.*.id, count.index)}"</span>
  <span class="nx">security_groups</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"${aws_security_group.app-efs-sg.id}"</span><span class="p">]</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<h3 id="3-ecs">
<span class="mr-2"><strong>3. ECS</strong></span><a href="#3-ecs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>ECS와 관련된 리소스들을 설정한다.</p>
<h4 id="1-ecr">
<span class="mr-2"><strong>1. ECR</strong></span><a href="#1-ecr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h4>
<p>ECR을 생성한다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_ecr_repository"</span> <span class="s2">"app-ecr"</span> <span class="p">{</span>
  <span class="nx">name</span>                 <span class="o">=</span> <span class="s2">"app-ecr"</span>
  <span class="nx">image_tag_mutability</span> <span class="o">=</span> <span class="s2">"MUTABLE"</span>

  <span class="nx">image_scanning_configuration</span> <span class="p">{</span>
    <span class="nx">scan_on_push</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>원할한 테스트를 위해 이 단계에서 ECR 리포지토리에 이미지를 푸쉬해두자. 나의 경우 <code class="language-plaintext highlighter-rouge">nginx-latet</code>, <code class="language-plaintext highlighter-rouge">admin-latest</code>, <code class="language-plaintext highlighter-rouge">user-latest</code> 3개의 이미지를 푸쉬해 두었다.</p>
<h4 id="2-task-definition">
<span class="mr-2"><strong>2. Task Definition</strong></span><a href="#2-task-definition" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h4>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"app-ecs-task-execution-role"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"ecsTaskExecutionRole"</span>

  <span class="nx">assume_role_policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span><span class="p">,</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"sts:AssumeRole"</span><span class="p">,</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span><span class="p">,</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Service</span> <span class="o">=</span> <span class="s2">"ecs-tasks.amazonaws.com"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role_policy_attachment"</span> <span class="s2">"app-ecs-task-execution-role-policy-attachment"</span> <span class="p">{</span>
  <span class="nx">role</span>       <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">app-ecs-task-execution-role</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">policy_arn</span> <span class="o">=</span> <span class="s2">"arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>태스크를 정의하기전 필요한 리소스들이다. <code class="language-plaintext highlighter-rouge">AmazonECSTaskExecutionRolePolicy</code> 정책이 필요하기 떄문에 <code class="language-plaintext highlighter-rouge">app-ecs-task-execution-role</code>를 정의하여 붙여 두었다.</p>
<p>태스크 정의 설명전 잠시 서버 구성에 대해 이야기 하자면, 내가 구상한 구성은 각 <code class="language-plaintext highlighter-rouge">SpringBoot</code> 어플리케이션이 독립적인 컨테이너 형태로 존재하는것이 아닌 한 태스크 안에 <code class="language-plaintext highlighter-rouge">nginx</code>, <code class="language-plaintext highlighter-rouge">admin</code>, <code class="language-plaintext highlighter-rouge">user</code> 컨테이너가 존재하는 형태이다.</p>
<p>트래픽 흐름으로 설명하자면 <code class="language-plaintext highlighter-rouge">사용자 -&gt; CloudFront -&gt; ALB -&gt; (태스크) -&gt; Admin or User</code> (N개의 앱, N개의 ECS 서비스) 가 아닌 <code class="language-plaintext highlighter-rouge">사용자 -&gt; CloudFront -&gt; ALB -&gt; (태스크) -&gt; Nginx -&gt; Admin or User</code> (N개의 앱, 1개의 ECS 서비스) 형태가 되는 것이다. 다른 시스템에는 (예를들어 회사에서 운영중인 서비스 등.) 독립적인 컨테이너 형태로 존재하는것이 더욱 안전하다고 생각한다.</p>
<p>물론 그에따른 리소스 비용 증가나 관리의 복잡성이 따라올 수 있으니 각 서비스별로 적당하게 서버 구성을 하면 될 것 같다. 일단 이 포스팅에선 <code class="language-plaintext highlighter-rouge">사용자 -&gt; CloudFront -&gt; ALB -&gt; (태스크) -&gt; Nginx -&gt; Admin or User</code> 형태로 태스크를 정의한다.</p>
<div class="language-conf highlighter-rouge">
<div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td>
<td class="rouge-code"><pre><span class="n">user</span>  <span class="n">nginx</span>;
<span class="n">worker_processes</span> <span class="n">auto</span>;

<span class="n">events</span> {
    <span class="n">worker_connections</span> <span class="m">1024</span>;
}

<span class="n">http</span> {
    <span class="n">sendfile</span> <span class="n">on</span>;
    <span class="n">tcp_nopush</span> <span class="n">on</span>;
    <span class="n">tcp_nodelay</span> <span class="n">on</span>;
    <span class="n">keepalive_timeout</span> <span class="m">65</span>;
    <span class="n">types_hash_max_size</span> <span class="m">4096</span>;

    <span class="n">include</span> /<span class="n">etc</span>/<span class="n">nginx</span>/<span class="n">mime</span>.<span class="n">types</span>;
    <span class="n">default_type</span> <span class="n">application</span>/<span class="n">octet</span>-<span class="n">stream</span>;

    <span class="n">server</span> {
            <span class="n">listen</span> <span class="m">80</span>;
            <span class="n">server_name</span> <span class="n">app</span>-<span class="n">admin</span>.<span class="n">keencho</span>.<span class="n">com</span>
            <span class="n">client_max_body_size</span>    <span class="m">1</span><span class="n">G</span>;
            <span class="n">access_log</span> <span class="n">off</span>;

            <span class="n">location</span> /<span class="n">health</span>-<span class="n">check</span> {
                <span class="n">return</span> <span class="m">200</span>;
            }

            <span class="n">location</span> /<span class="n">api</span>/ {
                    <span class="n">proxy_redirect</span> <span class="n">off</span>;
                    <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Real</span>-<span class="n">IP</span> $<span class="n">remote_addr</span>;
                    <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Forwarded</span>-<span class="n">For</span> $<span class="n">proxy_add_x_forwarded_for</span>;
                    <span class="n">proxy_set_header</span>        <span class="n">Host</span> $<span class="n">http_host</span>;
                    <span class="n">proxy_connect_timeout</span> <span class="m">600</span>;
                    <span class="n">proxy_send_timeout</span> <span class="m">600</span>;
                    <span class="n">proxy_read_timeout</span> <span class="m">600</span>;
                    <span class="n">send_timeout</span> <span class="m">600</span>;
                    <span class="n">proxy_headers_hash_max_size</span> <span class="m">512</span>;
                    <span class="n">proxy_headers_hash_bucket_size</span> <span class="m">128</span>;

                    <span class="n">proxy_pass</span> <span class="n">http</span>://<span class="m">127</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">1</span>:<span class="m">10000</span>/<span class="n">api</span>/;
            }
    }

    <span class="n">server</span> {
            <span class="n">listen</span> <span class="m">80</span>;
            <span class="n">server_name</span> <span class="n">app</span>-<span class="n">user</span>.<span class="n">keencho</span>.<span class="n">com</span>
            <span class="n">client_max_body_size</span>    <span class="m">1</span><span class="n">G</span>;
            <span class="n">access_log</span> <span class="n">off</span>;

            <span class="n">location</span> /<span class="n">api</span>/ {
                    <span class="n">proxy_redirect</span> <span class="n">off</span>;
                    <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Real</span>-<span class="n">IP</span> $<span class="n">remote_addr</span>;
                    <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Forwarded</span>-<span class="n">For</span> $<span class="n">proxy_add_x_forwarded_for</span>;
                    <span class="n">proxy_set_header</span>        <span class="n">Host</span> $<span class="n">http_host</span>;
                    <span class="n">proxy_connect_timeout</span> <span class="m">600</span>;
                    <span class="n">proxy_send_timeout</span> <span class="m">600</span>;
                    <span class="n">proxy_read_timeout</span> <span class="m">600</span>;
                    <span class="n">send_timeout</span> <span class="m">600</span>;
                    <span class="n">proxy_headers_hash_max_size</span> <span class="m">512</span>;
                    <span class="n">proxy_headers_hash_bucket_size</span> <span class="m">128</span>;

                    <span class="n">proxy_pass</span> <span class="n">http</span>://<span class="m">127</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">1</span>:<span class="m">10010</span>/<span class="n">api</span>/;
            }
    }

}
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>위와같은 nginx 설정파일을 사용한다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
</pre></td>
<td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"nginx-container-name"</span> <span class="p">{</span>
  <span class="nx">default</span> <span class="o">=</span> <span class="s2">"nginx"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_ecs_task_definition"</span> <span class="s2">"app-definition"</span> <span class="p">{</span>
  <span class="nx">family</span> <span class="o">=</span> <span class="s2">"app-definition"</span>
  <span class="nx">requires_compatibilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"FARGATE"</span><span class="p">]</span>
  <span class="nx">cpu</span> <span class="o">=</span> <span class="mi">1024</span>
  <span class="nx">memory</span> <span class="o">=</span> <span class="s2">"2048"</span>
  <span class="nx">network_mode</span> <span class="o">=</span> <span class="s2">"awsvpc"</span>

  <span class="nx">task_role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="err">.</span><span class="nx">app-ecs-task-execution-role</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">execution_role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">app-ecs-task-execution-role</span><span class="p">.</span><span class="nx">arn</span>

  <span class="nx">runtime_platform</span> <span class="p">{</span>
    <span class="nx">operating_system_family</span> <span class="o">=</span> <span class="s2">"LINUX"</span>
    <span class="nx">cpu_architecture</span> <span class="o">=</span> <span class="s2">"ARM64"</span>
  <span class="p">}</span>

  <span class="nx">container_definitions</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">([</span>
    <span class="p">{</span>
      <span class="nx">name</span>      <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">nginx-container-name</span>
      <span class="nx">image</span>     <span class="o">=</span> <span class="s2">"${aws_ecr_repository.app-ecr.repository_url}:nginx-latest"</span>
      <span class="nx">essential</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">portMappings</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">containerPort</span> <span class="o">=</span> <span class="mi">80</span>
          <span class="nx">hostPort</span>      <span class="o">=</span> <span class="mi">80</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nx">healthCheck</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"CMD-SHELL"</span><span class="p">,</span> <span class="s2">"curl -f http://localhost:80/health-check || exit 1"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"admin"</span>
      <span class="nx">image</span>     <span class="o">=</span> <span class="s2">"${aws_ecr_repository.app-ecr.repository_url}:admin-latest"</span>
      <span class="nx">essential</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">portMappings</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">containerPort</span> <span class="o">=</span> <span class="mi">10000</span>
          <span class="nx">hostPort</span>      <span class="o">=</span> <span class="mi">10000</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nx">environment</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"spring.profiles.active"</span><span class="p">,</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="s2">"prod"</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"logging.file.name"</span><span class="p">,</span>
          <span class="s2">"value"</span><span class="o">:</span> <span class="s2">"/app-efs/logs/prod/admin/$(curl -s $ECS_CONTAINER_METADATA_URI_V4/task | jq -r .TaskARN | cut -d '/' -f 3).log"</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"server.port"</span><span class="p">,</span>
          <span class="s2">"value"</span><span class="o">:</span> <span class="s2">"10000"</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"db_url"</span><span class="p">,</span>
          <span class="s2">"value"</span><span class="o">:</span> <span class="s2">"jdbc:postgresql://${aws_db_instance.app-rds.endpoint}/${aws_db_instance.app-rds.db_name}"</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"db_username"</span><span class="p">,</span>
          <span class="s2">"value"</span><span class="o">:</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db-username</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"db_password"</span><span class="p">,</span>
          <span class="s2">"value"</span><span class="o">:</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db-password</span>
        <span class="p">},</span>
      <span class="p">],</span>
      <span class="nx">mountPoints</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">sourceVolume</span><span class="o">:</span> <span class="s2">"app-efs"</span><span class="p">,</span>
          <span class="nx">containerPath</span><span class="o">:</span> <span class="s2">"/app-efs"</span><span class="p">,</span>
          <span class="nx">readOnly</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nx">healthCheck</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"CMD-SHELL"</span><span class="p">,</span> <span class="s2">"curl -f http://localhost:10000/api/health-check || exit 1"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"user"</span>
      <span class="nx">image</span>     <span class="o">=</span> <span class="s2">"${aws_ecr_repository.app-ecr.repository_url}:user-latest"</span>
      <span class="nx">essential</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">portMappings</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">containerPort</span> <span class="o">=</span> <span class="mi">10010</span>
          <span class="nx">hostPort</span>      <span class="o">=</span> <span class="mi">10010</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nx">environment</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"spring.profiles.active"</span><span class="p">,</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="s2">"prod"</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"logging.file.name"</span><span class="p">,</span>
          <span class="s2">"value"</span><span class="o">:</span> <span class="s2">"/app-efs/logs/prod/user/$(curl -s $ECS_CONTAINER_METADATA_URI_V4/task | jq -r .TaskARN | cut -d '/' -f 3).log"</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"server.port"</span><span class="p">,</span>
          <span class="s2">"value"</span><span class="o">:</span> <span class="s2">"10010"</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"db_url"</span><span class="p">,</span>
          <span class="s2">"value"</span><span class="o">:</span> <span class="s2">"jdbc:postgresql://${aws_db_instance.app-rds.endpoint}/${aws_db_instance.app-rds.db_name}"</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"db_username"</span><span class="p">,</span>
          <span class="s2">"value"</span><span class="o">:</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db-username</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"db_password"</span><span class="p">,</span>
          <span class="s2">"value"</span><span class="o">:</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db-password</span>
        <span class="p">},</span>
      <span class="p">],</span>
      <span class="nx">mountPoints</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">sourceVolume</span><span class="o">:</span> <span class="s2">"app-efs"</span><span class="p">,</span>
          <span class="nx">containerPath</span><span class="o">:</span> <span class="s2">"/app-efs"</span><span class="p">,</span>
          <span class="nx">readOnly</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nx">healthCheck</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"CMD-SHELL"</span><span class="p">,</span> <span class="s2">"curl -f http://localhost:10010/api/health-check || exit 1"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">])</span>

  <span class="nx">volume</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"app-efs"</span>

    <span class="nx">efs_volume_configuration</span> <span class="p">{</span>
      <span class="nx">file_system_id</span> <span class="o">=</span> <span class="nx">aws_efs_file_system</span><span class="p">.</span><span class="nx">app-efs</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">root_directory</span> <span class="o">=</span> <span class="s2">"/"</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">ignore_changes</span> <span class="o">=</span> <span class="p">[</span><span class="nx">container_definitions</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<ul>
<li>시작유형: Fargate</li>
<li>OS, 아키텍처: Linux/ARM64</li>
<li>CPU: 2vCPU</li>
<li>메모리: 2 GB</li>
<li>볼륨: 앞에서 생성한 EFS 유형의 스토리지를 마운트, 루트 디렉토리는 <code class="language-plaintext highlighter-rouge">/</code>
</li>
<li>컨테이너 정의<ol>
<li>nginx<ul>
<li>포트: 80</li>
<li>상태확인: /health-check</li>
</ul>
</li>
<li>admin / user<ul>
<li>포트: 10000 / 10010</li>
<li>상태확인: /api/health-check</li>
<li>EFS 볼륨 마운트</li>
<li>환경변수<ul>
<li>SpringBoot 프로필</li>
<li>로깅파일 경로 지정: EFS 경로 + … + 현재 컨테이너가 속한 태스크의 전체 Amazon 리소스 이름 (ARN)</li>
<li>db 설정값들 (여기서는 그냥 rds의 endpoint와 db_name을 끌어다 썼다. 실제 운영환경 이라면 S3에 환경 파일을 저장해두고 사용하는게 안전할것 같다.)</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<blockquote><p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> ignore_changes 에 container_definitions 를 추가한다. 아무 수정 없어도 항상 terraform이 ‘force replacement’ 를 시도하기 때문이다. 아마 ‘container_definitions’가 JSON 형식으로 정의되기 때문에 필드 순서나 미세한 차이로 인해 변경이 감지될 수 있어서 그런것 같다.</p></blockquote>
<h4 id="2-cluster--service">
<span class="mr-2"><strong>2. Cluster &amp; Service</strong></span><a href="#2-cluster--service" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h4>
<p>클러스터를 생성한다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_ecs_cluster"</span> <span class="s2">"app-cluster"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"app-cluster"</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>서비스 생성전 로드밸런서와 연결할 타겟 그룹을 정의한다. 추후 CodeDeploy로 Blue / Green 배포를 진행할 것이므로 타겟 그룹을 2개 정의한다. 로드 밸런서에는 1번 대상그룹만 연결한다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_lb_target_group"</span> <span class="s2">"app-ecs-service-tg1"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"app-ecs-service-tg1"</span>

  <span class="nx">port</span> <span class="o">=</span> <span class="mi">80</span>
  <span class="nx">protocol</span> <span class="o">=</span> <span class="s2">"HTTP"</span>
  <span class="nx">target_type</span> <span class="o">=</span> <span class="s2">"ip"</span>
  <span class="nx">vpc_id</span> <span class="o">=</span> <span class="nx">aws_vpc</span><span class="err">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">health_check</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">alb-health-check-path</span>
    <span class="nx">port</span> <span class="o">=</span> <span class="s2">"traffic-port"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_lb_target_group"</span> <span class="s2">"app-ecs-service-tg2"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"app-ecs-service-tg2"</span>

  <span class="nx">port</span> <span class="o">=</span> <span class="mi">80</span>
  <span class="nx">protocol</span> <span class="o">=</span> <span class="s2">"HTTP"</span>
  <span class="nx">target_type</span> <span class="o">=</span> <span class="s2">"ip"</span>
  <span class="nx">vpc_id</span> <span class="o">=</span> <span class="nx">aws_vpc</span><span class="err">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">health_check</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">alb-health-check-path</span>
    <span class="nx">port</span> <span class="o">=</span> <span class="s2">"traffic-port"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_lb_listener_rule"</span> <span class="s2">"app-alb-ecs-service-rule"</span> <span class="p">{</span>
  <span class="nx">listener_arn</span> <span class="o">=</span> <span class="nx">aws_lb_listener</span><span class="p">.</span><span class="nx">app-alb-listener-https</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">priority</span> <span class="o">=</span> <span class="mi">2</span>

  <span class="nx">action</span> <span class="p">{</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"forward"</span>
    <span class="nx">target_group_arn</span> <span class="o">=</span> <span class="nx">aws_lb_target_group</span><span class="p">.</span><span class="nx">app-ecs-service-tg1</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">}</span>

  <span class="nx">condition</span> <span class="p">{</span>
    <span class="nx">host_header</span> <span class="p">{</span>
      <span class="nx">values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"app-admin.keencho.com"</span><span class="p">,</span> <span class="s2">"app-user.keencho.com"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>다음으로는 서비스를 정의한다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_security_group"</span> <span class="s2">"app-ecs-service-sg"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"app-ecs-service-sg"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"security group for ecs service"</span>
  <span class="nx">vpc_id</span>      <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">description</span> <span class="o">=</span> <span class="s2">"alb traffic"</span>
    <span class="nx">from_port</span>   <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">to_port</span>     <span class="o">=</span> <span class="mi">65535</span>
    <span class="nx">protocol</span>    <span class="o">=</span> <span class="s2">"tcp"</span>
    <span class="nx">security_groups</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">app-alb-sg</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">egress</span> <span class="p">{</span>
    <span class="nx">from_port</span>   <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">to_port</span>     <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">protocol</span>    <span class="o">=</span> <span class="s2">"-1"</span>
    <span class="nx">cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"app-ecs-service-sg"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_ecs_service"</span> <span class="s2">"app-ecs-service"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"app-ecs-service"</span>
  <span class="nx">cluster</span> <span class="o">=</span> <span class="nx">aws_ecs_cluster</span><span class="p">.</span><span class="nx">app-cluster</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">task_definition</span> <span class="o">=</span> <span class="nx">aws_ecs_task_definition</span><span class="p">.</span><span class="nx">app-definition</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">desired_count</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="nx">launch_type</span> <span class="o">=</span> <span class="s2">"FARGATE"</span>
  <span class="nx">propagate_tags</span> <span class="o">=</span> <span class="s2">"SERVICE"</span>
  <span class="nx">health_check_grace_period_seconds</span> <span class="o">=</span> <span class="mi">60</span>

  <span class="nx">network_configuration</span> <span class="p">{</span>
    <span class="nx">subnets</span> <span class="o">=</span> <span class="nx">aws_subnet</span><span class="p">.</span><span class="nx">private</span><span class="p">[*].</span><span class="nx">id</span>
    <span class="nx">security_groups</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">app-ecs-service-sg</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
    <span class="nx">assign_public_ip</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>

  <span class="nx">deployment_controller</span> <span class="p">{</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"CODE_DEPLOY"</span>
  <span class="p">}</span>

  <span class="nx">load_balancer</span> <span class="p">{</span>
    <span class="nx">target_group_arn</span> <span class="o">=</span> <span class="nx">aws_lb_target_group</span><span class="p">.</span><span class="nx">app-ecs-service-tg1</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">container_name</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">nginx-container-name</span>
    <span class="nx">container_port</span> <span class="o">=</span> <span class="mi">80</span>
  <span class="p">}</span>

  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">ignore_changes</span> <span class="o">=</span> <span class="p">[</span><span class="nx">desired_count</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<ul>
<li>시작유형: Fargate</li>
<li>태그전파: 서비스 기준</li>
<li>상태확인 유휴기간: 60초</li>
<li>배포 옵션: CodeDeploy</li>
<li>로드밸런서: 타겟그룹1에 등록, 80포트로 트래픽 라우팅</li>
<li>네트워크 구성: 프라이빗 서브넷에 존재, 로드밸런서 로부터 오는 트래픽만 허용, 나머지 금지</li>
</ul>
<p>여기까지 오면 서비스와 태스크가 생성된다. 콘솔에서 상태를 확인해보자.</p>
<blockquote><p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> 배포 옵션을 CodeDeploy로 지정했기 때문에 문제가 발생해도 서비스 업데이트를 할 수 없다. (현 시점에는 CodeDeploy와 연결되어 있지 않기 때문) 문제를 해결하려면 서비스를 지우고 다시 생성하는 수 밖에 없다.</p></blockquote>
<h4 id="3-autoscaling">
<span class="mr-2"><strong>3. AutoScaling</strong></span><a href="#3-autoscaling" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h4>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"app-ecs-autoscale"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"app-ecs-autoscale-iam-role"</span>

  <span class="nx">assume_role_policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span><span class="p">,</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Sid</span> <span class="o">=</span> <span class="s2">"Autoscaling"</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"sts:AssumeRole"</span><span class="p">,</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span><span class="p">,</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Service</span> <span class="o">=</span> <span class="s2">"application-autoscaling.amazonaws.com"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role_policy_attachment"</span> <span class="s2">"app-ecs-autoscale"</span> <span class="p">{</span>
  <span class="nx">role</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">app-ecs-autoscale</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">policy_arn</span> <span class="o">=</span> <span class="s2">"arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceAutoscaleRole"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_target"</span> <span class="s2">"app-ecs-target"</span> <span class="p">{</span>
  <span class="nx">min_capacity</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="nx">max_capacity</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="s2">"service/${aws_ecs_cluster.app-cluster.name}/${aws_ecs_service.app-ecs-service.name}"</span>
  <span class="nx">role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">app-ecs-task-execution-role</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="s2">"ecs:service:DesiredCount"</span>
  <span class="nx">service_namespace</span> <span class="o">=</span> <span class="s2">"ecs"</span>

  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">aws_ecs_service</span><span class="p">.</span><span class="nx">app-ecs-service</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_policy"</span> <span class="s2">"app-ecs-policy-scale-out"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"scale-out"</span>
  <span class="nx">policy_type</span> <span class="o">=</span> <span class="s2">"StepScaling"</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">app-ecs-target</span><span class="p">.</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">app-ecs-target</span><span class="p">.</span><span class="nx">scalable_dimension</span>
  <span class="nx">service_namespace</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">app-ecs-target</span><span class="p">.</span><span class="nx">service_namespace</span>

  <span class="nx">step_scaling_policy_configuration</span> <span class="p">{</span>
    <span class="nx">adjustment_type</span> <span class="o">=</span> <span class="s2">"PercentChangeInCapacity"</span>
    <span class="nx">cooldown</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nx">metric_aggregation_type</span> <span class="o">=</span> <span class="s2">"Average"</span>

    <span class="nx">step_adjustment</span> <span class="p">{</span>
      <span class="nx">metric_interval_lower_bound</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="nx">scaling_adjustment</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"app-ecs-cpu-high"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"app-ecs-cpu-high"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanOrEqualToThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"3"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"CPUUtilization"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/ECS"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"60"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Average"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"70"</span>

  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">ClusterName</span> <span class="o">=</span> <span class="nx">aws_ecs_cluster</span><span class="p">.</span><span class="nx">app-cluster</span><span class="p">.</span><span class="nx">name</span>
    <span class="nx">ServiceName</span> <span class="o">=</span> <span class="nx">aws_ecs_service</span><span class="p">.</span><span class="nx">app-ecs-service</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>

  <span class="nx">alarm_actions</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_appautoscaling_policy</span><span class="p">.</span><span class="nx">app-ecs-policy-scale-out</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
<span class="err">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>최소용량을 1, 최대용량을 4 로 지정하고 CPU에 따라 태스크를 <code class="language-plaintext highlighter-rouge">scale out</code> 하도록 구성하였다. 콘솔에서 확인해보자.</p>
<p><img data-src="/assets/img/custom/terraform-aws-infra/autoscaling.png" alt="autoscaling" data-proofer-ignore></p>
<h3 id="4-cloudfront-수정">
<span class="mr-2"><strong>4. CloudFront 수정</strong></span><a href="#4-cloudfront-%EC%88%98%EC%A0%95" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>앞서 운영환경 - 프론트를 구성할때 <code class="language-plaintext highlighter-rouge">CloudFront</code>로 들어오는 모든 트래픽은 S3로 전달되게 구성하였다. 맨 처음 개요에서 설명했듯 <code class="language-plaintext highlighter-rouge">/api/**</code> 경로로 시작하는 요청은 <code class="language-plaintext highlighter-rouge">Application Load Balancer</code>로 전달되도록 수정해야 한다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"admin-distribution"</span> <span class="p">{</span>
  <span class="nx">origin</span> <span class="p">{</span>
    <span class="nx">domain_name</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">app-prod-react</span><span class="p">.</span><span class="nx">bucket_regional_domain_name</span>
    <span class="nx">origin_id</span>   <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">app-prod-react</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">origin_access_control_id</span> <span class="o">=</span> <span class="nx">aws_cloudfront_origin_access_control</span><span class="p">.</span><span class="nx">admin-front</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">origin_path</span> <span class="o">=</span> <span class="s2">"/admin"</span>
  <span class="p">}</span>

  <span class="c1"># 추가</span>
  <span class="nx">origin</span> <span class="p">{</span>
    <span class="nx">domain_name</span> <span class="o">=</span> <span class="nx">aws_lb</span><span class="p">.</span><span class="nx">app-alb</span><span class="p">.</span><span class="nx">dns_name</span>
    <span class="nx">origin_id</span>   <span class="o">=</span> <span class="nx">aws_lb</span><span class="p">.</span><span class="nx">app-alb</span><span class="p">.</span><span class="nx">id</span>

    <span class="nx">custom_origin_config</span> <span class="p">{</span>
      <span class="nx">http_port</span>                <span class="o">=</span> <span class="mi">80</span>
      <span class="nx">https_port</span>               <span class="o">=</span> <span class="mi">443</span>
      <span class="nx">origin_protocol_policy</span>   <span class="o">=</span> <span class="s2">"https-only"</span>
      <span class="nx">origin_ssl_protocols</span>     <span class="o">=</span> <span class="p">[</span><span class="s2">"TLSv1.2"</span><span class="p">]</span>
      <span class="nx">origin_keepalive_timeout</span> <span class="o">=</span> <span class="mi">5</span>
      <span class="nx">origin_read_timeout</span>      <span class="o">=</span> <span class="mi">30</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">default_root_object</span> <span class="o">=</span> <span class="s2">"index.html"</span>
  <span class="nx">comment</span> <span class="o">=</span> <span class="s2">"admin distribution"</span>

  <span class="nx">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"app-admin.keencho.com"</span><span class="p">]</span>

  <span class="nx">default_cache_behavior</span> <span class="p">{</span>
    <span class="nx">allowed_methods</span>        <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">]</span>
    <span class="nx">cached_methods</span>         <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">]</span>
    <span class="nx">target_origin_id</span>       <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">app-prod-react</span><span class="p">.</span><span class="nx">id</span>

    <span class="nx">viewer_protocol_policy</span> <span class="o">=</span> <span class="s2">"redirect-to-https"</span>
    <span class="nx">min_ttl</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">default_ttl</span> <span class="o">=</span> <span class="mi">3600</span>
    <span class="nx">max_ttl</span> <span class="o">=</span> <span class="mi">86400</span>

    <span class="nx">forwarded_values</span> <span class="p">{</span>
      <span class="nx">query_string</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="nx">cookies</span> <span class="p">{</span>
        <span class="nx">forward</span> <span class="o">=</span> <span class="s2">"none"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1"># 추가</span>
  <span class="nx">ordered_cache_behavior</span> <span class="p">{</span>
    <span class="nx">path_pattern</span> <span class="o">=</span> <span class="s2">"/api/*"</span>
    <span class="nx">allowed_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"OPTIONS"</span><span class="p">,</span> <span class="s2">"PUT"</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="s2">"PATCH"</span><span class="p">,</span> <span class="s2">"DELETE"</span><span class="p">]</span>
    <span class="nx">cached_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">]</span>
    <span class="nx">target_origin_id</span>       <span class="o">=</span> <span class="nx">aws_lb</span><span class="p">.</span><span class="nx">app-alb</span><span class="p">.</span><span class="nx">id</span>

    <span class="nx">viewer_protocol_policy</span> <span class="o">=</span> <span class="s2">"redirect-to-https"</span>
    <span class="nx">default_ttl</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">max_ttl</span>     <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">min_ttl</span>     <span class="o">=</span> <span class="mi">0</span>

    <span class="nx">forwarded_values</span> <span class="p">{</span>
      <span class="nx">query_string</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">headers</span>      <span class="o">=</span> <span class="p">[</span><span class="s2">"*"</span><span class="p">]</span>
      <span class="nx">cookies</span> <span class="p">{</span>
        <span class="nx">forward</span> <span class="o">=</span> <span class="s2">"all"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">price_class</span> <span class="o">=</span> <span class="s2">"PriceClass_100"</span>

  <span class="nx">restrictions</span> <span class="p">{</span>
    <span class="nx">geo_restriction</span> <span class="p">{</span>
      <span class="nx">restriction_type</span> <span class="o">=</span> <span class="s2">"whitelist"</span>
      <span class="nx">locations</span>        <span class="o">=</span> <span class="p">[</span><span class="s2">"KR"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">viewer_certificate</span> <span class="p">{</span>
    <span class="nx">acm_certificate_arn</span> <span class="o">=</span> <span class="nx">aws_acm_certificate</span><span class="p">.</span><span class="nx">ssl-certificate-virginia</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">ssl_support_method</span> <span class="o">=</span> <span class="s2">"sni-only"</span>
    <span class="nx">minimum_protocol_version</span> <span class="o">=</span> <span class="s2">"TLSv1.2_2021"</span>
  <span class="p">}</span>

  <span class="nx">custom_error_response</span> <span class="p">{</span>
    <span class="nx">error_code</span> <span class="o">=</span> <span class="mi">403</span>
    <span class="nx">error_caching_min_ttl</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="nx">response_page_path</span> <span class="o">=</span> <span class="s2">"/index.html"</span>
    <span class="nx">response_code</span> <span class="o">=</span> <span class="mi">200</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>글에는 관리자 수정본만 작성한다. <code class="language-plaintext highlighter-rouge">Application Load Balancer</code> 원본을 추가하였고 <code class="language-plaintext highlighter-rouge">/api/*</code> 경로 패턴은 로드밸런서로 라우팅 될 수 있도록 동작을 수정하였다.</p>
<h3 id="5-codedeploy">
<span class="mr-2"><strong>5. CodeDeploy</strong></span><a href="#5-codedeploy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>Blue / Green 배포를 위한 <code class="language-plaintext highlighter-rouge">CodeDeploy</code> 관련 리소스를 생성한다.</p>
<div class="language-hcl highlighter-rouge">
<div class="code-header"> <span data-label-text="Hcl"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td>
<td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_codedeploy_app"</span> <span class="s2">"app-deploy-app"</span> <span class="p">{</span>
  <span class="nx">compute_platform</span> <span class="o">=</span> <span class="s2">"ECS"</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"app-deploy"</span>
<span class="p">}</span>

<span class="nx">data</span> <span class="s2">"aws_iam_policy_document"</span> <span class="s2">"app-deploy-assume-role"</span> <span class="p">{</span>
  <span class="nx">statement</span> <span class="p">{</span>
    <span class="nx">effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>

    <span class="nx">principals</span> <span class="p">{</span>
      <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"Service"</span>
      <span class="nx">identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"codedeploy.amazonaws.com"</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="nx">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"sts:AssumeRole"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"app-deploy-role"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"app-deploy-role"</span>
  <span class="nx">assume_role_policy</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_iam_policy_document</span><span class="p">.</span><span class="nx">app-deploy-assume-role</span><span class="p">.</span><span class="nx">json</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role_policy_attachment"</span> <span class="s2">"app-AWSCodeDeployRole"</span> <span class="p">{</span>
  <span class="nx">policy_arn</span> <span class="o">=</span> <span class="s2">"arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"</span>
  <span class="nx">role</span>       <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">app-deploy-role</span><span class="p">.</span><span class="nx">name</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role_policy_attachment"</span> <span class="s2">"app-AWSCodeDeployRoleForECS"</span> <span class="p">{</span>
  <span class="nx">policy_arn</span> <span class="o">=</span> <span class="s2">"arn:aws:iam::aws:policy/AWSCodeDeployRoleForECS"</span>
  <span class="nx">role</span>       <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">app-deploy-role</span><span class="p">.</span><span class="nx">name</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_codedeploy_deployment_group"</span> <span class="s2">"app-deploy-group"</span> <span class="p">{</span>
  <span class="nx">app_name</span>               <span class="o">=</span> <span class="nx">aws_codedeploy_app</span><span class="p">.</span><span class="nx">app-deploy-app</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">deployment_config_name</span> <span class="o">=</span> <span class="s2">"CodeDeployDefault.ECSAllAtOnce"</span>
  <span class="nx">deployment_group_name</span>  <span class="o">=</span> <span class="s2">"app-deploy-group"</span>
  <span class="nx">service_role_arn</span>       <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">app-deploy-role</span><span class="p">.</span><span class="nx">arn</span>

  <span class="nx">auto_rollback_configuration</span> <span class="p">{</span>
    <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>

  <span class="nx">blue_green_deployment_config</span> <span class="p">{</span>
    <span class="nx">deployment_ready_option</span> <span class="p">{</span>
      <span class="nx">action_on_timeout</span> <span class="o">=</span> <span class="s2">"CONTINUE_DEPLOYMENT"</span>
    <span class="p">}</span>

    <span class="nx">terminate_blue_instances_on_deployment_success</span> <span class="p">{</span>
      <span class="nx">action</span>                           <span class="o">=</span> <span class="s2">"TERMINATE"</span>
      <span class="nx">termination_wait_time_in_minutes</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">deployment_style</span> <span class="p">{</span>
    <span class="nx">deployment_option</span> <span class="o">=</span> <span class="s2">"WITH_TRAFFIC_CONTROL"</span>
    <span class="nx">deployment_type</span>   <span class="o">=</span> <span class="s2">"BLUE_GREEN"</span>
  <span class="p">}</span>

  <span class="nx">ecs_service</span> <span class="p">{</span>
    <span class="nx">cluster_name</span> <span class="o">=</span> <span class="nx">aws_ecs_cluster</span><span class="p">.</span><span class="nx">app-cluster</span><span class="p">.</span><span class="nx">name</span>
    <span class="nx">service_name</span> <span class="o">=</span> <span class="nx">aws_ecs_service</span><span class="p">.</span><span class="nx">app-ecs-service</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>

  <span class="nx">load_balancer_info</span> <span class="p">{</span>
    <span class="nx">target_group_pair_info</span> <span class="p">{</span>
      <span class="nx">prod_traffic_route</span> <span class="p">{</span>
        <span class="nx">listener_arns</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_lb_listener</span><span class="p">.</span><span class="nx">app-alb-listener-https</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
      <span class="p">}</span>

      <span class="nx">target_group</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">aws_lb_target_group</span><span class="p">.</span><span class="nx">app-ecs-service-tg1</span><span class="p">.</span><span class="nx">name</span>
      <span class="p">}</span>

      <span class="nx">target_group</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">aws_lb_target_group</span><span class="p">.</span><span class="nx">app-ecs-service-tg2</span><span class="p">.</span><span class="nx">name</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<ul>
<li>어플리케이션 생성</li>
<li>CodeDeploy 관련 IAM Role 생성</li>
<li>배포그룹 생성</li>
<li>로드밸런서 지정 (Blue / Green 배포를 위해 앞에서 생성한 타겟그룹 1, 2 지정)</li>
</ul>
<h3 id="6-github-actions-배포-스크립트-작성">
<span class="mr-2"><strong>6. Github Actions 배포 스크립트 작성</strong></span><a href="#6-github-actions-%EB%B0%B0%ED%8F%AC-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%EC%9E%91%EC%84%B1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>내가 사용한 Dockerfile이다.</p>
<div class="language-Dockerfile highlighter-rouge">
<div class="code-header"> <span data-label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
<td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> amazoncorretto:21</span>

<span class="c"># 타임존 세팅</span>
<span class="k">ENV</span><span class="s"> TZ="Asia/Seoul"</span>

<span class="k">ARG</span><span class="s"> JAR_PATH</span>

<span class="c"># 워크 디렉토리 세팅</span>
<span class="k">WORKDIR</span><span class="s"> /app-admin/</span>

<span class="c"># 빌드된 jar 파일 복사</span>
<span class="k">COPY</span><span class="s"> $JAR_PATH /app-admin/app.jar</span>

<span class="k">ENTRYPOINT</span><span class="s"> ["java","-jar","app.jar"]</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<div class="language-Dockerfile highlighter-rouge">
<div class="code-header"> <span data-label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> nginx:latest</span>
<span class="k">COPY</span><span class="s"> nginx.conf /etc/nginx/nginx.conf</span>
<span class="k">EXPOSE</span><span class="s"> 80</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>다음은 배포 스크립트다.</p>
<div class="language-yml highlighter-rouge">
<div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td>
<td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Spring Boot Application to ECS using CodeDeploy Blue / Green Deployment</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Check out the repository</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup JDK </span><span class="m">21</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-java@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">java-version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">21'</span>
          <span class="na">distribution</span><span class="pi">:</span> <span class="s1">'</span><span class="s">corretto'</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup Gradle</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">gradle/actions/setup-gradle@v3</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build Gradle</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">spring-boot</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">chmod +x ./gradlew</span>
          <span class="s">./gradlew bootjar --project-dir ./app-admin</span>
          <span class="s">./gradlew bootjar --project-dir ./app-user</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure AWS credentials</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v2</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">${{ secrets.AWS_ACCESS_KEY_ID }}</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">${{ secrets.AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">${{ secrets.AWS_REGION }}</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Login to Amazon ECR</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">login-ecr</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v2</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build, tag and push image to Amazon ECR</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">spring-boot</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">ECR_REGISTRY</span><span class="pi">:</span> <span class="s">${{ steps.login-ecr.outputs.registry }}</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
         <span class="s">docker build --build-arg JAR_PATH=app-admin/build/libs/*.jar --platform=linux/arm64 -t $ECR_REGISTRY/app-ecr:admin-latest -f app-admin/Dockerfile .</span>
         <span class="s">docker build --build-arg JAR_PATH=app-user/build/libs/*.jar --platform=linux/arm64 -t $ECR_REGISTRY/app-ecr:user-latest -f app-user/Dockerfile .</span>
         <span class="s">docker build --platform=linux/arm64 -t $ECR_REGISTRY/app-ecr:nginx-latest -f nginx.Dockerfile .</span>

         <span class="s">docker push $ECR_REGISTRY/app-ecr:admin-latest</span>
         <span class="s">docker push $ECR_REGISTRY/app-ecr:user-latest</span>
         <span class="s">docker push $ECR_REGISTRY/app-ecr:nginx-latest</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CodeDeploy Blue / Green Deployment</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">spring-boot</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">APPLICATION_NAME="${{ secrets.AWS_CODEDEPLOY_APPLICATION_NAME }}"</span>
          <span class="s">DEPLOYMENT_GROUP="${{ secrets.AWS_CODEDEPLOY_DEPLOYMENT_GROUP_NAME }}"</span>
          <span class="s">REGION="${{ secrets.AWS_REGION }}"</span>
          <span class="s">REVISION_JSON='{</span>
            <span class="s">"version": 1,</span>
            <span class="s">"Resources": [</span>
              <span class="s">{</span>
                <span class="s">"TargetService": {</span>
                  <span class="s">"Type": "AWS::ECS::Service",</span>
                  <span class="s">"Properties": {</span>
                    <span class="s">"TaskDefinition": "${{ secrets.AWS_CODEDEPLOY_TASK_DEFINITION }}",</span>
                    <span class="s">"LoadBalancerInfo": {</span>
                      <span class="s">"ContainerName": "nginx",</span>
                      <span class="s">"ContainerPort": 80</span>
                    <span class="s">},</span>
                    <span class="s">"PlatformVersion": "LATEST"</span>
                  <span class="s">}</span>
                <span class="s">}</span>
              <span class="s">}</span>
            <span class="s">]</span>
          <span class="s">}'</span>

          <span class="s"># Create a new deployment</span>
          <span class="s">aws deploy create-deployment \</span>
            <span class="s">--cli-input-json "{\"applicationName\":\"$APPLICATION_NAME\",\"deploymentGroupName\":\"$DEPLOYMENT_GROUP\",\"revision\":{\"revisionType\":\"AppSpecContent\",\"appSpecContent\":{\"content\":\"$(echo $REVISION_JSON | sed 's/"/\\"/g')\"}}}" \</span>
            <span class="s">--region $REGION</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<ol>
<li>repository checkout</li>
<li>setup jdk21</li>
<li>setup gradle</li>
<li>build gradle (bootjar)</li>
<li>configure aws credentials</li>
<li>login ecr</li>
<li>build, tag and push image to ecr<ul><li>OS, 아키텍처를 linux/arm64로 지정</li></ul>
</li>
<li>CodeDeploy 배포 생성<ul>
<li>어플리케이션 지정</li>
<li>배포 그룹 지정</li>
<li>리전 지정</li>
<li>태스크 정의 지정</li>
<li>로드밸런서가 트래픽을 nginx(80 포트) 로 라우팅하도록 지정</li>
</ul>
</li>
</ol>
<p>위와같은 순서로 진행된다. 두근거리는 마음으로 <code class="language-plaintext highlighter-rouge">Run workflow</code> 버튼을 눌러보자.</p>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="/categories/aws/">AWS</a>, <a href="/categories/terraform/">Terraform</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration">AWS</a> <a href="/tags/ecs/" class="post-tag no-text-decoration">ECS</a>
</div>
<div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div>
<div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Terraform%EC%9C%BC%EB%A1%9C+AWS+%EB%AC%B4%EC%A4%91%EB%8B%A8+%EB%B0%B0%ED%8F%AC+%EC%9D%B8%ED%94%84%EB%9D%BC+%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0+-+6.+%EC%9A%B4%EC%98%81%ED%99%98%EA%B2%BD+%28%EB%B0%B1%EC%97%94%EB%93%9C%29+-+keencho%27s+blog&amp;url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fterraform-aws-infra-6%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Terraform%EC%9C%BC%EB%A1%9C+AWS+%EB%AC%B4%EC%A4%91%EB%8B%A8+%EB%B0%B0%ED%8F%AC+%EC%9D%B8%ED%94%84%EB%9D%BC+%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0+-+6.+%EC%9A%B4%EC%98%81%ED%99%98%EA%B2%BD+%28%EB%B0%B1%EC%97%94%EB%93%9C%29+-+keencho%27s+blog&amp;u=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fterraform-aws-infra-6%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fterraform-aws-infra-6%2F&amp;text=Terraform%EC%9C%BC%EB%A1%9C+AWS+%EB%AC%B4%EC%A4%91%EB%8B%A8+%EB%B0%B0%ED%8F%AC+%EC%9D%B8%ED%94%84%EB%9D%BC+%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0+-+6.+%EC%9A%B4%EC%98%81%ED%99%98%EA%B2%BD+%28%EB%B0%B1%EC%97%94%EB%93%9C%29+-+keencho%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span>
</div>
</div>
</div>
</div></div>
<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">
<div class="access">
<div id="access-lastmod" class="post">
<div class="panel-heading">Recently Updated</div>
<ul class="post-content pl-0 pb-1 ml-1 mt-2">
<li><a href="/posts/jpa-flush/">JPA &amp; Hibernate Flush Mode</a></li>
<li><a href="/posts/aws-cicd-1/">AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 1. 개요</a></li>
<li><a href="/posts/terraform-aws-infra-6/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)</a></li>
<li><a href="/posts/aapt2-arm/">Arm 아키텍처에서 AAPT2 빌드 도구 사용하기</a></li>
<li><a href="/posts/terraform-aws-infra-1/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 1. 개요</a></li>
</ul>
</div>
<div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5">
<div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
<nav id="toc" data-toggle="toc"></nav>
</div>
</div>
</div>
<div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4">
<div id="related-posts" class="mt-5 mb-2 mb-sm-4">
<h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
<div class="card-deck mb-4">
<div class="card"> <a href="/posts/terraform-aws-infra-3/"><div class="card-body"> <em class="small" data-ts="1706915520" data-df="ll"> Feb 3, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 3. 네트워크</h3>
<div class="text-muted small"><p> Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리 Terraform으로 AWS ECS 무중단 배포 인프라 구성하기 - 3. 네트워크 이번 포스팅부터 본격적으로 AWS 리소스를 생성한다. 그 첫번째로 인프라 구성에 가장 기본이 되는 네트워...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/terraform-aws-infra-4/"><div class="card-body"> <em class="small" data-ts="1708729920" data-df="ll"> Feb 24, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 4. 테스트 환경</h3>
<div class="text-muted small"><p> Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리 Terraform으로 AWS ECS 무중단 배포 인프라 구성하기 - 4. 테스트 환경 이번 포스팅에서는 테스트 환경을 구성한다. 테스트 환경은 운영환경과는 다르게 백엔드, 프론트엔드, d...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/terraform-aws-infra-5/"><div class="card-body"> <em class="small" data-ts="1712963520" data-df="ll"> Apr 13, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 5. 운영환경 (프론트)</h3>
<div class="text-muted small"><p> Terraform으로 AWS 무중단 배포 인프라 구성하기 개요 기초 네트워크 테스트 환경 운영환경 (프론트) 운영환경 (백엔드) 마무리 Terraform으로 AWS ECS 무중단 배포 인프라 구성하기 - 5. 운영환경 (프론트) 프론트 운영환경을 구축한다. 리소스 1. S3 버킷 먼저 S3 버킷을 생성한다. resou...</p></div>
</div></a>
</div>
</div>
</div>
<div class="post-navigation d-flex justify-content-between"> <a href="/posts/terraform-aws-infra-5/" class="btn btn-outline-primary" prompt="Older"><p>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 5. 운영환경 (프론트)</p></a> <a href="/posts/terraform-aws-infra-7/" class="btn btn-outline-primary" prompt="Newer"><p>Terraform으로 AWS 무중단 배포 인프라 구성하기 - 7. 마무리</p></a>
</div>
</div></div>
<footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0">
<div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/keencho">keencho</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div>
<div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div>
</div></footer>
</div>
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content">
<div id="search-hints"><div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a>
</div>
</div></div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false">
<div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">×</span> </button>
</div>
<div class="toast-body text-center pt-0">
<p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
<button type="button" class="btn btn-primary" aria-label="Update"> Update </button>
</div>
</div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
