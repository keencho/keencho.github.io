<!DOCTYPE html><html lang="ko-KS" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Spring Security custom library 만들기" /><meta name="author" content="keencho" /><meta property="og:locale" content="ko_KS" /><meta name="description" content="Spring Security custom library 만들기 운영중인 시스템에 적용된 Spring Security custom library를 제 방식대로 바꿔보고 겸사겸사 Spring Security의 동작 방식, 원리에 대해 더 깊게 공부하고자 작성한 글입니다." /><meta property="og:description" content="Spring Security custom library 만들기 운영중인 시스템에 적용된 Spring Security custom library를 제 방식대로 바꿔보고 겸사겸사 Spring Security의 동작 방식, 원리에 대해 더 깊게 공부하고자 작성한 글입니다." /><link rel="canonical" href="https://keencho.github.io/posts/spring-security-custom-library/" /><meta property="og:url" content="https://keencho.github.io/posts/spring-security-custom-library/" /><meta property="og:site_name" content="keencho’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-08T08:12:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Spring Security custom library 만들기" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@keencho" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"keencho"},"dateModified":"2022-12-22T08:20:30+09:00","datePublished":"2022-09-08T08:12:00+09:00","description":"Spring Security custom library 만들기 운영중인 시스템에 적용된 Spring Security custom library를 제 방식대로 바꿔보고 겸사겸사 Spring Security의 동작 방식, 원리에 대해 더 깊게 공부하고자 작성한 글입니다.","headline":"Spring Security custom library 만들기","mainEntityOfPage":{"@type":"WebPage","@id":"https://keencho.github.io/posts/spring-security-custom-library/"},"url":"https://keencho.github.io/posts/spring-security-custom-library/"}</script><title>Spring Security custom library 만들기 | keencho's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="keencho's blog"><meta name="application-name" content="keencho's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/custom/keencho.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">keencho's blog</a></div><div class="site-subtitle font-italic">이것저것 정리하는 블로그.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/keencho" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['seyoung050412','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Spring Security custom library 만들기</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Spring Security custom library 만들기</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1662592320" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 8, 2022 </em> </span><div class="d-flex justify-content-between"> <span> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5517 words"> <em>30 min</em> read</span></div></div></div><div class="post-content"><h1 id="spring-security-custom-library-만들기"><strong>Spring Security custom library 만들기</strong></h1><p>운영중인 시스템에 적용된 Spring Security custom library를 제 방식대로 바꿔보고 겸사겸사 Spring Security의 동작 방식, 원리에 대해 더 깊게 공부하고자 작성한 글입니다.</p><blockquote><p>이 포스팅은 Spring Security가 어떤 방식으로 인증 / 인가 처리하는지 어느정도 이해하고 있다는 가정 하에 작성된 포스팅입니다.</p></blockquote><h2 id="사용된-라이브러리-의존성"><span class="mr-2"><strong>사용된 라이브러리 의존성</strong></span><a href="#사용된-라이브러리-의존성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-gradle highlighter-rouge"><div class="code-header"> <span data-label-text="Gradle"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">dependencies</span> <span class="o">{</span>
    <span class="c1">// spring</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-web'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-security'</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-data-jpa'</span>

    <span class="c1">// jwt</span>
    <span class="n">implementation</span> <span class="s1">'io.jsonwebtoken:jjwt-api:0.11.5'</span>
    <span class="n">implementation</span> <span class="s1">'io.jsonwebtoken:jjwt-impl:0.11.5'</span>
    <span class="n">implementation</span> <span class="s1">'io.jsonwebtoken:jjwt-jackson:0.11.5'</span>

    <span class="c1">// lombok</span>
    <span class="n">compileOnly</span> <span class="s1">'org.projectlombok:lombok'</span>
    <span class="n">annotationProcessor</span> <span class="s1">'org.projectlombok:lombok'</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Spring Data JPA를 사용하여 entity 객체를 중심으로 인증이 진행되도록 하였습니다.</p><h2 id="핵심-코드-작성"><span class="mr-2"><strong>핵심 코드 작성</strong></span><a href="#핵심-코드-작성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="1-베이스-모델"><span class="mr-2"><strong>1. 베이스 모델</strong></span><a href="#1-베이스-모델" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>첫째는 베이스 모델입니다. 추후 작성될 대부분의 코드의 제네릭에서 이 모델이 사용되기 때문에 가장 중요한 코드라고 생각됩니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@Data</span>
<span class="nd">@MappedSuperclass</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">KcAccountBaseModel</span> <span class="o">{</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="n">loginId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">accountNonExpired</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">accountNonLocked</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">credentialsNonExpired</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="nc">LocalDateTime</span> <span class="n">dtCreatedAt</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="nc">LocalDateTime</span> <span class="n">dtUpdatedAt</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>

    <span class="kd">protected</span> <span class="nc">LocalDateTime</span> <span class="n">dtPasswordChangedAt</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>

    <span class="kd">protected</span> <span class="nc">LocalDateTime</span> <span class="n">dtLastLoggedInAt</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="nc">LocalDateTime</span> <span class="n">dtLastAccessedAt</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="kt">int</span> <span class="n">loginAttemptCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>각각의 테이블은 용도 (사용자, 관리자, 시스템 등..) 으로 나뉘게 되고 각각의 테이블 엔티티들은 위의 베이스 모델을 상속받아 작성될 것입니다.</p><p>또다른 핵심 베이스 모델은 Security Account 모델입니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">KcSecurityAccount</span> <span class="kd">implements</span> <span class="nc">UserDetails</span><span class="o">,</span> <span class="nc">CredentialsContainer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">accountEntityClass</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">loginId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">accountNonExpired</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">accountNonLocked</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">credentialsNonExpired</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">enabled</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">data</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">KcSecurityAccount</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">accountEntityClass</span><span class="o">,</span> <span class="nc">String</span> <span class="n">loginId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">,</span>
                             <span class="kt">boolean</span> <span class="n">accountNonExpired</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">accountNonLocked</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">credentialsNonExpired</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">enabled</span><span class="o">,</span>
                             <span class="nc">Object</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accountEntityClass</span> <span class="o">=</span> <span class="n">accountEntityClass</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">loginId</span> <span class="o">=</span> <span class="n">loginId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">authorities</span> <span class="o">=</span> <span class="n">authorities</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accountNonExpired</span> <span class="o">=</span> <span class="n">accountNonExpired</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accountNonLocked</span> <span class="o">=</span> <span class="n">accountNonLocked</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">credentialsNonExpired</span> <span class="o">=</span> <span class="n">credentialsNonExpired</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">enabled</span> <span class="o">=</span> <span class="n">enabled</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eraseCredentials</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>위 모델은 로그인시 인증 객체로 쓰일 모델이며(UserDetails, CredentialsContainer 구현) 각각의 엔티티별로 또다른 객체 데이터를 가지고 있어야 할수도 있기 때문에 <code class="language-plaintext highlighter-rouge">Object data</code> 를 통해 이를 충족시키도록 하였습니다.</p><h3 id="2-베이스-모델-리포지토리"><span class="mr-2"><strong>2. 베이스 모델 리포지토리</strong></span><a href="#2-베이스-모델-리포지토리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">KcAccountRepository</span><span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">KcAccountBaseModel</span><span class="o">,</span> <span class="no">ID</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ID</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="no">T</span> <span class="nf">findByLoginId</span><span class="o">(</span><span class="nc">String</span> <span class="n">loginId</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">JPARepository</code> 를 상속하는 베이스모델 리포지토리이며 테이블 엔티티들은 이 리포지토리를 상속하는 또하나의 리포지토리를 작성해야 합니다.</p><h3 id="3-로그인-매니저"><span class="mr-2"><strong>3. 로그인 매니저</strong></span><a href="#3-로그인-매니저" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">KcLoginManager</span><span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">KcAccountBaseModel</span><span class="o">,</span> <span class="no">R</span> <span class="kd">extends</span> <span class="nc">KcAccountRepository</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="kd">extends</span> <span class="nc">UserDetailsService</span><span class="o">,</span> <span class="nc">KcAccountResolver</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">();</span>

    <span class="kt">int</span> <span class="nf">getMaxLoginAttemptCount</span><span class="o">();</span>

    <span class="kt">int</span> <span class="nf">getMaxLongTermNonUseAllowDay</span><span class="o">();</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="no">T</span> <span class="nf">findByLoginId</span><span class="o">(</span><span class="nc">String</span> <span class="n">loginId</span><span class="o">);</span>

    <span class="nd">@Transactional</span>
    <span class="kt">void</span> <span class="nf">updateOnLoginSuccess</span><span class="o">(</span><span class="nc">String</span> <span class="n">loginId</span><span class="o">);</span>

    <span class="nd">@Transactional</span>
    <span class="kt">int</span> <span class="nf">updateLoginAttemptAccount</span><span class="o">(</span><span class="nc">String</span> <span class="n">loginId</span><span class="o">);</span>

    <span class="nd">@Transactional</span>
    <span class="kt">void</span> <span class="nf">lockAccount</span><span class="o">(</span><span class="nc">String</span> <span class="n">loginId</span><span class="o">);</span>

<span class="o">}</span>
</pre></table></code></div></div><p>Spring Security를 접해보셨다면 한번쯤은 봤을 <code class="language-plaintext highlighter-rouge">loadUserByUsername(String username)</code> 메소드를 가지고있는 인터네이스는 <code class="language-plaintext highlighter-rouge">UserDetailsService</code>를 상속하는 로그인 매니저 인터페이스 입니다.</p><p>뒤에 보면 <code class="language-plaintext highlighter-rouge">KcAccountResolver</code>라는 인터페이스를 상속받았는데요, 이것은 핵심 코드 작성 이후 설명할 예정입니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">KcAccountResolver</span><span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">KcAccountBaseModel</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="no">T</span> <span class="nf">getAccountBySecurityAccount</span><span class="o">(</span><span class="nc">KcSecurityAccount</span> <span class="n">securityAccount</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>이런 형태라는것만 알아두시면 좋을것 같습니다.</p><p>다음은 로그인 매니저를 구현하는 기본 로그인 매니저 클래스 입니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">KcDefaultLoginManager</span><span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">KcAccountBaseModel</span><span class="o">,</span> <span class="no">R</span> <span class="kd">extends</span> <span class="nc">KcAccountRepository</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="kd">implements</span> <span class="nc">KcLoginManager</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">R</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="no">R</span> <span class="n">repo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">KcDefaultLoginManager</span><span class="o">(</span><span class="no">R</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">repo</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">getMaxLoginAttemptCount</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">getMaxLongTermNonUseAllowDay</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="no">T</span> <span class="nf">findByLoginId</span><span class="o">(</span><span class="nc">String</span> <span class="n">loginId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repo</span><span class="o">.</span><span class="na">findByLoginId</span><span class="o">(</span><span class="n">loginId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateOnLoginSuccess</span><span class="o">(</span><span class="nc">String</span> <span class="n">loginId</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">account</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findByLoginId</span><span class="o">(</span><span class="n">loginId</span><span class="o">);</span>

        <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="s">"account must not be null!"</span><span class="o">);</span>

        <span class="kt">var</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>

        <span class="n">account</span><span class="o">.</span><span class="na">setDtLastAccessedAt</span><span class="o">(</span><span class="n">now</span><span class="o">);</span>
        <span class="n">account</span><span class="o">.</span><span class="na">setDtLastLoggedInAt</span><span class="o">(</span><span class="n">now</span><span class="o">);</span>
        <span class="n">account</span><span class="o">.</span><span class="na">setLoginAttemptCount</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

        <span class="n">repo</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">updateLoginAttemptAccount</span><span class="o">(</span><span class="nc">String</span> <span class="n">loginId</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">account</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findByLoginId</span><span class="o">(</span><span class="n">loginId</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">var</span> <span class="n">currentCount</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="na">getLoginAttemptCount</span><span class="o">();</span>
        <span class="kt">var</span> <span class="n">targetCount</span> <span class="o">=</span> <span class="n">currentCount</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">targetCount</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="o">.</span><span class="na">getMaxLoginAttemptCount</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// 잠궈야 한다면 로그인시도는 초기화한다.</span>
            <span class="n">targetCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setAccountNonLocked</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">account</span><span class="o">.</span><span class="na">setLoginAttemptCount</span><span class="o">(</span><span class="n">targetCount</span><span class="o">);</span>

        <span class="n">repo</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">targetCount</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lockAccount</span><span class="o">(</span><span class="nc">String</span> <span class="n">loginId</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">account</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findByLoginId</span><span class="o">(</span><span class="n">loginId</span><span class="o">);</span>

        <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="s">"account must not be null!"</span><span class="o">);</span>

        <span class="n">account</span><span class="o">.</span><span class="na">setAccountNonLocked</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="n">repo</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="no">T</span> <span class="nf">getAccountBySecurityAccount</span><span class="o">(</span><span class="nc">KcSecurityAccount</span> <span class="n">securityAccount</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">findByLoginId</span><span class="o">(</span><span class="n">securityAccount</span><span class="o">.</span><span class="na">getLoginId</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>추상메소드로 선언된 메소드들은 엔티티별, 비즈니스 로직별로 다를수 있는 부분이기 때문에 따로 작성하였습니다. (예 - 관리자는 로그인시도 3회 허용, 사용자는 로그인시도 5회 허용 등)</p><p>그 외 계정 잠금이나 로그인 횟수 관리등 제가 생각했을때 로그인에 있어 가장 기본이라 생각되는 부분을 구현하였습니다.</p><h3 id="4-인증-프로바이더"><span class="mr-2"><strong>4. 인증 프로바이더</strong></span><a href="#4-인증-프로바이더" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>다음은 인증 프로바이더입니다. <code class="language-plaintext highlighter-rouge">AbstractUserDetailsAuthenticationProvider</code> 를 상속받은 클래스이며 <code class="language-plaintext highlighter-rouge">PasswordEncoder</code>와 <code class="language-plaintext highlighter-rouge">UserDetailsService</code>를 생성자로 주입받습니다.</p><p>아까 기본 로그인 매니저를 작성할때 <code class="language-plaintext highlighter-rouge">loadUserByUsername()</code> 메소드를 구현해야 했지만 대부분 엔티티별로 다른 로직을 적용해야 하기 때문에 추상 메소드로 두었지요? 바로 그 메소드를 사용하기 위해 <code class="language-plaintext highlighter-rouge">UserDetailsService</code>를 주입받습니다.</p><p>또한 <code class="language-plaintext highlighter-rouge">AbstractUserDetailsAuthenticationProvider</code> 클래스의 2개의 추상 메소드를 재정의 합니다. 사용하는 용도에 따라 다른 메소드들도 재정의 할수 있겠네요.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">KcAuthenticationProvider</span> <span class="kd">extends</span> <span class="nc">AbstractUserDetailsAuthenticationProvider</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="nd">@Getter</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">KcAuthenticationProvider</span><span class="o">(</span><span class="nc">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">,</span> <span class="nc">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">passwordEncoder</span> <span class="o">=</span> <span class="n">passwordEncoder</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userDetailsService</span> <span class="o">=</span> <span class="n">userDetailsService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">additionalAuthenticationChecks</span><span class="o">(</span><span class="nc">UserDetails</span> <span class="n">userDetails</span><span class="o">,</span> <span class="nc">UsernamePasswordAuthenticationToken</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span><span class="o">.</span><span class="na">getCredentials</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="n">messages</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="s">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span><span class="o">,</span> <span class="s">"Bad credentials"</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="kt">var</span> <span class="n">passedPassword</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getCredentials</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">passedPassword</span><span class="o">,</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="n">messages</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="s">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span><span class="o">,</span> <span class="s">"Bad credentials"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">UserDetails</span> <span class="nf">retrieveUser</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">UsernamePasswordAuthenticationToken</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span> <span class="o">{</span>
        <span class="nc">UserDetails</span> <span class="n">loadedUser</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">loadedUser</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">.</span><span class="na">loadUserByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">UsernameNotFoundException</span> <span class="n">notFoundException</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">notFoundException</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InternalAuthenticationServiceException</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">loadedUser</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InternalAuthenticationServiceException</span><span class="o">(</span><span class="s">"DefaultUserDetailsService returned null, it must be not null!"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">loadedUser</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="5-인증-프로바이더-매니저"><span class="mr-2"><strong>5. 인증 프로바이더 매니저</strong></span><a href="#5-인증-프로바이더-매니저" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>인증 프로바이더들을 관리할 매니저 클래스를 작성하겠습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">KcAuthenticationProviderManagerImpl</span> <span class="kd">implements</span> <span class="nc">KcAuthenticationProviderManager</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">KcAuthenticationProvider</span><span class="o">&gt;</span> <span class="n">authenticationProviderMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">KcAuthenticationProvider</span><span class="o">&gt;</span> <span class="nf">getProviders</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">authenticationProviderMap</span><span class="o">.</span><span class="na">values</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">KcAuthenticationProvider</span> <span class="nf">getAuthenticationProvider</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">accountEntityClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">authenticationProviderMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">accountEntityClass</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addAuthenticationProvider</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">accountEntityClass</span><span class="o">,</span> <span class="nc">KcAuthenticationProvider</span> <span class="n">authenticationProvider</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">authenticationProviderMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">accountEntityClass</span><span class="o">),</span> <span class="s">"authenticationProviderMap already has key"</span><span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">authenticationProviderMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">accountEntityClass</span><span class="o">,</span> <span class="n">authenticationProvider</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>위 클래스는 추후 사용할 어플리케이션에서 bean 으로 등록되어야 합니다. 그리고 각각의 엔티티와 인증 프로바이더를 <code class="language-plaintext highlighter-rouge">addAuthenticationProvider</code> 메소드를 통해 추가해야 합니다. (이는 예제 작성할때 다루게 됩니다.)</p><h3 id="6-jwt-프로바이더"><span class="mr-2"><strong>6. JWT 프로바이더</strong></span><a href="#6-jwt-프로바이더" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Spring Security는 기본적으로 세션 방식입니다. 다만 세션 사용이 제약되는 환경이 있을텐데요. 예를 들어 제 경우 앱개발을 하는데 세션이 의도한대로 동작하지 않아 몇일동안 애먹은 적이 있습니다. 그런 경우를 대비하여 jwt 토큰방식으로 인증하는 대비책을 세워보았습니다.</p><blockquote><p>주의! 이 포스팅에서는 refresh token을 사용하지 않고 1개의 오리지널 토큰만을 사용합니다. 오리지널 토큰의 유효기간을 길게 잡거나 refresh token 인증 방식을 추가로 적용해보세요.</p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">KcDefaultJwtTokenProvider</span> <span class="kd">implements</span> <span class="nc">KcJwtTokenProvider</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">claimsKeyName</span> <span class="o">=</span> <span class="s">"loginId"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">SecretKey</span> <span class="n">secretKey</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">KcDefaultJwtTokenProvider</span><span class="o">(</span><span class="nc">String</span> <span class="n">secretKey</span><span class="o">,</span> <span class="nc">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">secretKey</span> <span class="o">=</span> <span class="nc">Keys</span><span class="o">.</span><span class="na">hmacShaKeyFor</span><span class="o">(</span><span class="n">secretKey</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userDetailsService</span> <span class="o">=</span> <span class="n">userDetailsService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">long</span> <span class="nf">getExpireDays</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">String</span> <span class="nf">getCookieName</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">getAuthentication</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">claims</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getClaims</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>

        <span class="kt">var</span> <span class="n">loginId</span> <span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">claimsKeyName</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">loginId</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">var</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="n">userDetailsService</span><span class="o">.</span><span class="na">loadUserByUsername</span><span class="o">(</span><span class="n">loginId</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">userDetails</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">resolveToken</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cookies</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="nl">cookie:</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getCookieName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">createToken</span><span class="o">(</span><span class="nc">KcSecurityAccount</span> <span class="n">securityAccount</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">claims</span> <span class="o">=</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">claims</span><span class="o">().</span><span class="na">setSubject</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>

        <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">claimsKeyName</span><span class="o">,</span> <span class="n">securityAccount</span><span class="o">.</span><span class="na">getLoginId</span><span class="o">());</span>
        <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"data"</span><span class="o">,</span> <span class="n">securityAccount</span><span class="o">.</span><span class="na">getData</span><span class="o">());</span>

        <span class="kt">var</span> <span class="n">limit</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusDays</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getExpireDays</span><span class="o">());</span>
        <span class="kt">var</span> <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>

        <span class="k">return</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">setClaims</span><span class="o">(</span><span class="n">claims</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setIssuedAt</span><span class="o">(</span><span class="n">date</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="nc">Date</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">limit</span><span class="o">.</span><span class="na">atZone</span><span class="o">(</span><span class="nc">ZoneId</span><span class="o">.</span><span class="na">systemDefault</span><span class="o">()).</span><span class="na">toInstant</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">secretKey</span><span class="o">,</span> <span class="nc">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS256</span><span class="o">)</span>
                <span class="o">.</span><span class="na">compact</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValidate</span><span class="o">(</span><span class="nc">String</span> <span class="n">jwtToken</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">jwtToken</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">claims</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getClaims</span><span class="o">(</span><span class="n">jwtToken</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">claims</span><span class="o">.</span><span class="na">getExpiration</span><span class="o">().</span><span class="na">after</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ExpiredJwtException, MalformedJwtException, SignatureException 이 넘어올수 있다.</span>
            <span class="c1">// 만료가 되었다면 아예 예외가 넘어올수 있으므로 예외처리 블록으로 묶고 false를 리턴함.</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Claims</span> <span class="nf">getClaims</span><span class="o">(</span><span class="nc">String</span> <span class="n">jwtToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Jwts</span>
                <span class="o">.</span><span class="na">parserBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">secretKey</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
                <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">jwtToken</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>유효기간 <code class="language-plaintext highlighter-rouge">getExpiresDays()</code>와 쿠키 이름 <code class="language-plaintext highlighter-rouge">getCookieName()</code>은 추상메소드로 선언하였습니다. jwt 토큰 관련해서는 <code class="language-plaintext highlighter-rouge">jjwt</code> 라이브러리를 사용하였습니다.</p><h3 id="7-jwt-인증-필터"><span class="mr-2"><strong>7. jwt 인증 필터</strong></span><a href="#7-jwt-인증-필터" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>jwt 인증을 사용하려면 결국 필터단에서 cookie를 파싱하여 <code class="language-plaintext highlighter-rouge">SecurityContextHolder</code> 에 객체를 세팅해줘야 하는데요, 이를위한 공용 필터 코드를 작성 하겠습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">KcJwtAuthenticationFilter</span> <span class="kd">extends</span> <span class="nc">GenericFilterBean</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">KcJwtTokenProvider</span> <span class="n">jwtTokenProvider</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">KcJwtAuthenticationFilter</span><span class="o">(</span><span class="nc">KcJwtTokenProvider</span> <span class="n">jwtTokenProvider</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">jwtTokenProvider</span> <span class="o">=</span> <span class="n">jwtTokenProvider</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">token</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">jwtTokenProvider</span><span class="o">.</span><span class="na">resolveToken</span><span class="o">((</span><span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jwtTokenProvider</span><span class="o">.</span><span class="na">isValidate</span><span class="o">(</span><span class="n">token</span><span class="o">))</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">authentication</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">jwtTokenProvider</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>

            <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="8-로그인-서비스"><span class="mr-2"><strong>8. 로그인 서비스</strong></span><a href="#8-로그인-서비스" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>마지막 핵심 코드인 로그인 서비스 입니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">KcDefaultLoginService</span><span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">KcAccountBaseModel</span><span class="o">,</span> <span class="no">R</span> <span class="kd">extends</span> <span class="nc">KcAccountRepository</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="kd">implements</span> <span class="nc">KcLoginService</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">R</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">getClass</span><span class="o">());</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">KcAuthenticationProviderManager</span> <span class="n">authenticationProviderManager</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">KcLoginManager</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">R</span><span class="o">&gt;</span> <span class="n">accountLoginManager</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">KcJwtTokenProvider</span> <span class="n">jwtTokenProvider</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isUseJwtToken</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">KcDefaultLoginService</span><span class="o">(</span><span class="nc">KcAuthenticationProviderManager</span> <span class="n">authenticationProviderManager</span><span class="o">,</span> <span class="nc">KcLoginManager</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">R</span><span class="o">&gt;</span> <span class="n">accountLoginManager</span><span class="o">,</span> <span class="nc">KcJwtTokenProvider</span> <span class="n">jwtTokenProvider</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">authenticationProviderManager</span> <span class="o">=</span> <span class="n">authenticationProviderManager</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accountLoginManager</span> <span class="o">=</span> <span class="n">accountLoginManager</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">jwtTokenProvider</span> <span class="o">=</span> <span class="n">jwtTokenProvider</span><span class="o">;</span>

        <span class="c1">// jwtTokenProvider가 주입되었다면 jwt token 방식을 사용하는 것이라고 간주한다.</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jwtTokenProvider</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">isUseJwtToken</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getAccountEntityClass</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">login</span><span class="o">(</span><span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">String</span> <span class="n">loginId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">;</span>
        <span class="kt">var</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">loginId</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">authenticationProvider</span> <span class="o">=</span> <span class="n">authenticationProviderManager</span><span class="o">.</span><span class="na">getAuthenticationProvider</span><span class="o">(</span><span class="n">getAccountEntityClass</span><span class="o">());</span>

            <span class="c1">// 코딩 잘못임. bean에 엔티티 클래스 / 매니저 등록 안함.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">authenticationProvider</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"system error: authentication provider manager doesn't have target entity class. check your bean configuration"</span><span class="o">);</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">KcSystemException</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="n">authentication</span> <span class="o">=</span> <span class="n">authenticationProvider</span><span class="o">.</span><span class="na">authenticate</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>

            <span class="c1">// 여기까지 들어왔으면 아이디 / 비밀번호는 일치한다는 의미임</span>
            <span class="c1">// 계정을 잠금처리하는 batch 따로 돌아야 하겠지만 돌기 전에 이곳에 들어왔다고 가정하고 장기 미접속 계정 잠금처리</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">isLongTermNotUsed</span><span class="o">(</span><span class="n">loginId</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">accountLoginManager</span><span class="o">.</span><span class="na">lockAccount</span><span class="o">(</span><span class="n">loginId</span><span class="o">);</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">LockedException</span><span class="o">(</span><span class="s">"account locked"</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// jwt 인증은 별도로 구현한 인증과정을 거쳐야 한다는 뜻.</span>
            <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">isUseJwtToken</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">BadCredentialsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">accountLoginManager</span><span class="o">.</span><span class="na">updateLoginAttemptAccount</span><span class="o">(</span><span class="n">loginId</span><span class="o">);</span>

            <span class="c1">// 계정 없음</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">KcLoginFailureException</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">KcLoginFailureException</span><span class="o">(</span><span class="n">cnt</span><span class="o">,</span> <span class="n">accountLoginManager</span><span class="o">.</span><span class="na">getMaxLoginAttemptCount</span><span class="o">());</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">LockedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 계정이 잠긴 이유는 일단 2가지라고 생각함.</span>
            <span class="c1">// 1. N회 비밀번호 틀린 경우</span>
            <span class="c1">// 2. 장기 미접속</span>
            <span class="c1">// 따라서 장기 미접속 여부 판단해야함.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isLongTermNotUsed</span><span class="o">(</span><span class="n">loginId</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">KcAccountLongTermNotUsedException</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="k">throw</span> <span class="k">new</span> <span class="nf">KcAccountLockedException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">DisabledException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">KcAccountDisabledException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">KcSystemException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">KcSystemException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">KcLoginFailureException</span><span class="o">(</span><span class="s">"login failure"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">accountLoginManager</span><span class="o">.</span><span class="na">updateOnLoginSuccess</span><span class="o">(</span><span class="n">token</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>

        <span class="kt">var</span> <span class="n">securityUser</span> <span class="o">=</span> <span class="o">(</span><span class="nc">KcSecurityAccount</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">isUseJwtToken</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">jwtToken</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">jwtTokenProvider</span><span class="o">.</span><span class="na">createToken</span><span class="o">(</span><span class="n">securityUser</span><span class="o">);</span>

            <span class="c1">// 토큰을 쿠키에 저장한다. 이때 이름은 tokenProvider에 정의해둔 이름을 사용한다.</span>
            <span class="c1">// 필터가 그 이름을 알수 있어야 하는데, 여기서는 KcDefaultJwtTokenProvider에도 동일한 jwtTokenProvider를 주입받게 해두었다.</span>
            <span class="c1">// 구현하는 사람 맘대로 하면 된다. 어쨌든 이 쿠키 이름을 필터가 알아야 한다.</span>
            <span class="kt">var</span> <span class="n">cookie</span> <span class="o">=</span> <span class="nc">ResponseCookie</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jwtTokenProvider</span><span class="o">.</span><span class="na">getCookieName</span><span class="o">(),</span> <span class="n">jwtToken</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">sameSite</span><span class="o">(</span><span class="s">"None"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">httpOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">secure</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">maxAge</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jwtTokenProvider</span><span class="o">.</span><span class="na">getExpireDays</span><span class="o">()</span> <span class="o">*</span> <span class="mi">86400</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

            <span class="n">response</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"Set-Cookie"</span><span class="o">,</span> <span class="n">cookie</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

            <span class="k">return</span> <span class="n">jwtToken</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">securityUser</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 장기 미접속여부 판단
     * 
     * @param loginId
     * @return true if not use for long time
     */</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isLongTermNotUsed</span><span class="o">(</span><span class="nc">String</span> <span class="n">loginId</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountLoginManager</span><span class="o">.</span><span class="na">findByLoginId</span><span class="o">(</span><span class="n">loginId</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">maxLongTermNonUseAllowDay</span> <span class="o">=</span> <span class="n">accountLoginManager</span><span class="o">.</span><span class="na">getMaxLongTermNonUseAllowDay</span><span class="o">();</span>
        
        <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">maxLongTermNonUseAllowDay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getDtLastAccessedAt</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getDtLastAccessedAt</span><span class="o">().</span><span class="na">plusDays</span><span class="o">(</span><span class="n">maxLongTermNonUseAllowDay</span><span class="o">).</span><span class="na">isBefore</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()))</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>   
        <span class="o">}</span>
        
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>jwt 토큰 프로바이더가 주입되었다면 jwt 인증방식을 사용한다고 체크합니다. 또한 jwt 인증방식을 사용한다면 ` SecurityContextHolder.getContext().setAuthentication()` 을 통해 세션에 인증정보를 저장하지 않고 쿠키를 사용합니다.</p><p>또한 장기미접속 여부 판단을 기본적으로 하게 하였습니다. 이 또한 비즈니스 로직에 따라 재정의 될수 있겠네요.</p><h2 id="예제-작성"><span class="mr-2"><strong>예제 작성</strong></span><a href="#예제-작성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>간단한 웹 어플리케이션 예제를 작성해 보겠습니다.</p><p>관리자 와 일반 사용자가 있습니다. 이중 관리자는 jwt 토큰 인증 방식을 사용합니다.</p><h3 id="1-엔티티-모델"><span class="mr-2"><strong>1. 엔티티 모델</strong></span><a href="#1-엔티티-모델" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><code class="language-plaintext highlighter-rouge">KcAccountBaseModel</code>을 상속받는 엔티티 모델을 작성합니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">onlyExplicitlyIncluded</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@Data</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"ADMIN_ACCOUNT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdminAccount</span> <span class="kd">extends</span> <span class="nc">KcAccountBaseModel</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">onlyExplicitlyIncluded</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@Data</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"USER_ACCOUNT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserAccount</span> <span class="kd">extends</span> <span class="nc">KcAccountBaseModel</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="2-리포지토리"><span class="mr-2"><strong>2. 리포지토리</strong></span><a href="#2-리포지토리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><code class="language-plaintext highlighter-rouge">KcAccountRepository</code>를 상속받는 리포지토리를 작성합니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AdminAccountRepository</span> <span class="kd">extends</span> <span class="nc">KcAccountRepository</span><span class="o">&lt;</span><span class="nc">AdminAccount</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserAccountRepository</span> <span class="kd">extends</span> <span class="nc">KcAccountRepository</span><span class="o">&lt;</span><span class="nc">UserAccount</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="3-로그인-매니저-1"><span class="mr-2"><strong>3. 로그인 매니저</strong></span><a href="#3-로그인-매니저-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><code class="language-plaintext highlighter-rouge">KcDefaultLoginManager</code> 를 상속받는 로그인 매니저를 작성합니다.</p><p>로그인 매니저를 작성하기 전 <code class="language-plaintext highlighter-rouge">KcSeurityAccount</code> 객체의 data에 들어갈 객체를 정의하겠습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginAccountData</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">loginId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">LoginAccountType</span> <span class="n">loginAccountType</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>다음은 엔티티별 로그인 매니저 입니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdminLoginManager</span> <span class="kd">extends</span> <span class="nc">KcDefaultLoginManager</span><span class="o">&lt;</span><span class="nc">AdminAccount</span><span class="o">,</span> <span class="nc">AdminAccountRepository</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">AdminLoginManager</span><span class="o">(</span><span class="nc">AdminAccountRepository</span> <span class="n">adminAccountRepository</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">adminAccountRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">AccountRoleCode</span><span class="o">.</span><span class="na">ROLE_COMMON</span><span class="o">);</span>
        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">AccountRoleCode</span><span class="o">.</span><span class="na">ROLE_ADMIN</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">set</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">SimpleGrantedAuthority:</span><span class="o">:</span><span class="k">new</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getMaxLoginAttemptCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">5</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getMaxLongTermNonUseAllowDay</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">90</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">username</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="s">"Username must be provided!"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kt">var</span> <span class="n">account</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findByLoginId</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="s">"Username not found, username="</span> <span class="o">+</span> <span class="n">username</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kt">var</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">();</span>

        <span class="kt">var</span> <span class="n">loginData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginAccountData</span><span class="o">();</span>
        <span class="n">loginData</span><span class="o">.</span><span class="na">setLoginId</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getLoginId</span><span class="o">());</span>
        <span class="n">loginData</span><span class="o">.</span><span class="na">setLoginAccountType</span><span class="o">(</span><span class="nc">LoginAccountType</span><span class="o">.</span><span class="na">ADMIN</span><span class="o">);</span>
        <span class="n">loginData</span><span class="o">.</span><span class="na">setAuthorities</span><span class="o">(</span><span class="n">authorities</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">GrantedAuthority:</span><span class="o">:</span><span class="n">getAuthority</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">()));</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">KcSecurityAccount</span><span class="o">(</span>
                <span class="nc">AdminAccount</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="n">account</span><span class="o">.</span><span class="na">getLoginId</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">authorities</span><span class="o">),</span>
                <span class="n">account</span><span class="o">.</span><span class="na">isAccountNonExpired</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">isAccountNonLocked</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">isCredentialsNonExpired</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">isEnabled</span><span class="o">(),</span>
                <span class="n">loginData</span>
        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserLoginManager</span> <span class="kd">extends</span> <span class="nc">KcDefaultLoginManager</span><span class="o">&lt;</span><span class="nc">UserAccount</span><span class="o">,</span> <span class="nc">UserAccountRepository</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">UserLoginManager</span><span class="o">(</span><span class="nc">UserAccountRepository</span> <span class="n">userAccountRepository</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">userAccountRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">AccountRoleCode</span><span class="o">.</span><span class="na">ROLE_COMMON</span><span class="o">);</span>
        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">AccountRoleCode</span><span class="o">.</span><span class="na">ROLE_USER</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">set</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">SimpleGrantedAuthority:</span><span class="o">:</span><span class="k">new</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getMaxLoginAttemptCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">3</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getMaxLongTermNonUseAllowDay</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">30</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">username</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="s">"Username must be provided!"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kt">var</span> <span class="n">account</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findByLoginId</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="s">"Username not found, username="</span> <span class="o">+</span> <span class="n">username</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kt">var</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">();</span>

        <span class="kt">var</span> <span class="n">loginData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginAccountData</span><span class="o">();</span>
        <span class="n">loginData</span><span class="o">.</span><span class="na">setLoginId</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getLoginId</span><span class="o">());</span>
        <span class="n">loginData</span><span class="o">.</span><span class="na">setLoginAccountType</span><span class="o">(</span><span class="nc">LoginAccountType</span><span class="o">.</span><span class="na">USER</span><span class="o">);</span>
        <span class="n">loginData</span><span class="o">.</span><span class="na">setAuthorities</span><span class="o">(</span><span class="n">authorities</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">GrantedAuthority:</span><span class="o">:</span><span class="n">getAuthority</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">()));</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">KcSecurityAccount</span><span class="o">(</span>
                <span class="nc">UserAccount</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="n">account</span><span class="o">.</span><span class="na">getLoginId</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">authorities</span><span class="o">),</span>
                <span class="n">account</span><span class="o">.</span><span class="na">isAccountNonExpired</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">isAccountNonLocked</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">isCredentialsNonExpired</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">isEnabled</span><span class="o">(),</span>
                <span class="n">loginData</span>
        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>여기서 <code class="language-plaintext highlighter-rouge">GrantedAuthority</code> 에 해당되는 role들은 그냥 일반 String text로 부여해도 되지만, 제 경우 아래와 같이 상수만 가지고 있는 클래스를 하나 만들어 사용하였습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountRoleCode</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ROLE_COMMON</span> <span class="o">=</span> <span class="s">"ROLE_COMMON"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ROLE_ADMIN</span> <span class="o">=</span> <span class="s">"ROLE_ADMIN"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ROLE_USER</span> <span class="o">=</span> <span class="s">"ROLE_USER"</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>이렇게 관리하는 편이 추후 <code class="language-plaintext highlighter-rouge">hasAuthority()</code>로 경로 권한 체크하는 코드에서 이점을 가질수 있을 것이라 생각했습니다.</p><h3 id="4-bean-주입"><span class="mr-2"><strong>4. bean 주입</strong></span><a href="#4-bean-주입" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>다음은 <code class="language-plaintext highlighter-rouge">KcAccountResolverManager</code> 와 관리자 엔티티 인증에서 사용될 <code class="language-plaintext highlighter-rouge">KcJwtTokenProvider</code> 를 bean으로 주입해야 합니다. <code class="language-plaintext highlighter-rouge">PasswordEncoder</code>의 경우 <code class="language-plaintext highlighter-rouge">BcryptPasswordEncoder</code>를 사용하였습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityBeanContainer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">JWT_SECRET_KEY</span> <span class="o">=</span> <span class="s">"Qi0P4mU8ABq6M9nMZG5y67E6hmNad14n"</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">AdminLoginManager</span> <span class="n">adminAccountLoginManager</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">UserLoginManager</span> <span class="n">userLoginManager</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">BCryptPasswordEncoder</span> <span class="nf">bCryptPasswordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">KcAuthenticationProviderManager</span> <span class="nf">authenticationProviderManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">authenticationProviderManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KcAuthenticationProviderManagerImpl</span><span class="o">();</span>

        <span class="n">authenticationProviderManager</span><span class="o">.</span><span class="na">addAuthenticationProvider</span><span class="o">(</span>
                <span class="nc">AdminAccount</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="k">new</span> <span class="nf">KcAuthenticationProvider</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bCryptPasswordEncoder</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">adminAccountLoginManager</span><span class="o">)</span>
        <span class="o">);</span>

        <span class="n">authenticationProviderManager</span><span class="o">.</span><span class="na">addAuthenticationProvider</span><span class="o">(</span>
                <span class="nc">UserAccount</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="k">new</span> <span class="nf">KcAuthenticationProvider</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bCryptPasswordEncoder</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">userLoginManager</span><span class="o">)</span>
        <span class="o">);</span>

        <span class="k">return</span> <span class="n">authenticationProviderManager</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"adminJwtTokenProvider"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">KcJwtTokenProvider</span> <span class="nf">adminJwtTokenProvider</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">KcDefaultJwtTokenProvider</span><span class="o">(</span><span class="no">JWT_SECRET_KEY</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">adminAccountLoginManager</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getExpireDays</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="mi">30</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCookieName</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">"KEENCHO_JWT_TOKEN"</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">JWT_SECRET_KEY</code> 의 경우 이곳에서는 상수로 선언하였지만 따로 .properties 나 .yml 설정파일로 빼는 편이 보안상 좋을것 같습니다.</p><p>각각의 로그인 서비스를 작성할때 <code class="language-plaintext highlighter-rouge">KcJwtTokenProvider</code>를 주입받아야 하는데 <code class="language-plaintext highlighter-rouge">@Autowired</code>는 사용하지 못하고 <code class="language-plaintext highlighter-rouge">@Qualifier</code>를 사용해야 하기 때문에 <code class="language-plaintext highlighter-rouge">KcJwtTokenProvider</code>의 경우 별도의 이름을 부여하였습니다.</p><h3 id="5-로그인-서비스"><span class="mr-2"><strong>5. 로그인 서비스</strong></span><a href="#5-로그인-서비스" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>다음은 로그인 서비스 입니다. 앞서 말한대로 관리자의 경우 <code class="language-plaintext highlighter-rouge">KcJwtTokenProvider</code>를 생성자 생성시 주입합니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdminLoginService</span> <span class="kd">extends</span> <span class="nc">KcDefaultLoginService</span><span class="o">&lt;</span><span class="nc">AdminAccount</span><span class="o">,</span> <span class="nc">AdminAccountRepository</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">AdminLoginService</span><span class="o">(</span>
            <span class="nc">KcAuthenticationProviderManager</span> <span class="n">authenticationProviderManager</span><span class="o">,</span>
            <span class="nc">AdminLoginManager</span> <span class="n">accountLoginManager</span><span class="o">,</span>
            <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"adminJwtTokenProvider"</span><span class="o">)</span>
            <span class="nc">KcJwtTokenProvider</span> <span class="n">jwtTokenProvider</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">authenticationProviderManager</span><span class="o">,</span> <span class="n">accountLoginManager</span><span class="o">,</span> <span class="n">jwtTokenProvider</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">AdminAccount</span><span class="o">&gt;</span> <span class="nf">getAccountEntityClass</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">AdminAccount</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserLoginService</span> <span class="kd">extends</span> <span class="nc">KcDefaultLoginService</span><span class="o">&lt;</span><span class="nc">UserAccount</span><span class="o">,</span> <span class="nc">UserAccountRepository</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">UserLoginService</span><span class="o">(</span>
            <span class="nc">KcAuthenticationProviderManager</span> <span class="n">authenticationProviderManager</span><span class="o">,</span>
            <span class="nc">UserLoginManager</span> <span class="n">accountLoginManager</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">authenticationProviderManager</span><span class="o">,</span> <span class="n">accountLoginManager</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">UserAccount</span><span class="o">&gt;</span> <span class="nf">getAccountEntityClass</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">UserAccount</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="6-웹-예제"><span class="mr-2"><strong>6. 웹 예제</strong></span><a href="#6-웹-예제" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>첫째로 커스텀 securityFilterChain을 bean으로 주입합니다.</p><blockquote><p>참고로 Spring Security 최신버전에서는 WebSecurityConfigurerAdapter 가 deprecated되었고 이제는 그냥 bean으로 주입하면 됩니다.</p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSecurityConfiguration</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">KcAuthenticationProviderManager</span> <span class="n">kcAuthenticationProviderManager</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">KcJwtTokenProvider</span> <span class="n">kcJwtTokenProvider</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SecurityFilterChain</span> <span class="nf">securityFilterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    
        <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">provider</span> <span class="o">:</span> <span class="n">kcAuthenticationProviderManager</span><span class="o">.</span><span class="na">getProviders</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">http</span><span class="o">.</span><span class="na">authenticationProvider</span><span class="o">(</span><span class="n">provider</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// POST 요청 오픈</span>
        <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
        <span class="n">http</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">frameOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
        <span class="n">http</span><span class="o">.</span><span class="na">httpBasic</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>

        <span class="c1">// jwt token 인증부 필터등록</span>
        <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="k">new</span> <span class="nc">KcJwtAuthenticationFilter</span><span class="o">(</span><span class="n">kcJwtTokenProvider</span><span class="o">),</span> <span class="nc">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">http</span>
                <span class="o">.</span><span class="na">antMatcher</span><span class="o">(</span><span class="s">"/**"</span><span class="o">).</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="c1">//</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/api/auth/test/admin"</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="nc">AccountRoleCode</span><span class="o">.</span><span class="na">ROLE_ADMIN</span><span class="o">)</span>
                <span class="c1">//</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/api/auth/test/user"</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="nc">AccountRoleCode</span><span class="o">.</span><span class="na">ROLE_USER</span><span class="o">)</span>
                <span class="c1">//</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="c1">//</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">api/auth/test/**</code> 의 경우 각각 경로에 따라 role을 가진 사용자만 접근할 수 있도록 설정하였습니다.</p><p>다음은 로그인 컨트롤러 부분입니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">KcLoginService</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">KcAccountBaseModel</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="nc">KcAccountRepository</span><span class="o">&lt;?,</span> <span class="o">?&gt;&gt;&gt;</span> <span class="n">kcLoginService</span><span class="o">;</span>

    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">KcAccountBaseModel</span><span class="o">&gt;,</span> <span class="nc">KcLoginService</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">KcAccountBaseModel</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="nc">KcAccountRepository</span><span class="o">&lt;?,</span> <span class="o">?&gt;&gt;&gt;</span> <span class="n">loginServiceMap</span><span class="o">;</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initMap</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">loginServiceMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">svc</span> <span class="o">:</span> <span class="n">kcLoginService</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">loginServiceMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">svc</span><span class="o">.</span><span class="na">getAccountEntityClass</span><span class="o">(),</span> <span class="n">svc</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">login</span><span class="o">(</span>
            <span class="nd">@RequestBody</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">,</span>
            <span class="nd">@RequestParam</span> <span class="nc">String</span> <span class="n">type</span><span class="o">,</span>
            <span class="nc">HttpServletResponse</span> <span class="n">response</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">id</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"pw"</span><span class="o">);</span>

        <span class="kt">var</span> <span class="n">clazz</span> <span class="o">=</span> <span class="s">"admin"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">?</span> <span class="nc">AdminAccount</span><span class="o">.</span><span class="na">class</span> <span class="o">:</span> <span class="nc">UserAccount</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">loginServiceMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">clazz</span><span class="o">).</span><span class="na">login</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">pw</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/auth/test/admin"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">authTestAdmin</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"success"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/auth/test/user"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">authTestUser</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"success"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>최초 시작시 각각의 로그인 서비스들을 map에 넣어 로그인시 엔티티를 통해 올바른 서비스를 찾아갈 수 있도록 하였습니다.</p><p>마지막으로 위 api를 테스트하는 html을 만들어 테스트하면 모두 완료입니다. 다만 여기에서는 따로 다루지 않겠습니다. (깃허브 링크를 참고하세요.)</p><h2 id="마무리"><span class="mr-2"><strong>마무리</strong></span><a href="#마무리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>커스텀 라이브러리를 만들어보며 Spring Security에 대해 조금더 자세히 알아볼수 있었습니다. 위 라이브러리에는 몇개의 문제가 있는데요, 가장 큰 문제는 중복 인증 문제입니다.</p><p>A 엔티티가 jwt 토큰 인증방식을 사용하고 B 엔티티는 기존 세션 인증방식을 사용한다고 가정했을때, jwt 인증 필터가 항상 세션 인증 필터 뒤에 있기 때문에 A와 B 모두 로그인된 상태해서 인증을 진행하면 A만 인증이 되는 문제가 일어나게 됩니다. 하지만 이는 하나의 어플리케이션 일때만 문제가 되며 만약 엔티티별로 다른 모듈을 만들어 각각의 bean을 주입받는 방식으로 멀티모듈 프로젝트를 구성하면 문제가 되지 않습니다.</p><p>여기서는 설명하지 않았지만 <code class="language-plaintext highlighter-rouge">WebMvcConfigurer</code> 인터페이스의 <code class="language-plaintext highlighter-rouge">addArgumentResolvers</code> 메소드를 통해 <code class="language-plaintext highlighter-rouge">ControllerAdvice</code> 혹은 <code class="language-plaintext highlighter-rouge">Controller</code>의 시작점에 현재 인증된 인증 객체 정보를 가져올수 있게 할수도 있습니다. 예를들어 아래와 같이 말이지요. (깃허브 링크를 참고하세요.)</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/auth/test/admin"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">AdminAccount</span> <span class="nf">authTestAdmin</span><span class="o">(</span>
        <span class="nd">@KcsAccount</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="nc">AdminAccount</span> <span class="n">adminAccount</span><span class="o">,</span>
        <span class="nd">@KcsAccount</span><span class="o">(</span><span class="n">accountType</span> <span class="o">=</span> <span class="nc">KcsAccountType</span><span class="o">.</span><span class="na">SECURITY_ACCOUNT</span><span class="o">)</span> <span class="nc">KcSecurityAccount</span> <span class="n">securityAccount</span>
        <span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">adminAccount</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>어쨌든 이 포스팅이 자신만의 Spring Security 인증을 구현하려는 분들께 도움이 되었으면 좋겠습니다.</p><blockquote><p>라이브러리: <a href="https://github.com/keencho/lib-spring/tree/master/src/main/java/com/keencho/lib/spring/security">https://github.com/keencho/lib-spring/tree/master/src/main/java/com/keencho/lib/spring/security</a><br /> 예제: <a href="https://github.com/keencho/java-sandbox/tree/master/spring-security">https://github.com/keencho/java-sandbox/tree/master/spring-security</a></p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spring-security/'>Spring Security</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a> <a href="/tags/spring/" class="post-tag no-text-decoration" >Spring</a> <a href="/tags/spring-security/" class="post-tag no-text-decoration" >Spring Security</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Spring+Security+custom+library+%EB%A7%8C%EB%93%A4%EA%B8%B0+-+keencho%27s+blog&url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fspring-security-custom-library%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Spring+Security+custom+library+%EB%A7%8C%EB%93%A4%EA%B8%B0+-+keencho%27s+blog&u=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fspring-security-custom-library%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fspring-security-custom-library%2F&text=Spring+Security+custom+library+%EB%A7%8C%EB%93%A4%EA%B8%B0+-+keencho%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/jpa-flush/">JPA & Hibernate Flush Mode</a><li><a href="/posts/aws-cicd-1/">AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 1. 개요</a><li><a href="/posts/terraform-aws-infra-6/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)</a><li><a href="/posts/aapt2-arm/">Arm 아키텍처에서 AAPT2 빌드 도구 사용하기</a><li><a href="/posts/terraform-aws-infra-1/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 1. 개요</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/proxy-pattern/"><div class="card-body"> <em class="small" data-ts="1625310720" data-df="ll" > Jul 3, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>프록시 패턴 (Proxy Pattern)</h3><div class="text-muted small"><p> 프록시 패턴 프록시(Proxy) 는 대리자 라는 뜻입니다. 실생활서의 의미처럼 프로그램에서의 프록시도 누군가에게 어떤 일을 대신 시키는 것 이란 의미를 가지고 있습니다. 때때로 우리는 객체에 대한 액세스를 제어하는 기능을 필요합니다. 예를 들어 무겁고 많은 자원을 필요로 하는 클래스의 한두가지 메소드만 사용해야 하더라도 생성자로 전체 클래스를 인스턴...</p></div></div></a></div><div class="card"> <a href="/posts/singleton-pattern/"><div class="card-body"> <em class="small" data-ts="1625569920" data-df="ll" > Jul 6, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>싱글턴 패턴 (Singleton Pattern)</h3><div class="text-muted small"><p> 싱글턴 패턴 싱글턴 패턴은 생성자가 여러 차례 호출되더라도 실제로 생성되는 객체는 하나이고 최초 생성 이후 호출된 생성자는 최초의 생성자가 생성한 객체를 리턴하는 디자인 유형입니다. 구조 싱글턴 클래스는 자체 클래스의 동일한 인스턴스를 반환하는 getInstance() 라는 정적 메소드를 선언했습니다. 싱글턴의 생성자는 ...</p></div></div></a></div><div class="card"> <a href="/posts/observer-pattern/"><div class="card-body"> <em class="small" data-ts="1625829120" data-df="ll" > Jul 9, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>옵저버 패턴 (Observer Pattern)</h3><div class="text-muted small"><p> 옵저버 패턴 옵저버 패턴은 객체의 상태 변화를 관찰하는 관찰자들, 즉 옵저버의 목록을 객체에 등록하여 상태 변화가 있을 때마다 메스드 등을 통해 객체가 직접 목록의 각 옵저버에게 통지하도록 하는 디자인 패턴입니다. 구조 게시자는 다른 객체들에게 관심 이벤트를 발행합니다. 이 이벤트난 게시자가 상태를 변경하거나 어떤 동작을 실행할 때 발생합니...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/hibernate-cross-join/" class="btn btn-outline-primary" prompt="Older"><p>Hibernate, JPA 에서 발생하는 Cross Join 문제 해결하기</p></a> <a href="/posts/querydsl-qbuilder-qsetter-1/" class="btn btn-outline-primary" prompt="Newer"><p>QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (1)</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/keencho">keencho</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
