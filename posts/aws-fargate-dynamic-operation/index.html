<!DOCTYPE html><html lang="ko-KS" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="야간 및 주말에 AWS Fargate 동적으로 운영하기" /><meta name="author" content="keencho" /><meta property="og:locale" content="ko_KS" /><meta name="description" content="야간 및 주말에 AWS Fargate 동적으로 운영하기 사내에서만 사용하는 관리자(관제) 서비스가 있다. 아주 가끔 업무 시간외에 쓸일이 있긴 하지만 대부분의 경우 평일 21시 ~ 08시, 주말에는 전혀 사용하지 않는다." /><meta property="og:description" content="야간 및 주말에 AWS Fargate 동적으로 운영하기 사내에서만 사용하는 관리자(관제) 서비스가 있다. 아주 가끔 업무 시간외에 쓸일이 있긴 하지만 대부분의 경우 평일 21시 ~ 08시, 주말에는 전혀 사용하지 않는다." /><link rel="canonical" href="https://keencho.github.io/posts/aws-fargate-dynamic-operation/" /><meta property="og:url" content="https://keencho.github.io/posts/aws-fargate-dynamic-operation/" /><meta property="og:site_name" content="keencho’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-12-14T08:12:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="야간 및 주말에 AWS Fargate 동적으로 운영하기" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@keencho" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"keencho"},"dateModified":"2024-12-14T08:12:00+09:00","datePublished":"2024-12-14T08:12:00+09:00","description":"야간 및 주말에 AWS Fargate 동적으로 운영하기 사내에서만 사용하는 관리자(관제) 서비스가 있다. 아주 가끔 업무 시간외에 쓸일이 있긴 하지만 대부분의 경우 평일 21시 ~ 08시, 주말에는 전혀 사용하지 않는다.","headline":"야간 및 주말에 AWS Fargate 동적으로 운영하기","mainEntityOfPage":{"@type":"WebPage","@id":"https://keencho.github.io/posts/aws-fargate-dynamic-operation/"},"url":"https://keencho.github.io/posts/aws-fargate-dynamic-operation/"}</script><title>야간 및 주말에 AWS Fargate 동적으로 운영하기 | keencho's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="keencho's blog"><meta name="application-name" content="keencho's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end">
<div class="profile-wrapper text-center">
<div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/custom/keencho.jpg" alt="avatar" onerror="this.style.display='none'"> </a>
</div>
<div class="site-title mt-3"> <a href="/">keencho's blog</a>
</div>
<div class="site-subtitle font-italic">이것저것 정리하는 블로그.</div>
</div>
<ul class="w-100">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a>
</li>
<li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a>
</li>
</ul>
<div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/keencho" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20['seyoung050412','gmail.com'].join('@')" aria-label="email"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> </a>
</div>
</div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>야간 및 주말에 AWS Fargate 동적으로 운영하기</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div>
<i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel">Cancel</span>
</div></div><div id="main-wrapper" class="d-flex justify-content-center">
<div id="main" class="container pl-xl-4 pr-xl-4">
<div class="row">
<div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2">
<h1 data-toc-skip>야간 및 주말에 AWS Fargate 동적으로 운영하기</h1>
<div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1734131520" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 14, 2024 </em> </span><div class="d-flex justify-content-between"> <span> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5072 words"> <em>28 min</em> read</span>
</div>
</div>
</div>
<div class="post-content">
<h1 id="야간-및-주말에-aws-fargate-동적으로-운영하기"><strong>야간 및 주말에 AWS Fargate 동적으로 운영하기</strong></h1>
<p>사내에서만 사용하는 관리자(관제) 서비스가 있다. 아주 가끔 업무 시간외에 쓸일이 있긴 하지만 대부분의 경우 평일 21시 ~ 08시, 주말에는 전혀 사용하지 않는다.</p>
<p>클라우드의 장점중 <code class="language-plaintext highlighter-rouge">필요한 만큼만 사용, 필요할 때만 사용</code>을 중요한 장점으로 생각한다. 그래서 이 기회에 AWS Fargate 를 동적으로 운영해보기로 했다.</p>
<blockquote><p><img class="emoji" title=":exclamation:" alt=":exclamation:" src="https://github.githubassets.com/images/icons/emoji/unicode/2757.png" height="20" width="20"> 본 포스팅에서 소개하는 로직은, 제 개인적인 접근 방식이므로 실제 상용 시스템에 적용하기 전 철저한 테스트 과정이 필요합니다.</p></blockquote>
<h2 id="현재-아키텍처">
<span class="mr-2"><strong>현재 아키텍처</strong></span><a href="#%ED%98%84%EC%9E%AC-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>현재 아키텍처는 다음과 같다. <img data-src="/assets/img/custom/aws-fargate-dynamic-operation/1.png" alt="1" data-proofer-ignore></p>
<p>CloudFront에서 1차적인 요청을 처리하고 경로가 <code class="language-plaintext highlighter-rouge">/api</code> 로 시작한다면 api endpoints로 간주하여 로드밸런서 - Fargate로 요청을 보내고 그 외는 frontend api로 간주하여 s3로 요청을 보낸다. 프론트는 React, 백엔드는 Spring Boot로 구성되어 있다.</p>
<h2 id="업무-외-시간-아키텍처">
<span class="mr-2"><strong>업무 외 시간 아키텍처</strong></span><a href="#%EC%97%85%EB%AC%B4-%EC%99%B8-%EC%8B%9C%EA%B0%84-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>업무 외 시간 아키텍처는 다음과 같다. <img data-src="/assets/img/custom/aws-fargate-dynamic-operation/2.png" alt="2" data-proofer-ignore></p>
<p>프론트엔드로 가는 요청은 건들지 않았다. 아예 처음부터 <code class="language-plaintext highlighter-rouge">CloudFront</code> 도 업무 외 시간 트래픽을 핸들링할수 있게 별도의 배포를 구성할까도 고민해봤지만, CloudFront 배포에서는 동일한 대체 도메인 이름을 여러 배포에 중복해서 사용할 수 없기 때문에 포기했다. 예를들어 업무시간에는 a.b.c -&gt; a 배포, 그 외 시간에는 a.b.c -&gt; b 배포 이게 안된다. 물론 업무 외 시간에 a 배포의 대체 도메인을 바꿔버리면 되지만 CloudFront 수정 후 배포 시간이 꽤 소요되기 때문에 포기했다.</p>
<p>백엔드 아키텍처를 변경했다. 기존 Fargate로 가는 요청을 Lambda로 보낸다. 그 외 <code class="language-plaintext highlighter-rouge">EventBridge</code> 가 수행하는 동작에 대해서는 아래에서 설명한다.</p>
<h2 id="lambda-함수-작성하기">
<span class="mr-2"><strong>Lambda 함수 작성하기</strong></span><a href="#lambda-%ED%95%A8%EC%88%98-%EC%9E%91%EC%84%B1%ED%95%98%EA%B8%B0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>람다가 처리하는 일이 많다. 처리하는일은 다음과 같다.</p>
<ul>
<li>EventBridge 스케줄러 실행 요청 처리</li>
<li>EventBridge 이벤트 규칙을 통해 전달된 이벤트 처리</li>
<li>Application Load Balancer 로부터 전달된 요청 처리</li>
</ul>
<p>다음은 람다의 index 코드이다. 여기서 분기를 통해 각 이벤트를 처리한다.</p>
<div class="language-javascript highlighter-rouge">
<div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td>
<td class="rouge-code"><pre><span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="k">async </span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="k">if </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 로드밸런서 요청</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">requestContext</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">requestContext</span><span class="p">.</span><span class="nx">elb</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nf">handleAlb</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">sourceLocation</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">sourceLocation</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">EventBridge</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 서비스가 SERVICE_STEADY_STATE 가 되었을때</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">eventName</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">SERVICE_STEADY_STATE</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">handleService</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// EventBridge 스케줄러 실행 요청 처리</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">eventName</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">FARGATE_SCALING_TRIGGER</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">handleScaling</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>다음은 시스템을 핸들링할때 사용될 서비스 데이터이다. 사실 호스트나 기타 데이터로 필요한 arn들을 역으로 찾아갈수도 있겠으나 그렇게 되면 불필요한 호출이나 로직이 들어가기 때문에 필요한 정보들을 변수에 담아두기로 했다.</p>
<div class="language-javascript highlighter-rouge">
<div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">SERVICE_DATA</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">admin</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">host</span><span class="p">:</span> <span class="dl">'</span><span class="s1">admin.keencho.com</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">cluster</span><span class="p">:</span> <span class="dl">'</span><span class="s1">keencho-cluster</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">service</span><span class="p">:</span> <span class="dl">'</span><span class="s1">admin</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">albArn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">로드 밸런서 arn</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">albRuleArns</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">실제 admin.keencho.com 을 HTTP 호스트 헤더 조건으로 가지고 있는 리스너 규칙 arn 리스트</span><span class="dl">'</span><span class="p">],</span>
        <span class="na">lambdaTargetGroupArn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">람다가 포함되어 있는 대상그룹 arn</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">ecsFargateTargetGroupArn</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">실제 fargate 태스크가 포함되어 있는 대상그룹 arn 리스트</span><span class="dl">'</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<h3 id="eventbridge-스케줄러-실행-요청-처리">
<span class="mr-2"><strong>EventBridge 스케줄러 실행 요청 처리</strong></span><a href="#eventbridge-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%9F%AC-%EC%8B%A4%ED%96%89-%EC%9A%94%EC%B2%AD-%EC%B2%98%EB%A6%AC" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>첫번째는 EventBridge 스케줄러 실행 요청 처리이다. <code class="language-plaintext highlighter-rouge">Amazon EventBridge -&gt; Scheduler -&gt; 일정</code> 에서 설정하였으며 어떻게 설정하는지까지 설명하진 않는다. 나의 경우 30분마다 작동하게 설정하였으며, 다음과 같은 페이로드를 전달하도록 하였다.</p>
<div class="language-json highlighter-rouge">
<div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre><span class="p">{</span><span class="w"> </span><span class="nl">"sourceLocation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EventBridge"</span><span class="p">,</span><span class="w"> </span><span class="nl">"eventName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FARGATE_SCALING_TRIGGER"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></pre></td>
</tr></tbody></table></code></div>
</div>
<p>위 페이로드를 전달받은 람다는 <code class="language-plaintext highlighter-rouge">handleScaling</code> 메소드를 호출한다. 이 메소드는 1차로 시간을 확인한다. 현재 시간이 주말이거나 평일 21시 ~ 08시 사이면 <code class="language-plaintext highlighter-rouge">stop</code> 메소드를, 그 외에는 <code class="language-plaintext highlighter-rouge">start</code> 메소드를 호출한다.</p>
<div class="language-javascript highlighter-rouge">
<div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">handleScaling</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">utcHour</span> <span class="o">=</span> <span class="nx">now</span><span class="p">.</span><span class="nf">getUTCHours</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">kstHour</span> <span class="o">=</span> <span class="p">(</span><span class="nx">utcHour</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">%</span> <span class="mi">24</span>

  <span class="kd">const</span> <span class="nx">isNightTime</span> <span class="o">=</span> <span class="p">(</span><span class="nx">kstHour</span> <span class="o">&gt;=</span> <span class="mi">21</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">kstHour</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">kstTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nf">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
  <span class="kd">const</span> <span class="nx">kstDay</span> <span class="o">=</span> <span class="nx">kstTime</span><span class="p">.</span><span class="nf">getUTCDay</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">isWeekend</span> <span class="o">=</span> <span class="nx">kstDay</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">kstDay</span> <span class="o">===</span> <span class="mi">6</span><span class="p">;</span>

  <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">data</span> <span class="k">of</span> <span class="nx">SERVICE_DATA</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">isNightTime</span> <span class="o">||</span> <span class="nx">isWeekend</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nf">stop</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nf">start</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<h5 id="1-stop">
<span class="mr-2"><strong>1. stop</strong></span><a href="#1-stop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h5>
<p>멈춰야 하는 시간대이면 멈춘다. 다음은 사용되는 전체 코드이다.</p>
<div class="language-javascript highlighter-rouge">
<div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
</pre></td>
<td class="rouge-code"><pre><span class="c1">// 서비스 가져오기</span>
<span class="kd">const</span> <span class="nx">getService</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">ecsClient</span><span class="p">,</span> <span class="nx">clusterName</span><span class="p">,</span> <span class="nx">serviceName</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ecsClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="k">new</span> <span class="nc">DescribeServicesCommand</span><span class="p">({</span>
    <span class="na">cluster</span><span class="p">:</span> <span class="nx">clusterName</span><span class="p">,</span>
    <span class="na">services</span><span class="p">:</span> <span class="p">[</span><span class="nx">serviceName</span><span class="p">]</span>
  <span class="p">}))</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span> <span class="o">||</span> <span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">services</span> <span class="o">||</span> <span class="nx">response</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">undefined</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">services</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// 트래픽 검증</span>
<span class="kd">const</span> <span class="nx">checkTraffic</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">();</span>

  <span class="kd">const</span> <span class="nx">end</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nc">UTC</span><span class="p">(</span>
    <span class="nx">now</span><span class="p">.</span><span class="nf">getUTCFullYear</span><span class="p">(),</span>
    <span class="nx">now</span><span class="p">.</span><span class="nf">getUTCMonth</span><span class="p">(),</span>
    <span class="nx">now</span><span class="p">.</span><span class="nf">getUTCDate</span><span class="p">(),</span>
    <span class="nx">now</span><span class="p">.</span><span class="nf">getUTCHours</span><span class="p">(),</span>
    <span class="nx">now</span><span class="p">.</span><span class="nf">getUTCMinutes</span><span class="p">(),</span>
    <span class="nx">now</span><span class="p">.</span><span class="nf">getUTCSeconds</span><span class="p">()</span>
  <span class="p">));</span>

  <span class="c1">// 20분</span>
  <span class="kd">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="nx">end</span><span class="p">.</span><span class="nf">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

  <span class="c1">// 간격: 20분</span>
  <span class="kd">const</span> <span class="nx">period</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">loadBalancerArn</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">albArn</span>

  <span class="kd">const</span> <span class="nx">loadBalancerName</span> <span class="o">=</span> <span class="nx">loadBalancerArn</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">).</span><span class="nf">pop</span><span class="p">().</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">).</span><span class="nf">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">sum</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">data</span><span class="p">.</span><span class="nx">ecsFargateTargetGroupArn</span><span class="p">.</span><span class="nf">reduce</span><span class="p">(</span><span class="k">async </span><span class="p">(</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">arn</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">accumulated</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">acc</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">tgName</span> <span class="o">=</span> <span class="nx">arn</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">).</span><span class="nf">pop</span><span class="p">()</span>

    <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">StartTime</span><span class="p">:</span> <span class="nx">start</span><span class="p">,</span>
      <span class="na">EndTime</span><span class="p">:</span> <span class="nx">end</span><span class="p">,</span>
      <span class="na">MetricDataQueries</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="na">Id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">count</span><span class="dl">"</span><span class="p">,</span>
          <span class="na">MetricStat</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">Metric</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">Namespace</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AWS/ApplicationELB</span><span class="dl">"</span><span class="p">,</span>
              <span class="na">MetricName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">HTTPCode_Target_2XX_Count</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// 200번대 상태 코드만 필터링</span>
              <span class="na">Dimensions</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="na">Name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">LoadBalancer</span><span class="dl">"</span><span class="p">,</span>
                  <span class="na">Value</span><span class="p">:</span> <span class="nx">loadBalancerName</span>
                <span class="p">},</span>
                <span class="p">{</span>
                  <span class="na">Name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">TargetGroup</span><span class="dl">"</span><span class="p">,</span>
                  <span class="na">Value</span><span class="p">:</span> <span class="nx">tgName</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="na">Period</span><span class="p">:</span> <span class="nx">period</span><span class="p">,</span>
            <span class="na">Stat</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Sum</span><span class="dl">"</span> <span class="c1">// 요청 개수의 합계</span>
          <span class="p">},</span>
          <span class="na">Label</span><span class="p">:</span> <span class="dl">"</span><span class="s2">200 Status Code Requests</span><span class="dl">"</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">};</span>

    <span class="kd">const</span> <span class="nx">cloudwatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CloudWatchClient</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ap-northeast-2</span><span class="dl">'</span> <span class="p">});</span>
    <span class="kd">const</span> <span class="nx">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetMetricDataCommand</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">cloudwatch</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">command</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">MetricDataResults</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="kd">const</span> <span class="nx">trafficSum</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">.</span><span class="nx">Values</span> <span class="o">||</span> <span class="nx">results</span><span class="p">.</span><span class="nx">Values</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="nx">results</span><span class="p">.</span><span class="nx">Values</span><span class="p">.</span><span class="nf">reduce</span><span class="p">((</span><span class="nx">sum</span><span class="p">,</span> <span class="nx">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">number</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">accumulated</span> <span class="o">+</span> <span class="nx">trafficSum</span><span class="p">;</span>

  <span class="p">},</span> <span class="nb">Promise</span><span class="p">.</span><span class="nf">resolve</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

  <span class="k">return</span> <span class="nx">sum</span> <span class="o">===</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">stop</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">////////// 1. 멈춰야 하는 서비스인지 검증</span>
  <span class="kd">const</span> <span class="nx">ecsClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ECSClient</span><span class="p">({</span><span class="na">region</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ap-northeast-2</span><span class="dl">'</span><span class="p">});</span>

  <span class="kd">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getService</span><span class="p">(</span><span class="nx">ecsClient</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">service</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">service</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">service</span><span class="p">.</span><span class="nx">desiredCount</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span>
  <span class="p">}</span>

  <span class="c1">// 새벽에 도는 스케쥴의 경우 현재 desiredCount가 1 이상인 경우 지난 20분간 2xx 상태코드를 가진 트래픽이 있는지 검증한다.</span>
  <span class="c1">// 사용중인데 꺼지면 안되기 때문이다.</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="k">await</span> <span class="nf">checkTraffic</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">////////// 2. 멈춰야 하는 서비스라면 해당 서비스로 라우팅중인 로드밸런서 룰 변경</span>
  <span class="kd">const</span> <span class="nx">albClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ElasticLoadBalancingV2Client</span><span class="p">({</span><span class="na">region</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ap-northeast-2</span><span class="dl">'</span><span class="p">})</span>
  <span class="kd">const</span> <span class="nx">describeResponse</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">albClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span>
    <span class="k">new</span> <span class="nc">DescribeRulesCommand</span><span class="p">({</span>
      <span class="na">RuleArns</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">albRuleArns</span>
    <span class="p">})</span>
  <span class="p">);</span>

  <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">rule</span> <span class="k">of </span><span class="p">(</span><span class="nx">describeResponse</span><span class="p">.</span><span class="nx">Rules</span> <span class="o">||</span> <span class="p">[]))</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">Actions</span> <span class="o">&amp;&amp;</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">Actions</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">Actions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">forward</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">Actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="kd">const</span> <span class="nx">updatedAction</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">...</span><span class="nx">action</span><span class="p">,</span>
        <span class="na">TargetGroupArn</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">lambdaTargetGroupArn</span><span class="p">,</span>
        <span class="na">ForwardConfig</span><span class="p">:</span> <span class="p">{</span>
          <span class="p">...</span><span class="nx">action</span><span class="p">.</span><span class="nx">ForwardConfig</span><span class="p">,</span>
          <span class="na">TargetGroups</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="na">TargetGroupArn</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">lambdaTargetGroupArn</span><span class="p">,</span>
              <span class="na">Weight</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">};</span>

      <span class="k">await</span> <span class="nx">albClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span>
        <span class="k">new</span> <span class="nc">ModifyRuleCommand</span><span class="p">({</span>
          <span class="na">RuleArn</span><span class="p">:</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">RuleArn</span><span class="p">,</span>
          <span class="na">Actions</span><span class="p">:</span> <span class="p">[</span><span class="nx">updatedAction</span><span class="p">]</span>
        <span class="p">})</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">////////// 3. 서비스 desired count 0 처리</span>
  <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">cluster</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span>
    <span class="na">service</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">service</span><span class="p">,</span>
    <span class="na">desiredCount</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">}</span>

  <span class="k">await</span> <span class="nx">ecsClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="k">new</span> <span class="nc">UpdateServiceCommand</span><span class="p">(</span><span class="nx">params</span><span class="p">));</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>순서는 다음과 같다.</p>
<ol>
<li>멈춰야 하는 서비스인지 검증한다.<ul>
<li>이미 ecs 서비스의 desired count가 0 이면 수행하지 않는다.</li>
<li>지난 20분간 2xx 상태코드를 리턴한 요청이 있으면 수행하지 않는다. (이 스케줄러는 30분 간격으로 도는데 도는 시점에 사용하고 있을수도 있기 때문에)</li>
</ul>
</li>
<li>
<code class="language-plaintext highlighter-rouge">실제 admin.keencho.com 을 HTTP 호스트 헤더 조건으로 가지고 있는 리스너 규칙 arn 리스트</code> 리스너 규칙의 작업을 <code class="language-plaintext highlighter-rouge">람다 대상그룹으로 전달</code> 로 변경한다.</li>
<li>ecs 서비스의 desired count를 0으로 변경한다.</li>
</ol>
<p>이렇게 하면 api 트래픽은 람다로 가고 서비스의 태스크 수는 0이 된다. 태스크가 동작하지 않으므로 당연히 요금이 부과되지 않는다.</p>
<h5 id="2-start">
<span class="mr-2"><strong>2. start</strong></span><a href="#2-start" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h5>
<p>업무시간이 다가오면 시작한다. 다음은 사용되는 전체 코드이다.</p>
<div class="language-javascript highlighter-rouge">
<div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">////////// 1. 시작해야 하는 서비스인지 검증</span>
  <span class="kd">const</span> <span class="nx">ecsClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ECSClient</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ap-northeast-2</span><span class="dl">'</span> <span class="p">});</span>

  <span class="kd">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getService</span><span class="p">(</span><span class="nx">ecsClient</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">service</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">service</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">service</span><span class="p">.</span><span class="nx">desiredCount</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span>
  <span class="p">}</span>

  <span class="c1">////////// 2. desired count 1 처리</span>
  <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">cluster</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span>
    <span class="na">service</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">service</span><span class="p">,</span>
    <span class="na">desiredCount</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">};</span>

  <span class="k">await</span> <span class="nx">ecsClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="k">new</span> <span class="nc">UpdateServiceCommand</span><span class="p">(</span><span class="nx">params</span><span class="p">));</span>

  <span class="c1">////////// 3. EventBridge에 규칙 등록 (이미 등록되어 있는 경우 업데이트됨)</span>
  <span class="kd">const</span> <span class="nx">ruleName</span> <span class="o">=</span> <span class="s2">`ecs-monitor-</span><span class="p">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">cluster</span><span class="p">}</span><span class="s2">_</span><span class="p">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">service</span><span class="p">}</span><span class="s2">`</span>
  <span class="kd">const</span> <span class="nx">ruleParams</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">Name</span><span class="p">:</span> <span class="nx">ruleName</span><span class="p">,</span>
    <span class="na">EventPattern</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">({</span>
      <span class="na">source</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">aws.ecs</span><span class="dl">"</span><span class="p">],</span>
      <span class="dl">"</span><span class="s2">detail-type</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">ECS Service Action</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">resources</span><span class="p">:</span> <span class="p">[</span><span class="nx">service</span><span class="p">.</span><span class="nx">serviceArn</span><span class="p">],</span>
      <span class="na">detail</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">eventName</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">SERVICE_STEADY_STATE</span><span class="dl">'</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}),</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">eventBridgeClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EventBridgeClient</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ap-northeast-2</span><span class="dl">"</span> <span class="p">});</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">eventBridgeClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="k">new</span> <span class="nc">PutRuleCommand</span><span class="p">(</span><span class="nx">ruleParams</span><span class="p">));</span>

  <span class="c1">////////// 4. 규칙에 대한 타겟 설정</span>
  <span class="kd">const</span> <span class="nx">targetParams</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">Rule</span><span class="p">:</span> <span class="nx">ruleName</span><span class="p">,</span>
    <span class="na">Targets</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">Id</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">ruleName</span><span class="p">}</span><span class="s2">-target`</span><span class="p">,</span>
        <span class="na">Arn</span><span class="p">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">invokedFunctionArn</span><span class="p">,</span>
        <span class="na">Input</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">({</span>
          <span class="na">sourceLocation</span><span class="p">:</span> <span class="dl">'</span><span class="s1">EventBridge</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">eventName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">SERVICE_STEADY_STATE</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">clusterArn</span><span class="p">:</span> <span class="nx">service</span><span class="p">.</span><span class="nx">clusterArn</span><span class="p">,</span>
          <span class="na">serviceArn</span><span class="p">:</span> <span class="nx">service</span><span class="p">.</span><span class="nx">serviceArn</span><span class="p">,</span>
          <span class="na">albArn</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">albArn</span><span class="p">,</span>
          <span class="na">key</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">key</span>
        <span class="p">})</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>

  <span class="k">await</span> <span class="nx">eventBridgeClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="k">new</span> <span class="nc">PutTargetsCommand</span><span class="p">(</span><span class="nx">targetParams</span><span class="p">));</span>

  <span class="c1">////////// 5. lambda에 리소스 액세스 권한 부여</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">lambdaClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LambdaClient</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ap-northeast-2</span><span class="dl">"</span> <span class="p">});</span>
    <span class="kd">const</span> <span class="nx">addPermissionParams</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">Action</span><span class="p">:</span> <span class="dl">"</span><span class="s2">lambda:InvokeFunction</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">FunctionName</span><span class="p">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">functionName</span><span class="p">,</span>
      <span class="na">Principal</span><span class="p">:</span> <span class="dl">"</span><span class="s2">events.amazonaws.com</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">SourceArn</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">RuleArn</span><span class="p">,</span>
      <span class="na">StatementId</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">ruleName</span><span class="p">}</span><span class="s2">-permission`</span>
    <span class="p">};</span>

    <span class="k">await</span> <span class="nx">lambdaClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="k">new</span> <span class="nc">AddPermissionCommand</span><span class="p">(</span><span class="nx">addPermissionParams</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 권한이 이미 존재하는 경우 에러 발생 (StatementId 중복)</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">ResourceConflictException</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ...</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>순서는 다음과 같다.</p>
<ol>
<li>멈춰야 하는 서비스인지 검증한다.<ul><li>이미 ecs 서비스의 desired count가 1 이면 수행하지 않는다.</li></ul>
</li>
<li>ecs 서비스의 desired count를 1으로 변경한다.</li>
<li>
<code class="language-plaintext highlighter-rouge">EventBridge</code>에 규칙을 등록한다.<ul>
<li>detail type: ECS Service Action</li>
<li>event type: SERVICE_STEADY_STATE <a href="https://docs.aws.amazon.com/ko_kr/AmazonECS/latest/developerguide/ecs_service_events.html">참조</a>
</li>
</ul>
</li>
<li>등록한 규칙에 대한 타겟을 설정한다. 람다와 Input 데이터를 지정한다.</li>
<li>
<code class="language-plaintext highlighter-rouge">EventBridge</code> 규칙이 람다에 접근할 수 있도록 액세스 권한을 부여한다.<ul><li>이 작업은 최초 1회만 하면 되며 그 이후 동일한 작업 수행시 <code class="language-plaintext highlighter-rouge">ResourceConflictException</code> 에러가 발생한다.</li></ul>
</li>
</ol>
<p>이렇게 하면 ecs 서비스 태스크 수가 1이 된다. 그러나 실제 로드밸런서 리스너 규칙을 변경하지는 않는다. 물론 이 시점에서 폴링을 통해 태스크 상태를 검증하는 방법도 있지만 람다는 실행시간 만큼 요금이 부과되기 때문에 ecs 서비스가 안정적인 상태에 도달하면 람다를 다시 호출하는 이벤트를 <code class="language-plaintext highlighter-rouge">EventBridge</code>에 등록하는 방식을 선택했다.</p>
<h3 id="eventbridge-이벤트-규칙을-통해-전달된-이벤트-처리">
<span class="mr-2"><strong>EventBridge 이벤트 규칙을 통해 전달된 이벤트 처리</strong></span><a href="#eventbridge-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EA%B7%9C%EC%B9%99%EC%9D%84-%ED%86%B5%ED%95%B4-%EC%A0%84%EB%8B%AC%EB%90%9C-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EC%B2%98%EB%A6%AC" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>ecs 서비스의 태스크 수를 1로 변경하고 서비스가 안정적인 상태에 도달한다면, EventBridge에 등록해둔 <code class="language-plaintext highlighter-rouge">SERVICE_STEADY_STATE</code> 이벤트가 트리거되어 람다를 호출한다. 다음은 이를 핸들링하는 코드이다.</p>
<div class="language-javascript highlighter-rouge">
<div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">handleService</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">SERVICE_DATA</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">event</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">services</span><span class="p">:</span> <span class="p">[</span><span class="nx">event</span><span class="p">.</span><span class="nx">serviceArn</span><span class="p">],</span>
    <span class="na">cluster</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clusterArn</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">ecsClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ECSClient</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ap-northeast-2</span><span class="dl">'</span> <span class="p">});</span>
  <span class="kd">const</span> <span class="nx">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DescribeServicesCommand</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ecsClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">command</span><span class="p">);</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">services</span> <span class="o">||</span> <span class="nx">response</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">services</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="k">if </span><span class="p">(</span><span class="nx">service</span><span class="p">.</span><span class="nx">desiredCount</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">service</span><span class="p">.</span><span class="nx">loadBalancers</span> <span class="o">||</span> <span class="nx">service</span><span class="p">.</span><span class="nx">loadBalancers</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">targetChangeArns</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">albRuleArns</span>
  <span class="kd">const</span> <span class="nx">targetGroupArn</span> <span class="o">=</span> <span class="nx">service</span><span class="p">.</span><span class="nx">loadBalancers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">targetGroupArn</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">albClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ElasticLoadBalancingV2Client</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ap-northeast-2</span><span class="dl">'</span> <span class="p">})</span>

  <span class="kd">const</span> <span class="nx">describeResponse</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">albClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span>
    <span class="k">new</span> <span class="nc">DescribeRulesCommand</span><span class="p">({</span>
      <span class="na">RuleArns</span><span class="p">:</span> <span class="nx">targetChangeArns</span>
    <span class="p">})</span>
  <span class="p">);</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">describeResponse</span><span class="p">.</span><span class="nx">Rules</span> <span class="o">||</span> <span class="nx">describeResponse</span><span class="p">.</span><span class="nx">Rules</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">rule</span> <span class="o">=</span> <span class="nx">describeResponse</span><span class="p">.</span><span class="nx">Rules</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="c1">// 이미 라우팅이 정상인 경우 -&gt; 배포의 경우</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">Actions</span><span class="p">.</span><span class="nf">some</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">TargetGroupArn</span> <span class="o">===</span> <span class="nx">targetGroupArn</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">updatedActions</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">Actions</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">action</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="p">...</span><span class="nx">action</span><span class="p">,</span>
      <span class="na">TargetGroupArn</span><span class="p">:</span> <span class="nx">targetGroupArn</span><span class="p">,</span>
      <span class="na">ForwardConfig</span><span class="p">:</span> <span class="p">{</span>
        <span class="p">...</span><span class="nx">action</span><span class="p">.</span><span class="nx">ForwardConfig</span><span class="p">,</span>
        <span class="na">TargetGroups</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="na">TargetGroupArn</span><span class="p">:</span> <span class="nx">targetGroupArn</span><span class="p">,</span>
            <span class="na">Weight</span><span class="p">:</span> <span class="mi">1</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">});</span>

  <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">ruleArn</span> <span class="k">of</span> <span class="nx">targetChangeArns</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">albClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span>
      <span class="k">new</span> <span class="nc">ModifyRuleCommand</span><span class="p">({</span>
        <span class="na">RuleArn</span><span class="p">:</span> <span class="nx">ruleArn</span><span class="p">,</span>
        <span class="na">Actions</span><span class="p">:</span> <span class="nx">updatedActions</span>
      <span class="p">})</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>순서는 다음과 같다.</p>
<ol>
<li>넘어온 페이로드 의 key로 <code class="language-plaintext highlighter-rouge">SERVICE_DATA</code> 에서 필요한 데이터를 찾는다.</li>
<li>ecs 서비스의 desired count가 0 이면 수행하지 않는다.</li>
<li>이미 리스너 규칙이 올바른 대상 그룹으로 전달되고 있을 경우 수행하지 않는다.<ul><li>서비스가 배포되는 경우도 이 람다가 실행되기 때문에 추가된 조건이다.</li></ul>
</li>
<li>람다 대상그룹을 바라보고 있는 리스너 규칙을 ecs 서비스 태스크가 포함된 대상그룹으로 변경한다<ul>
<li>나의 경우 <code class="language-plaintext highlighter-rouge">CodeDeploy</code> 기반 배포를 진행하고 있고, 이는 2개의 대상그룹을 필요로 한다. 따라서 변경할 태스크 대상그룹은 하드코딩된 대상그룹이 아닌 ecs 서비스와 엮여있는 대상그룹으로 해야 한다.</li>
<li>
<code class="language-plaintext highlighter-rouge">Rolling Update</code> 기반 배포의 경우 대상그룹이 1개일 것이기 때문에 하드코딩된 대상그룹을 사용해도 무방하다.</li>
</ul>
</li>
</ol>
<h3 id="application-load-balancer-로부터-전달된-요청-처리">
<span class="mr-2"><strong>Application Load Balancer 로부터 전달된 요청 처리</strong></span><a href="#application-load-balancer-%EB%A1%9C%EB%B6%80%ED%84%B0-%EC%A0%84%EB%8B%AC%EB%90%9C-%EC%9A%94%EC%B2%AD-%EC%B2%98%EB%A6%AC" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>지금까지의 작업만 진행하면 업무 외 시간에는 서비스의 필요 태스크가 0이 되고 업무 시간이 다가오면 서비스의 필요 태스크가 1이 된다. 하지만 만약에 긴급하게 서비스를 이용해야할 경우는 어떻게 해야 할까? 이에 대해 내가 생각한 방법을 작성해보도록 한다.</p>
<h5 id="1-요청-검증하기">
<span class="mr-2"><strong>1. 요청 검증하기</strong></span><a href="#1-%EC%9A%94%EC%B2%AD-%EA%B2%80%EC%A6%9D%ED%95%98%EA%B8%B0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h5>
<p>앞서 서비스를 stop 할때, 리스너 규칙이 바라볼 대상을 람다로 변경했다. 업무 외 시간 긴급하게 서비스를 이용해야할 경우 이 람다로 요청이 전달될 것이다. 이 경우 서비스를 다시 시작해야 한다. 다만 2가지 고려사항이 있다.</p>
<ol>
<li>프로그램(봇) 에 의해 찔러본 요청인가?</li>
<li>실제 서비스 (Spring Boot) 에 존재하는 경로인가?</li>
</ol>
<p>1번의 경우 <code class="language-plaintext highlighter-rouge">CloudFront</code> 앞단에 <code class="language-plaintext highlighter-rouge">WAF</code> 를 배치하여 봇을 컨트롤 할 수 있다. 람다에서 직접 컨트롤 할 수도 있겠지만 내 경우 그냥 <code class="language-plaintext highlighter-rouge">WAF</code> 로 컨트롤하는 쪽을 선택했다.</p>
<p>2번의 경우 생각을 좀 해봤는데 내가 생각한 방법은 다음과 같다.</p>
<ol>
<li>
<code class="language-plaintext highlighter-rouge">@PostConstruct</code>를 이용하여 di가 끝난 후 앱 내에 있는 모든 경로를 검색해서 s3에 배열로 저장한다.</li>
<li>실제 람다가 호출되었을때 배열에 path와 일치하는 요소가 존재하는 경우만 서비스를 시작한다.</li>
</ol>
<p>다음은 모든 경로를 검색해서 s3에 업로드하는 코드이다. s3util 부분만 실제 올리는 로직으로 변경하면 될 것이다.</p>
<div class="language-java highlighter-rouge">
<div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td>
<td class="rouge-code"><pre><span class="nd">@Profile</span><span class="o">(</span><span class="s">"prod"</span><span class="o">)</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EndpointGenerator</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">RequestMappingHandlerMapping</span> <span class="n">requestMappingHandlerMapping</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">S3Util</span> <span class="n">s3Util</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">WebApplicationContext</span> <span class="n">webApplicationContext</span><span class="o">;</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">JsonProcessingException</span> <span class="o">{</span>

        <span class="kt">var</span> <span class="n">patterns</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
        <span class="kt">var</span> <span class="n">contextPath</span> <span class="o">=</span> <span class="n">webApplicationContext</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getContextPath</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">info</span> <span class="o">:</span> <span class="n">requestMappingHandlerMapping</span><span class="o">.</span><span class="na">getHandlerMethods</span><span class="o">().</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">patternWithContext</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">getPatternValues</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">pattern</span> <span class="o">-&gt;</span> <span class="n">contextPath</span> <span class="o">+</span> <span class="n">pattern</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

            <span class="n">patterns</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">patternWithContext</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">s3Util</span><span class="o">.</span><span class="na">upload</span><span class="o">(</span>
                <span class="s">"keencho-bucket"</span><span class="o">,</span>
                <span class="s">"admin.json"</span><span class="o">,</span>
                    <span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">patterns</span><span class="o">)</span>
                <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<h5 id="2-시작하기">
<span class="mr-2"><strong>2. 시작하기</strong></span><a href="#2-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h5>
<p>이제 실제 시작에 필요한 코드를 작성해보자. 로드밸런서의 요청을 처리해야 하기 때문에 그에 맞는 형식을 리턴할 필요가 있다.</p>
<div class="language-javascript highlighter-rouge">
<div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">buildResponse</span> <span class="o">=</span> <span class="p">(</span><span class="nx">success</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="na">statusCode</span><span class="p">:</span> <span class="nx">success</span> <span class="p">?</span> <span class="mi">200</span> <span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
    <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">errorResponse</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nf">buildResponse</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Invalid access</span><span class="dl">'</span> <span class="p">})</span>

<span class="kd">const</span> <span class="nx">successResponse</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nf">buildResponse</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{</span> <span class="na">success</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>

<span class="kd">const</span> <span class="nx">handleAlb</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">/////////////////////////////////////// 헬스 체크</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">path</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">/health-check</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">statusCode</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="na">statusDescription</span><span class="p">:</span> <span class="dl">"</span><span class="s2">OK</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">isBase64Encoded</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">errorResponse</span><span class="p">()</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="kd">const</span> <span class="nx">isValidRoute</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="kd">const</span> <span class="nx">patternToRegex</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">regexPattern</span> <span class="o">=</span> <span class="nx">pattern</span>
      <span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\/</span><span class="sr">/g</span><span class="p">,</span> <span class="dl">'</span><span class="se">\\</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span> <span class="c1">// 슬래시 이스케이프</span>
      <span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\*\*</span><span class="sr">/g</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.*</span><span class="dl">'</span><span class="p">)</span> <span class="c1">// ** 패턴을 .* (모든 문자, 여러 개)로 변환</span>
      <span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/{</span><span class="se">([^</span><span class="sr">}</span><span class="se">]</span><span class="sr">+</span><span class="se">)</span><span class="sr">}/g</span><span class="p">,</span> <span class="dl">'</span><span class="s1">([^/]+)</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// {변수} 패턴을 캡처 그룹으로 변환</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nc">RegExp</span><span class="p">(</span><span class="s2">`^</span><span class="p">${</span><span class="nx">regexPattern</span><span class="p">}</span><span class="s2">$`</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">S3Client</span><span class="p">({});</span>

  <span class="kd">const</span> <span class="nx">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetObjectCommand</span><span class="p">({</span>
    <span class="na">Bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">keencho-bucket</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">Key</span><span class="p">:</span> <span class="nx">type</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">.json</span><span class="dl">'</span>
  <span class="p">})</span>

  <span class="kd">const</span> <span class="nx">responseData</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">command</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">str</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">responseData</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">transformToString</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>

  <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">route</span> <span class="k">of</span> <span class="nx">routes</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">regex</span> <span class="o">=</span> <span class="nf">patternToRegex</span><span class="p">(</span><span class="nx">route</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">regex</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">handle</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">SERVICE_DATA</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">host</span> <span class="o">===</span> <span class="nx">host</span><span class="p">);</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">errorResponse</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">key</span>

  <span class="c1">////////// 1. 검증</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">type</span> <span class="o">||</span> <span class="o">!</span><span class="k">await</span> <span class="nf">isValidRoute</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">event</span><span class="p">?.</span><span class="nx">headers</span><span class="p">?.</span><span class="nx">referer</span><span class="p">?.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">host</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">errorResponse</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="c1">////////// 2. desired count 이미 1 이상인지 확인</span>
  <span class="kd">const</span> <span class="nx">ecsClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ECSClient</span><span class="p">({</span><span class="na">region</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ap-northeast-2</span><span class="dl">'</span><span class="p">});</span>
  <span class="kd">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getService</span><span class="p">(</span><span class="nx">ecsClient</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">service</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">service</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">errorResponse</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="c1">// 이미 시작된 경우라고 간주함.</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">service</span><span class="p">.</span><span class="nx">desiredCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">successResponse</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">////////// 3. desire task 1 처리</span>
  <span class="k">await</span> <span class="nf">start</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>

  <span class="k">return</span> <span class="nf">successResponse</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>순서는 다음과 같다.</p>
<ol>
<li>데이터를 검증한다.<ul>
<li>
<code class="language-plaintext highlighter-rouge">isValidRoute()</code> 메소드를 통해 유효한 경로인지 검증한다. <code class="language-plaintext highlighter-rouge">@PathVariable</code>를 사용한 경로일 수 있으므로 그에대한 정규식이 필요하다.</li>
<li>동일 출처인지 검증한다. 어짜피 따로 허용하는 코드를 작성하지 않았으므로 에러가 발생할 테지만 명시적으로 검증한다.</li>
</ul>
</li>
<li>ecs 서비스의 desired count가 0보다 크면 수행하지 않는다.</li>
<li>앞서 작성한 <code class="language-plaintext highlighter-rouge">start()</code> 함수를 호출한다.</li>
<li>성공 응답을 리턴한다.</li>
</ol>
<p>이미 검증을 했으므로 <code class="language-plaintext highlighter-rouge">start()</code> 메소드에서 또 검증할 필요는 없다. 불필요한 호출을 막는 로직을 추가하면 좋을것 같다. (여기선 하지 않는다.)</p>
<p>이후 태스크가 시작되면 EventBridge에 등록해둔 <code class="language-plaintext highlighter-rouge">SERVICE_STEADY_STATE</code>가 트리거되고 앞서 살펴본 <a href="#eventbridge-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EA%B7%9C%EC%B9%99%EC%9D%84-%ED%86%B5%ED%95%B4-%EC%A0%84%EB%8B%AC%EB%90%9C-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EC%B2%98%EB%A6%AC">이벤트 처리 로직</a> 에 의해 처리된다.</p>
<h2 id="결론">
<span class="mr-2"><strong>결론</strong></span><a href="#%EA%B2%B0%EB%A1%A0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>현재 사내 시스템(관리자)과 테스트서버 에만 위 아키텍처를 적용하고 있다. 테스트서버의 경우 새벽시간대에 시작하는 로직이 빠져있다. 그냥 무조건 업무시간에만 쓰도록 한 것이다.</p>
<p>코드나 로직은 조금 보완해야 겠지만 예상대로 돌아감에 만족한다. 추가로 이 포스팅에 작성하진 않았지만 중지 시간대에 다음과 같이 UI가 구성되어 있으면 좋을것이다. <img data-src="/assets/img/custom/aws-fargate-dynamic-operation/3.png" alt="3" data-proofer-ignore></p>
<p>내 경우 서비스 유지기간인 경우 아예 별도의 페이지로 redirect 시키고 시작해야할 서비스면 서비스를 시작시키고 상태를 <code class="language-plaintext highlighter-rouge">START</code>, <code class="language-plaintext highlighter-rouge">PROCESSING</code>, <code class="language-plaintext highlighter-rouge">COMPLETED</code> 3단계로 간단하게 나누어 확인할 수 있도록 하고 시작하지 않아야 할 서비스면 위와 같은 화면이 보이도록 UI를 구성했다.</p>
<p><a href="https://aws.amazon.com/ko/solutions/implementations/instance-scheduler-on-aws/">Instance Scheduler</a> 이라는 솔루션이 존재하긴 하는데 이는 ECS Fargate 대상으로는 자동화 못하는거 같아 <code class="language-plaintext highlighter-rouge">EventBridge + Lambda</code> 조합으로 직접 구현해 봤다. 덕분에 리소스 비용이 조금이나마 절감되어 좋은듯 하다.</p>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="/categories/aws/">AWS</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration">AWS</a> <a href="/tags/devops/" class="post-tag no-text-decoration">DevOps</a>
</div>
<div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div>
<div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%EC%95%BC%EA%B0%84+%EB%B0%8F+%EC%A3%BC%EB%A7%90%EC%97%90+AWS+Fargate+%EB%8F%99%EC%A0%81%EC%9C%BC%EB%A1%9C+%EC%9A%B4%EC%98%81%ED%95%98%EA%B8%B0+-+keencho%27s+blog&amp;url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Faws-fargate-dynamic-operation%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%EC%95%BC%EA%B0%84+%EB%B0%8F+%EC%A3%BC%EB%A7%90%EC%97%90+AWS+Fargate+%EB%8F%99%EC%A0%81%EC%9C%BC%EB%A1%9C+%EC%9A%B4%EC%98%81%ED%95%98%EA%B8%B0+-+keencho%27s+blog&amp;u=https%3A%2F%2Fkeencho.github.io%2Fposts%2Faws-fargate-dynamic-operation%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Faws-fargate-dynamic-operation%2F&amp;text=%EC%95%BC%EA%B0%84+%EB%B0%8F+%EC%A3%BC%EB%A7%90%EC%97%90+AWS+Fargate+%EB%8F%99%EC%A0%81%EC%9C%BC%EB%A1%9C+%EC%9A%B4%EC%98%81%ED%95%98%EA%B8%B0+-+keencho%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span>
</div>
</div>
</div>
</div></div>
<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">
<div class="access">
<div id="access-lastmod" class="post">
<div class="panel-heading">Recently Updated</div>
<ul class="post-content pl-0 pb-1 ml-1 mt-2">
<li><a href="/posts/jpa-flush/">JPA &amp; Hibernate Flush Mode</a></li>
<li><a href="/posts/aws-cicd-1/">AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 1. 개요</a></li>
<li><a href="/posts/terraform-aws-infra-6/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)</a></li>
<li><a href="/posts/aapt2-arm/">Arm 아키텍처에서 AAPT2 빌드 도구 사용하기</a></li>
<li><a href="/posts/terraform-aws-infra-1/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 1. 개요</a></li>
</ul>
</div>
<div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5">
<div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
<nav id="toc" data-toggle="toc"></nav>
</div>
</div>
</div>
<div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4">
<div id="related-posts" class="mt-5 mb-2 mb-sm-4">
<h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
<div class="card-deck mb-4">
<div class="card"> <a href="/posts/aws-cicd-1/"><div class="card-body"> <em class="small" data-ts="1624271520" data-df="ll"> Jun 21, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 1. 개요</h3>
<div class="text-muted small"><p> AWS를 사용해 무중단 배포 자동화 환경 구축하기 시리즈 개요 VPC와 기본 리소스 VPC와 기본 리소스 생성하기 어플리케이션 구축 및 로드밸런서 적용 AWS 리소스 세팅 CodeDeploy 연동 / 마무리 개요 AWS를 이용하여 가장 기본적인 형태의 인프라를 구축하고 GithubAction - CodeDeploy 를 이용하...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/aws-cicd-2/"><div class="card-body"> <em class="small" data-ts="1624360320" data-df="ll"> Jun 22, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 2. VPC와 기본 리소스</h3>
<div class="text-muted small"><p> AWS를 사용해 무중단 배포 자동화 환경 구축하기 시리즈 개요 VPC와 기본 리소스 VPC와 기본 리소스 생성하기 어플리케이션 구축 및 로드밸런서 적용 AWS 리소스 세팅 CodeDeploy 연동 / 마무리 VPC와 기본 리소스 서버 구축의 첫번째 단계로 AWS의 VPC (Virtual Private Cloud) 와 기본 리...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/aws-cicd-3/"><div class="card-body"> <em class="small" data-ts="1624670880" data-df="ll"> Jun 26, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 3. VPC와 기본 리소스 생성하기</h3>
<div class="text-muted small"><p> AWS를 사용해 무중단 배포 자동화 환경 구축하기 시리즈 개요 VPC와 기본 리소스 VPC와 기본 리소스 생성하기 어플리케이션 구축 및 로드밸런서 적용 AWS 리소스 세팅 CodeDeploy 연동 / 마무리 VPC와 기본 리소스 생성하기 AWS 콘솔을 사용해 직접 VPC와 필요한 리소스들을 생성해 보겠습니다. VPC 생성하...</p></div>
</div></a>
</div>
</div>
</div>
<div class="post-navigation d-flex justify-content-between"> <a href="/posts/aapt2-arm/" class="btn btn-outline-primary" prompt="Older"><p>Arm 아키텍처에서 AAPT2 빌드 도구 사용하기</p></a> <a href="/posts/aws-alb-static-ip/" class="btn btn-outline-primary" prompt="Newer"><p>Application Load Balancer에 고정 IP 사용하기 (feat. VPC IPAM 통합)</p></a>
</div>
</div></div>
<footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0">
<div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/keencho">keencho</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div>
<div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div>
</div></footer>
</div>
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content">
<div id="search-hints"><div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a>
</div>
</div></div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false">
<div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">×</span> </button>
</div>
<div class="toast-body text-center pt-0">
<p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
<button type="button" class="btn btn-primary" aria-label="Update"> Update </button>
</div>
</div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
