<!DOCTYPE html><html lang="ko-KS" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (2)" /><meta name="author" content="keencho" /><meta property="og:locale" content="ko_KS" /><meta name="description" content="QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (2) - 개발 과정, 코드" /><meta property="og:description" content="QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (2) - 개발 과정, 코드" /><link rel="canonical" href="https://keencho.github.io/posts/querydsl-qbuilder-qsetter-2/" /><meta property="og:url" content="https://keencho.github.io/posts/querydsl-qbuilder-qsetter-2/" /><meta property="og:site_name" content="keencho’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-02T07:12:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (2)" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@keencho" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"keencho"},"dateModified":"2023-04-08T11:13:19+09:00","datePublished":"2022-10-02T07:12:00+09:00","description":"QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (2) - 개발 과정, 코드","headline":"QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (2)","mainEntityOfPage":{"@type":"WebPage","@id":"https://keencho.github.io/posts/querydsl-qbuilder-qsetter-2/"},"url":"https://keencho.github.io/posts/querydsl-qbuilder-qsetter-2/"}</script><title>QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (2) | keencho's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="keencho's blog"><meta name="application-name" content="keencho's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end">
<div class="profile-wrapper text-center">
<div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/custom/keencho.jpg" alt="avatar" onerror="this.style.display='none'"> </a>
</div>
<div class="site-title mt-3"> <a href="/">keencho's blog</a>
</div>
<div class="site-subtitle font-italic">이것저것 정리하는 블로그.</div>
</div>
<ul class="w-100">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a>
</li>
<li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a>
</li>
</ul>
<div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/keencho" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20['seyoung050412','gmail.com'].join('@')" aria-label="email"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> </a>
</div>
</div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (2)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div>
<i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel">Cancel</span>
</div></div><div id="main-wrapper" class="d-flex justify-content-center">
<div id="main" class="container pl-xl-4 pr-xl-4">
<div class="row">
<div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2">
<h1 data-toc-skip>QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (2)</h1>
<div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1664662320" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 2, 2022 </em> </span><div class="d-flex justify-content-between"> <span> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2491 words"> <em>13 min</em> read</span>
</div>
</div>
</div>
<div class="post-content">
<h1 id="queryprojection-에서-한단계-더-나아가-queryprojectionbuilder-만들기-2---개발-과정-코드"><strong>QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (2) - 개발 과정, 코드</strong></h1>
<blockquote><p>이 포스팅에서 설명하는 코드는 한 프로젝트 내에서 사용할 수 없습니다.<br> 라이브러리 프로젝트 A, 실제 어플리케이션 프로젝트 B 로 나뉘어야 합니다.<br> java17, maven 을 사용합니다.</p></blockquote>
<h2 id="1-queryprojection-으로-생성되는-클래스-분석">
<span class="mr-2"><strong>1. @QueryProjection 으로 생성되는 클래스 분석</strong></span><a href="#1-queryprojection-%EC%9C%BC%EB%A1%9C-%EC%83%9D%EC%84%B1%EB%90%98%EB%8A%94-%ED%81%B4%EB%9E%98%EC%8A%A4-%EB%B6%84%EC%84%9D" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>클래스를 프로젝션 타입으로 사용하기 위해 우리는 클래스 생성자에 @QueryProjection 어노테이션을 붙이고 Q 클래스를 생성합니다. 생성되는 Q 클래스는 다음과 같습니다.</p>
<div class="language-java highlighter-rouge">
<div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
<td class="rouge-code"><pre><span class="cm">/**
 * com.keencho.libormtest.model.QCustomerDTO is a Querydsl Projection type for CustomerDTO
 */</span>
<span class="nd">@Generated</span><span class="o">(</span><span class="s">"com.querydsl.codegen.DefaultProjectionSerializer"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QCustomerDTO</span> <span class="kd">extends</span> <span class="nc">ConstructorExpression</span><span class="o">&lt;</span><span class="nc">CustomerDTO</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">785800583L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">QCustomerDTO</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">querydsl</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">types</span><span class="o">.</span><span class="na">Expression</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">id</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">querydsl</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">types</span><span class="o">.</span><span class="na">Expression</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">loginId</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">querydsl</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">types</span><span class="o">.</span><span class="na">Expression</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">password</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">querydsl</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">types</span><span class="o">.</span><span class="na">Expression</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">name</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">querydsl</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">types</span><span class="o">.</span><span class="na">Expression</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="nc">CustomerDTO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]{</span><span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="n">id</span><span class="o">,</span> <span class="n">loginId</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p><img data-src="/assets/img/custom/querydsl-builder-projection/ConstructorExpression.jpg" alt="ConstructorExpression" data-proofer-ignore></p>
<p><code class="language-plaintext highlighter-rouge">ConstructorExpression</code> 클래스를 상속하는 것을 확인할 수 있습니다. 해당 클래스의 생성자를 살펴봅시다. 생성자의 인자로 제네릭 클래스 타입과 프로젝션의 타입을 담은 배열, 그리고 프로젝션의 값을 인자로 받고 있는 것을 확인할 수 있습니다.</p>
<p><img data-src="/assets/img/custom/querydsl-builder-projection/ConstructorExpressionConstructor.JPG" alt="ConstructorExpressionConstructor" data-proofer-ignore></p>
<p>아래로 내래보면 <code class="language-plaintext highlighter-rouge">newInstance(Object... args)</code> 라는 메소드를 확인할 수 있습니다. 이 메소드가 바로 프로젝션을 생성하는 메소드 입니다.</p>
<p><img data-src="/assets/img/custom/querydsl-builder-projection/newInstance.JPG" alt="newInstance" data-proofer-ignore></p>
<p>생성자와 메소드를 통해 어떻게 생성자를 통해 조회 결과를 반환 받을수 있는지 확인할 수 있습니다.</p>
<h2 id="2-새로운-expression-클래스-만들기">
<span class="mr-2"><strong>2. 새로운 Expression 클래스 만들기</strong></span><a href="#2-%EC%83%88%EB%A1%9C%EC%9A%B4-expression-%ED%81%B4%EB%9E%98%EC%8A%A4-%EB%A7%8C%EB%93%A4%EA%B8%B0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>위에서 살펴본 <code class="language-plaintext highlighter-rouge">ConstructorExpression</code> 은 어디까지나 클래스의 모든 필드를 매개변수로 갖는 생성자를 위한 조회 방식이기 때문에 빌더패턴을 사용할 수 없습니다. <code class="language-plaintext highlighter-rouge">FactoryExpressionBase</code> 클래스를 상속하는 새로운 프로젝션 클래스를 만드는게 낫겠네요.</p>
<div class="language-java highlighter-rouge">
<div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
<td class="rouge-code"><pre> <span class="kd">public</span> <span class="nf">KcExpression</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Expression</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">bindings</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">bindings</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">bindings</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"bindings must not be null or empty!"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">this</span><span class="o">.</span><span class="na">bindings</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableMap</span><span class="o">(</span>
            <span class="n">bindings</span>
                    <span class="o">.</span><span class="na">entrySet</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">entry</span> <span class="o">-&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toMap</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">::</span><span class="n">getKey</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">::</span><span class="n">getValue</span><span class="o">,</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">y</span><span class="o">,</span> <span class="nl">LinkedHashMap:</span><span class="o">:</span><span class="k">new</span><span class="o">))</span>
    <span class="o">);</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>프로젝션 클래스의 생성자 입니다. 클래스 타입과 <code class="language-plaintext highlighter-rouge">Map&lt;String, Expression&lt;?&gt;&gt;</code>을 매개변수로 받습니다. 전달받은 map에서 null값을 제외하고 순서를 보장하는 <code class="language-plaintext highlighter-rouge">LinkedHashMap</code>으로 다시 생성하여 bindings 변수에 할당합니다.</p>
<div class="language-java highlighter-rouge">
<div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
<td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="no">T</span> <span class="nf">newInstance</span><span class="o">(</span><span class="nc">Object</span><span class="o">...</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">bindings</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">toArray</span><span class="o">();</span>

        <span class="kt">var</span> <span class="n">rv</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">().</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">value</span> <span class="o">=</span> <span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">var</span> <span class="n">field</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">arr</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
                <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">rv</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">rv</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InstantiationException</span> <span class="o">|</span> <span class="nc">IllegalAccessException</span> <span class="o">|</span> <span class="nc">NoSuchFieldException</span> <span class="o">|</span> <span class="nc">InvocationTargetException</span> <span class="o">|</span> <span class="nc">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExpressionException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p><code class="language-plaintext highlighter-rouge">newInstance</code> 메소드에서는 리플렉션으로 빈 생성자를 생성하고 값이 넘어온 순서대로 필드에 값을 저정합니다. 문제는 이 메소에는 필드의 정보나 타입같은건 넘어오지 않는다는 점입니다.<br> 오직 <code class="language-plaintext highlighter-rouge">Object...</code> 형식으로 순수한 값만 넘어오기 때문에 현재 넘어오는 값이 어떠한 필드에 매핑되는지 알 수 없습니다. 그래도 다행인 것은 값이 필드 순서대로 넘어온다는 것입니다.</p>
<p>제가 위에서 순서를 보장하는 <code class="language-plaintext highlighter-rouge">LinkedHashMap</code>을 사용했던 것은 위와같은 이유 때문입니다. 물론 애초에 이 클래스가 생성되는 시점에도 순서가 보장된 map을 파라미터로 넘겨야 합니다. 메소드에 넘어오는 값이 순서를 보장하기 때문에 클래스의 필드정보를 담고 있는 map 객체의 요소가 반환받을 클래스의 필드 선언 순서와 동일하다면 문제없이 반환받을 클래스에 값을 저장하고 넘겨받을 수 있겠죠.</p>
<h2 id="3-record를-반환-받을-수-있는-expression-만들기">
<span class="mr-2"><strong>3. record를 반환 받을 수 있는 Expression 만들기</strong></span><a href="#3-record%EB%A5%BC-%EB%B0%98%ED%99%98-%EB%B0%9B%EC%9D%84-%EC%88%98-%EC%9E%88%EB%8A%94-expression-%EB%A7%8C%EB%93%A4%EA%B8%B0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>위에서 만든 Expression 클래스에는 문제가 하나 있습니다. 빈 생성자를 만들고 그 이후에 값을 세팅하는 방식이기 때문에 빈 생성자가 존재할 수 없는 <code class="language-plaintext highlighter-rouge">record</code> 타입의 클래스는 사용할 수 없습니다.</p>
<p>이를 위해 <code class="language-plaintext highlighter-rouge">record</code> 클래스 에 사용할 Expression 클래스는 따로 만들도록 하겠습니다.</p>
<div class="language-java highlighter-rouge">
<div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td>
<td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">KcRecordExpression</span><span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">Record</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">KcExpression</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">KcRecordExpression</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Expression</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">bindings</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">bindings</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">type</span><span class="o">.</span><span class="na">isRecord</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"This expression is an expression for record. Use KcExpression to bind a regular class."</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="no">T</span> <span class="nf">newInstance</span><span class="o">(</span><span class="nc">Object</span><span class="o">...</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">getDeclaredFields</span><span class="o">().</span><span class="na">length</span> <span class="o">!=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Because a record type must create an object as a constructor that accepts all variables as arguments, the number of declared fields and the number of parameters to bind must be the same."</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">getBindings</span><span class="o">().</span><span class="na">keySet</span><span class="o">().</span><span class="na">toArray</span><span class="o">();</span>
            <span class="kt">var</span> <span class="n">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Field</span><span class="o">[</span><span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fields</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
                <span class="n">fields</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">arr</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>

            <span class="kt">var</span> <span class="n">matchedConstructor</span> <span class="o">=</span> <span class="nc">Arrays</span>
                    <span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">getConstructors</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">constructor</span> <span class="o">-&gt;</span> <span class="o">{</span>
                        <span class="kt">var</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">constructor</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
                        <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
                            <span class="kt">var</span> <span class="n">constructorType</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
                            <span class="kt">var</span> <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
                            <span class="k">if</span> <span class="o">(!</span><span class="n">constructorType</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">getTypeName</span><span class="o">()))</span> <span class="o">{</span>
                                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>

                        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}).</span><span class="na">toList</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">matchedConstructor</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"No or more than one constructor exists with the same number and type of parameters. It seems record is not suitable for this case."</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kt">var</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">matchedConstructor</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExpressionException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>클래스 생성 시점에 타입이 <code class="language-plaintext highlighter-rouge">record</code> 타입인지 검사합니다.</p>
<p><code class="language-plaintext highlighter-rouge">newInstance</code> 메소드에는 방어 코드가 존재합니다. 첫째로 반환받을 <code class="language-plaintext highlighter-rouge">record</code> 클래스의 필드 갯수와 메소드에 넘어온 파라미터의 갯수가 똑같아야 합니다. 클래스 내에 있는 모든 변수들을 인수로 받을 생성자를 만들어야 하기 때문에 당연합니다.</p>
<p>둘째로 사용할 생성자가 명확해야 합니다. <code class="language-plaintext highlighter-rouge">record</code> 클래스 내에도 생성자는 여러개 존재할 수 있습니다. 그러나 여기서 사용할 생성자는 자바가 기본으로 만들어주는 모든 변수를 인수로 갖는 생성자여야 합니다. 따라서 값의 타입과 매개변수의 타입, 생성자 매개변수의 숫자를 검증하여 생성자의 조건과 일치하는 단 하나의 생성자만을 사용하도록 하였습니다.</p>
<h2 id="4-annotationprocessor-만들기">
<span class="mr-2"><strong>4. AnnotationProcessor 만들기</strong></span><a href="#4-annotationprocessor-%EB%A7%8C%EB%93%A4%EA%B8%B0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>커스텀 어노테이션을 만들고 해당 어노테이션이 붙어있는 클래스를 위에서 만든 프로젝션 클래스를 상속하는 클래스로써 새롭게 만들기 위해 AnnotationProcessor를 만들어야 합니다.</p>
<p>첫째로 클래스 위에 붙일 어노테이션 입니다.</p>
<div class="language-java highlighter-rouge">
<div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td>
<td class="rouge-code"><pre><span class="nd">@Documented</span>
<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="no">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">KcQueryProjection</span> <span class="o">{</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>다음은 <code class="language-plaintext highlighter-rouge">AbstractProcessor</code>를 상속하는 AnnotationProcessor 클래스 입니다. 전체 코드는 이 글 하단의 링크에서 확인하실 수 있습니다.</p>
<p>뭔가 특별한 방식이 있을것 같지만 전 그냥 다음과 같이 무식하게 작성하였습니다.</p>
<p><img data-src="/assets/img/custom/querydsl-builder-projection/annotation-processor.JPG" alt="annotation-processor" data-proofer-ignore></p>
<p>여기서 중요한 점은 세가지 입니다.</p>
<ol>
<li>현재 클래스가 <code class="language-plaintext highlighter-rouge">record</code> 인지 일반 클래스인지 구분 -&gt; Expression 클래스가 다름</li>
<li>제네릭 타입으로 원시 타입을 사용할 수 없기 때문에 원시 타입을 참조 타입으로 변경</li>
<li>바인딩 map 객체를 만들때는 순서를 보장하는 <code class="language-plaintext highlighter-rouge">LinkedHashMap</code> 사용 (위에서 설명)</li>
</ol>
<p>이제 현재 프로젝트가 AnnotationProcessor로써 동작하게 하기 위해 추가로 필요한 작업을 진행합니다.</p>
<ol>
<li>resources/META-INF/services/javax.annotation.processing.Processor 파일에 AnnotationProcessor 클래스 명시</li>
<li>pom.xml 에 아래 플러그인을 추가하여 컴파일러가 현재 프로젝트를 컴파일할때 annotation processing 작업을 건너 뛰도록 함</li>
</ol>
<p><img data-src="/assets/img/custom/querydsl-builder-projection/proc-none.JPG" alt="proc-none" data-proofer-ignore></p>
<p>필요한 작업을 진행하였다면 다음 명령어를 실행하여 local maven repository에 현재 프로젝트가 배포될 수 있도록 합니다.</p>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre>clean install -DskipTests
</pre></td>
</tr></tbody></table></code></div>
</div>
<h2 id="5-테스트">
<span class="mr-2"><strong>5. 테스트</strong></span><a href="#5-%ED%85%8C%EC%8A%A4%ED%8A%B8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>이제 새로운 프로젝트를 하나 만들고 위에서 만든 작업물을 테스트해 보도록 하겠습니다.</p>
<p>배포된 프로젝트와 <code class="language-plaintext highlighter-rouge">querydsl-apt</code>를 의존성에 추가하고 <code class="language-plaintext highlighter-rouge">maven compiler plugin</code>을 추가하고 annotationProcessor를 등록합니다.</p>
<div class="language-xml highlighter-rouge">
<div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td>
<td class="rouge-code"><pre><span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
        <span class="nt">&lt;plugin&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.11.0<span class="nt">&lt;/version&gt;</span>

            <span class="nt">&lt;configuration&gt;</span>
                <span class="nt">&lt;source&gt;</span>17<span class="nt">&lt;/source&gt;</span>
                <span class="nt">&lt;target&gt;</span>17<span class="nt">&lt;/target&gt;</span>

                <span class="nt">&lt;generatedSourcesDirectory&gt;</span>target/generated-sources/querydsl<span class="nt">&lt;/generatedSourcesDirectory&gt;</span>
                <span class="nt">&lt;annotationProcessors&gt;</span>
                    <span class="nt">&lt;annotationProcessor&gt;</span>
                        com.querydsl.apt.jpa.JPAAnnotationProcessor
                    <span class="nt">&lt;/annotationProcessor&gt;</span>
                    <span class="nt">&lt;annotationProcessor&gt;</span>
                        com.keencho.querydsl.KcQuerydslAnnotationProcessor
                    <span class="nt">&lt;/annotationProcessor&gt;</span>
                <span class="nt">&lt;/annotationProcessors&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>이제 반환받기 원하는 class, record에 어노테이션을 붙이고 프로젝트를 컴파일 합니다.</p>
<blockquote><p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> 프로젝션 클래스에서 빈 생성자를 필요로 하기 때문에 아래 어노테이션이 붙은 클래스에는 빈 생성자가 필수로 존재해야 합니다. (없다면 NoSuchMethodException 발생)</p></blockquote>
<div class="language-java highlighter-rouge">
<div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="nd">@KcQueryProjection</span>
<span class="kd">public</span> <span class="kd">record</span> <span class="nf">CustomerRecord</span><span class="o">(</span>
        <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">loginId</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">password</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">name</span>
<span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>테스트 코드를 작성하고 테스트를 수행합니다.</p>
<div class="language-java highlighter-rouge">
<div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td>
<td class="rouge-code"><pre><span class="kt">var</span> <span class="n">q</span> <span class="o">=</span> <span class="nc">QCustomer</span><span class="o">.</span><span class="na">customer</span><span class="o">;</span>

<span class="kt">var</span> <span class="n">predicate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BooleanBuilder</span><span class="o">();</span>
<span class="n">predicate</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"1"</span><span class="o">));</span>

<span class="kt">var</span> <span class="n">bindings</span> <span class="o">=</span> <span class="nc">KcQCustomerDTO</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
        <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">name</span><span class="o">)</span>
        <span class="o">.</span><span class="na">loginId</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">loginId</span><span class="o">)</span>
        <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">password</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="kt">var</span> <span class="n">list</span> <span class="o">=</span> <span class="n">jpaQueryFactory</span>
        <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">bindings</span><span class="o">)</span>
        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">q</span><span class="o">)</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">predicate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">loginId</span><span class="o">.</span><span class="na">asc</span><span class="o">())</span>
        <span class="o">.</span><span class="na">fetch</span><span class="o">();</span>

<span class="kt">var</span> <span class="n">bindings2</span> <span class="o">=</span> <span class="nc">KcQCustomerRecord</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
        <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">name</span><span class="o">)</span>
        <span class="o">.</span><span class="na">loginId</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">loginId</span><span class="o">)</span>
        <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">password</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="kt">var</span> <span class="n">list2</span> <span class="o">=</span> <span class="n">jpaQueryFactory</span>
        <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">bindings2</span><span class="o">)</span>
        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">q</span><span class="o">)</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">predicate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">loginId</span><span class="o">.</span><span class="na">asc</span><span class="o">())</span>
        <span class="o">.</span><span class="na">fetch</span><span class="o">();</span>

<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">list2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">name</span><span class="o">()));</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getPassword</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">list2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">password</span><span class="o">()));</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">list2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">id</span><span class="o">()));</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getLoginId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">list2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">loginId</span><span class="o">()));</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<h1 id="코드-확인"><strong>코드 확인</strong></h1>
<p>전체 코드는 <a href="https://github.com/keencho/java-sandbox/tree/master/blog-example-code/querydsl-builder-projection">이곳</a> 에서 확인하실 수 있습니다.</p>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="/categories/querydsl/">QueryDSL</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration">Java</a> <a href="/tags/jpa/" class="post-tag no-text-decoration">JPA</a> <a href="/tags/querydsl/" class="post-tag no-text-decoration">QueryDSL</a>
</div>
<div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div>
<div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=QueryProjection+%EC%97%90%EC%84%9C+%ED%95%9C%EB%8B%A8%EA%B3%84+%EB%8D%94+%EB%82%98%EC%95%84%EA%B0%80+QueryProjectionBuilder+%EB%A7%8C%EB%93%A4%EA%B8%B0+%282%29+-+keencho%27s+blog&amp;url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fquerydsl-qbuilder-qsetter-2%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=QueryProjection+%EC%97%90%EC%84%9C+%ED%95%9C%EB%8B%A8%EA%B3%84+%EB%8D%94+%EB%82%98%EC%95%84%EA%B0%80+QueryProjectionBuilder+%EB%A7%8C%EB%93%A4%EA%B8%B0+%282%29+-+keencho%27s+blog&amp;u=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fquerydsl-qbuilder-qsetter-2%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fquerydsl-qbuilder-qsetter-2%2F&amp;text=QueryProjection+%EC%97%90%EC%84%9C+%ED%95%9C%EB%8B%A8%EA%B3%84+%EB%8D%94+%EB%82%98%EC%95%84%EA%B0%80+QueryProjectionBuilder+%EB%A7%8C%EB%93%A4%EA%B8%B0+%282%29+-+keencho%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span>
</div>
</div>
</div>
</div></div>
<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">
<div class="access">
<div id="access-lastmod" class="post">
<div class="panel-heading">Recently Updated</div>
<ul class="post-content pl-0 pb-1 ml-1 mt-2">
<li><a href="/posts/jpa-flush/">JPA &amp; Hibernate Flush Mode</a></li>
<li><a href="/posts/aws-cicd-1/">AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 1. 개요</a></li>
<li><a href="/posts/terraform-aws-infra-6/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)</a></li>
<li><a href="/posts/aapt2-arm/">Arm 아키텍처에서 AAPT2 빌드 도구 사용하기</a></li>
<li><a href="/posts/terraform-aws-infra-1/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 1. 개요</a></li>
</ul>
</div>
<div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5">
<div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
<nav id="toc" data-toggle="toc"></nav>
</div>
</div>
</div>
<div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4">
<div id="related-posts" class="mt-5 mb-2 mb-sm-4">
<h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
<div class="card-deck mb-4">
<div class="card"> <a href="/posts/querydsl-qbuilder-qsetter-1/"><div class="card-body"> <em class="small" data-ts="1664316720" data-df="ll"> Sep 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (1)</h3>
<div class="text-muted small"><p> QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (1) - 개요 Querydsl을 사용해 db조회를 하는 경우 엔티티 자체를 반환하는 경우는 잘 없습니다. 대부분 필요한 필드만 지정하여 Projections를 사용하여 조회하게 되는것 같습니다. 잘 알려진 projection 방법에는 3가지가 있습니...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/jpa-union/"><div class="card-body"> <em class="small" data-ts="1673759520" data-df="ll"> Jan 15, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hibernate, Spring Data JPA, QueryDSL 에서 UNION 사용하기</h3>
<div class="text-muted small"><p> JPA 에서 union 사용하기 JPA 환경에서 집합 연산자(UNION, UNION ALL, INTERSECT, EXCEPT)를 사용할 수 있을까요? JPA의 버전이 3.1까지 올라왔어도 아직 이에대한 명세, 지원은 없는 것으로 보입니다. native sql로 작성하면 안되는 쿼리는 없긴 합니다만, 추상화된 SQL을 사용할 수 없다는 단점이 존재합니다...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/spring-data-jpa-custom-querydsl-repository/"><div class="card-body"> <em class="small" data-ts="1675163520" data-df="ll"> Jan 31, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Data JPA - Custom QueryDSL Repository 만들기</h3>
<div class="text-muted small"><p> Spring Data JPA - Custom QueryDSL Repository 만들기 Spring Data JPA를 사용한다면 JpaRepository를 상속한 repository를 만들고 미리 정해진 키워드 들을 사용하여 메소드(쿼리)를 사용하곤 합니다. 그러나 메소드의 길이가 길어진다면 (findByNameAndAgeAndGenderAndPho...</p></div>
</div></a>
</div>
</div>
</div>
<div class="post-navigation d-flex justify-content-between"> <a href="/posts/querydsl-qbuilder-qsetter-1/" class="btn btn-outline-primary" prompt="Older"><p>QueryProjection 에서 한단계 더 나아가 QueryProjectionBuilder 만들기 (1)</p></a> <a href="/posts/dirty-checking/" class="btn btn-outline-primary" prompt="Newer"><p>Dirty Checking</p></a>
</div>
</div></div>
<footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0">
<div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/keencho">keencho</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div>
<div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div>
</div></footer>
</div>
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content">
<div id="search-hints"><div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a>
</div>
</div></div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false">
<div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">×</span> </button>
</div>
<div class="toast-body text-center pt-0">
<p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
<button type="button" class="btn btn-primary" aria-label="Update"> Update </button>
</div>
</div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
