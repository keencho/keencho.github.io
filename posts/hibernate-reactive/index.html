<!DOCTYPE html><html lang="ko-KS" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Hibernate Reactive" /><meta name="author" content="keencho" /><meta property="og:locale" content="ko_KS" /><meta name="description" content="개요 Hibernate Reactive가 드디어 정식 출시 되었습니다. (사실 현재기준 3달 지났습니다.)" /><meta property="og:description" content="개요 Hibernate Reactive가 드디어 정식 출시 되었습니다. (사실 현재기준 3달 지났습니다.)" /><link rel="canonical" href="https://keencho.github.io/posts/hibernate-reactive/" /><meta property="og:url" content="https://keencho.github.io/posts/hibernate-reactive/" /><meta property="og:site_name" content="keencho’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-10T10:12:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hibernate Reactive" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@keencho" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"keencho"},"dateModified":"2022-02-10T10:12:00+09:00","datePublished":"2022-02-10T10:12:00+09:00","description":"개요 Hibernate Reactive가 드디어 정식 출시 되었습니다. (사실 현재기준 3달 지났습니다.)","headline":"Hibernate Reactive","mainEntityOfPage":{"@type":"WebPage","@id":"https://keencho.github.io/posts/hibernate-reactive/"},"url":"https://keencho.github.io/posts/hibernate-reactive/"}</script><title>Hibernate Reactive | keencho's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="keencho's blog"><meta name="application-name" content="keencho's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/custom/keencho.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">keencho's blog</a></div><div class="site-subtitle font-italic">이것저것 정리하는 블로그.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/keencho" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['seyoung050412','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hibernate Reactive</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Hibernate Reactive</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1644455520" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 10, 2022 </em> </span><div class="d-flex justify-content-between"> <span> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2679 words"> <em>14 min</em> read</span></div></div></div><div class="post-content"><h1 id="개요"><strong>개요</strong></h1><p><a href="https://hibernate.org/reactive/">Hibernate Reactive</a>가 드디어 정식 출시 되었습니다. (<del>사실 현재기준 3달 지났습니다.</del>)</p><p><code class="language-plaintext highlighter-rouge">Webflux - R2DBC</code>로 프로젝트를 진행할때 ORM에 대한 갈망을 느끼곤 했었는데, 확실히 갈증을 해소해줄 만한 물건이 나온것 같습니다.</p><p>현재는 <code class="language-plaintext highlighter-rouge">Quarkus</code>, <code class="language-plaintext highlighter-rouge">Panache</code>와 사용했을때 더 효율성을 발휘하는 것으로 보입니다. 그래도 예전 <code class="language-plaintext highlighter-rouge">Spring Data JPA</code>가 나오기전 Hibernate를 사용할때를 떠올리며 내용을 정리해 보았습니다. 언젠가는 <code class="language-plaintext highlighter-rouge">Spring Data Family</code>에 포함되어 <code class="language-plaintext highlighter-rouge">Spring Data Reactive JPA(?)</code>가 나오길 희망해 봅니다.</p><h2 id="hibernate-reactive"><span class="mr-2"><strong>Hibernate Reactive</strong></span><a href="#hibernate-reactive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Webflux가 나온지 4년이 지났습니다. <code class="language-plaintext highlighter-rouge">Spring Data R2DBC</code> 를 통해 non-blocking 하게 데이터베이스에 접근할 수 있지만, 이렇다할 ORM 구현체는 없는 상황이었습니다.</p><p>Hibernate Reactive는 Hibernate ORM 을 위한 리액티브 API로, 데이터베이스에 non-blocking하게 접근할 수 있도록 지원합니다. Hibernate Reactive는 데이터베이스와 non-blocking 방식으로 통신하도록 설계된 최초의 ORM 구현체 입니다.</p><p>또한 많은 부분이 기존의 Hibernate ORM, JPA 2.2 과 동일하기 때문에, 만약 JPA에 대한 이해도가 깊은 분이라면 쉽게 Hibernate Reactive에 적응하실 것이라 생각합니다.</p><h2 id="소개-및-예제"><span class="mr-2"><strong>소개 및 예제</strong></span><a href="#소개-및-예제" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>이어질 내용 부터는 간단한 CRUD 어플리케이션을 만들면서 Hibernate Reactive를 소개해 보겠습니다.</p><h2 id="1-프로젝트-세팅"><span class="mr-2"><strong>1. 프로젝트 세팅</strong></span><a href="#1-프로젝트-세팅" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Spring 진영에서 아직까지는 Hibernate Reactive를 받아들이지 않은 것으로 보입니다만, 다행히도 Spring과 Hibernate Reactive를 조합하는 것은 그리 어렵지 않은것 같습니다. 따라서 저는 <code class="language-plaintext highlighter-rouge">Spring Webflux</code> 기반의 프로젝트를 만들어 보겠습니다.</p><h3 id="11-라이브러리-추가"><span class="mr-2"><strong>1.1. 라이브러리 추가</strong></span><a href="#11-라이브러리-추가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>사용할 라이브러리들을 정의한 gradle 파일 입니다.</p><div class="language-gradle highlighter-rouge"><div class="code-header"> <span data-label-text="Gradle"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">dependencies</span> <span class="o">{</span>
    <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-webflux'</span>
    <span class="n">implementation</span> <span class="s1">'org.hibernate.reactive:hibernate-reactive-core:1.1.2.Final'</span>
    <span class="n">implementation</span> <span class="s1">'io.vertx:vertx-pg-client:4.2.4'</span>
    <span class="n">implementation</span> <span class="s1">'com.ongres.scram:client:2.1'</span>
    <span class="n">implementation</span> <span class="s1">'io.smallrye.reactive:mutiny-reactor:1.3.1'</span>
    <span class="n">implementation</span> <span class="s1">'org.projectlombok:lombok'</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>나중에 com.ongres.scram 클래스가 없다는 에러가 발생시 패키지에 <code class="language-plaintext highlighter-rouge">implementation 'org.hibernate.orm:hibernate-jpamodelgen:6.0.0.CR1'</code> 를 추가해보세요.</p></blockquote><p>이 프로젝트는 PostgreSQL 을 기반으로 진행될 예정 이지만 현재 사용할 수 있는 데이터베이스와 드라이버는 다음과 같습니다.</p><div class="table-wrapper"><table><thead><tr><th>Database<th>Driver dependency<tbody><tr><td>PostgreSQL or CockroachDB<td>io.vertx:vertx-pg-client:{vertxVersion}<tr><td>MySQL or MariaDB<td>io.vertx:vertx-mysql-client:{vertxVersion}<tr><td>DB2<td>io.vertx:vertx-db2-client:{vertxVersion}<tr><td>SQL Server<td>io.vertx:vertx-mssql-client:${vertxVersion}</table></div><h3 id="12-persistencexml-정의"><span class="mr-2"><strong>1.2. persistence.xml 정의</strong></span><a href="#12-persistencexml-정의" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Hibernate Reactive는 표준 JPA persistence.xml 문서를 통해 구성되며, 보통 /META-INF 디렉토리에 배치되어야 합니다.</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="nt">&lt;persistence</span> <span class="na">xmlns=</span><span class="s">"http://xmlns.jcp.org/xml/ns/persistence"</span>
             <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
             <span class="na">xsi:schemaLocation=</span><span class="s">"http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd"</span>
             <span class="na">version=</span><span class="s">"2.2"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">"pu"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;provider&gt;</span>org.hibernate.reactive.provider.ReactivePersistenceProvider<span class="nt">&lt;/provider&gt;</span>

        <span class="nt">&lt;properties&gt;</span>

            <span class="c">&lt;!-- PostgreSQL --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"javax.persistence.jdbc.url"</span>
                      <span class="na">value=</span><span class="s">"jdbc:postgresql://localhost:5432/database"</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- Credentials --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"javax.persistence.jdbc.user"</span>
                      <span class="na">value=</span><span class="s">"user"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"javax.persistence.jdbc.password"</span>
                      <span class="na">value=</span><span class="s">"password"</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- The Vert.x SQL Client connection pool size --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.connection.pool_size"</span>
                      <span class="na">value=</span><span class="s">"10"</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- Automatic schema export --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"javax.persistence.schema-generation.database.action"</span>
                      <span class="na">value=</span><span class="s">"update"</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- SQL statement logging --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.show_sql"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.format_sql"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.highlight_sql"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;/persistence-unit&gt;</span>
<span class="nt">&lt;/persistence&gt;</span>
</pre></table></code></div></div><ul><li>Hibernate Reactive에 유일한 필수 조건은<provier> 요소이며, 이는 꼭 명시되어야 합니다.</provier><li>구성 속성중 JDBC라고 명시되어 있지만 Hibernate Reactive는 JDBC가 없으며 과거 JPA 사양에서 정의한 레거시 속성 이름을 뿐입니다. 특히 Hibernate Reactive는 자체적으로 JDBC URL을 읽고 해석합니다.<li><code class="language-plaintext highlighter-rouge">hibernate.dialect</code> 를 지정할 필요는 없습니다. Hibernate Reactive는 자동으로 알맞은 dialect를 결정합니다.<li>Hibernate는 구성 가능한 많은 것들을 가지고 있지만 이것은 레거시 코드와의 호환성을 위해 유지되고 있을 뿐 JDBC와 JTA와의 직접적인 관련은 없습니다.</ul><p>다음은 자동 스키마 구성에 대한 내용입니다.</p><div class="table-wrapper"><table><thead><tr><th>프로퍼티명<th>설명<tbody><tr><td>javax.persistence.schema-generation.database.action<td>create: 스키마를 삭제하고 테이블, 시퀀스, 제약조건을 생성<tr><td> <td>create-only: 테이블, 시퀀스, 제약조건을 생성<tr><td> <td>create-drop: 스키마를 삭제하고 <code class="language-plaintext highlighter-rouge">SessionFactory</code>가 생성되는 시점에 재생성, 추가적으로 <code class="language-plaintext highlighter-rouge">SessionFactory</code>가 소멸되면 스키마를 삭제<tr><td> <td>drop: <code class="language-plaintext highlighter-rouge">SessionFactory</code>가 소멸되는 시점에 스키마를 삭제<tr><td> <td>validate: 변경없이 데이터베이스 스키마와 엔티티가 일치하는지 검증<tr><td> <td>update: 엔티티와 스키마를 비교하여 스키마에 존재하지 않는 엔티티(혹은 필드)가 존재 한다면 스키마를 업데이트<tr><td>javax.persistence.create-database-schemas<td>(선택사항) 만약 true 라면, 스키마와 카탈로그를 자동 생성<tr><td>javax.persistence.schema-generation.create-source<td>(선택사항) 값이<code class="language-plaintext highlighter-rouge">metadata-then-script</code>혹은 <code class="language-plaintext highlighter-rouge">script-then-metadata</code> 테이블, 시퀀스를 생성할 때 추가 SQL 스크립트를 실행<tr><td>javax.persistence.schema-generation.create-script-source<td>(선택사항) 바로 위에서 실행할 SQL 스크립트 이름</table></div><blockquote><p>주의! Db2의 경우 <code class="language-plaintext highlighter-rouge">validate</code> 와 <code class="language-plaintext highlighter-rouge">update</code>를 지원하지 않습니다.</p></blockquote><h3 id="13-sql-로깅"><span class="mr-2"><strong>1.3 SQL 로깅</strong></span><a href="#13-sql-로깅" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="table-wrapper"><table><thead><tr><th>프로퍼티명<th>설명<tbody><tr><td>hibernate.format.sql<td>true라면, 멀티라인, 들여쓰기 형식으로 로그 기록<tr><td>hibernate.highlight_sql<td>true라면, ANSI 이스케이프 코드를 통해 구문을 강조하는 형태로 로그 기록</table></div><p>위 두 옵션이 모두 true라면 아래와 같이 보이게 됩니다.<br /> <img data-src="/assets/img/custom/hibernate-reactive/logging.png" alt="logging" data-proofer-ignore></p><h2 id="2-java-code-작성"><span class="mr-2"><strong>2. Java code 작성</strong></span><a href="#2-java-code-작성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>본격적으로 자바 코드를 작성해 보겠습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"post"</span><span class="o">)</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Post</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">contents</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">targetEntity</span> <span class="o">=</span> <span class="nc">Author</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Author</span> <span class="n">author</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"author"</span><span class="o">)</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>작성자와 글을 N:1의 연관관계로 표현하였습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">Mutiny</span><span class="o">.</span><span class="na">SessionFactory</span> <span class="nf">sessionFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Persistence</span>
            <span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">(</span><span class="s">"pu"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">unwrap</span><span class="o">(</span><span class="nc">Mutiny</span><span class="o">.</span><span class="na">SessionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">SessionFactory</code> 객체를 bean으로 등록합니다. 이때 <code class="language-plaintext highlighter-rouge">createEntityManagerFactory</code>에 들어갈 값은 <code class="language-plaintext highlighter-rouge">persistence.xml</code> 파일의 <code class="language-plaintext highlighter-rouge">persistence-unit name</code> 의 값과 동일해야 합니다.</p><p><code class="language-plaintext highlighter-rouge">Mutiny</code> 타입과 <code class="language-plaintext highlighter-rouge">Stage</code> 타입을 선택할 수 있는데요, 큰 차이는 없고 공식문서의 코드는 <code class="language-plaintext highlighter-rouge">Mutiny</code>를 선택해였기 때문에 여기서도 <code class="language-plaintext highlighter-rouge">Mutiny</code>를 사용하도록 하겠습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">KcReactiveRepository</span> <span class="o">{</span>

    <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">save</span><span class="o">(</span><span class="no">E</span> <span class="n">entity</span><span class="o">);</span>

    <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;&gt;</span> <span class="nf">listAll</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">);</span>

    <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">id</span><span class="o">);</span>

    <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">deleteById</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">id</span><span class="o">);</span>

    <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">deleteAll</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">record</span> <span class="nf">KcReactiveRepositoryImpl</span><span class="o">(</span><span class="nc">Mutiny</span><span class="o">.</span><span class="na">SessionFactory</span> <span class="n">sessionFactory</span><span class="o">)</span> <span class="kd">implements</span> <span class="nc">KcReactiveRepository</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">save</span><span class="o">(</span><span class="no">E</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">entity</span><span class="o">,</span> <span class="s">"entity must not be null!"</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">withSession</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="n">session</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">entity</span><span class="o">).</span><span class="na">chain</span><span class="o">(</span><span class="nl">session:</span><span class="o">:</span><span class="n">flush</span><span class="o">).</span><span class="na">replaceWith</span><span class="o">(</span><span class="n">entity</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;&gt;</span> <span class="nf">listAll</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">query</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">buildQuery</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>

        <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">withSession</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">query</span><span class="o">).</span><span class="na">getResultList</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="s">"id must not be null!"</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">withSession</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="n">session</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">id</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">deleteById</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="s">"id must not be null!"</span><span class="o">);</span>

        <span class="kt">var</span> <span class="n">criteriaBuilder</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">sessionFactory</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>

        <span class="nc">CriteriaDelete</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">delete</span> <span class="o">=</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">createCriteriaDelete</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">root</span> <span class="o">=</span> <span class="n">delete</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">idField</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredFields</span><span class="o">())</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">field</span> <span class="o">-&gt;</span> <span class="n">field</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">Id</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="o">.</span><span class="na">findFirst</span><span class="o">().</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">idField</span><span class="o">,</span> <span class="s">"id field of entity must not be null!"</span><span class="o">);</span>

        <span class="n">delete</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">idField</span><span class="o">.</span><span class="na">getName</span><span class="o">()),</span> <span class="n">id</span><span class="o">));</span>

        <span class="k">return</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">((</span><span class="n">session</span><span class="o">,</span> <span class="n">tx</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">delete</span><span class="o">).</span><span class="na">executeUpdate</span><span class="o">());</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">deleteAll</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="s">"class not not be null!"</span><span class="o">);</span>

        <span class="kt">var</span> <span class="n">criteriaBuilder</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">sessionFactory</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>

        <span class="nc">CriteriaDelete</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">delete</span> <span class="o">=</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">createCriteriaDelete</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="n">delete</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">((</span><span class="n">session</span><span class="o">,</span> <span class="n">tx</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">delete</span><span class="o">).</span><span class="na">executeUpdate</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">buildQuery</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">().</span><span class="na">createQuery</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>대망의 리포지토리 코드입니다. 문서를 보며 만들다 보니 모듈화 할수있는 부분이 보여 모듈화하여 코드를 작성해 보았습니다. 간단한 CRUD 기능을 수행할 수 있는 리포지토리 입니다.</p><p>중간에 <code class="language-plaintext highlighter-rouge">deleteById</code>의 경우 기본키가 하나일 경우만을 생각하고 작성하였습니다. 복합키는 고려대상이 아닙니다.</p><p><code class="language-plaintext highlighter-rouge">SessionFactory</code>를 의존성으로 주입받아야 하기 때문에 아래 bean을 등록해 줍니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">KcReactiveRepository</span> <span class="nf">kcReactiveRepository</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">KcReactiveRepositoryImpl</span><span class="o">(</span>
            <span class="nc">Persistence</span>
                    <span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">(</span><span class="s">"pu"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">unwrap</span><span class="o">(</span><span class="nc">Mutiny</span><span class="o">.</span><span class="na">SessionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>마지막으로, 위에서 작성한 리포지토리를 사용해 각각의 도메인에서 CRUD 기능을 수행하는 클래스들을 생성하였습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PostRepository</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">KcReactiveRepository</span> <span class="n">kcReactiveRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="nf">save</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">String</span> <span class="n">contents</span><span class="o">,</span> <span class="nc">Author</span> <span class="n">author</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Post</span> <span class="n">entity</span> <span class="o">=</span> <span class="nc">Post</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">title</span><span class="o">(</span><span class="n">title</span><span class="o">)</span>
                <span class="o">.</span><span class="na">contents</span><span class="o">(</span><span class="n">contents</span><span class="o">)</span>
                <span class="o">.</span><span class="na">author</span><span class="o">(</span><span class="n">author</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">kcReactiveRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;&gt;</span> <span class="nf">listAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">kcReactiveRepository</span><span class="o">.</span><span class="na">listAll</span><span class="o">(</span><span class="nc">Post</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">kcReactiveRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="nc">Post</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">deleteAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">kcReactiveRepository</span><span class="o">.</span><span class="na">deleteAll</span><span class="o">(</span><span class="nc">Post</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">deleteById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">kcReactiveRepository</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="nc">Post</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthorRepository</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">KcReactiveRepository</span> <span class="n">kcReactiveRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="nf">save</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Author</span> <span class="n">entity</span> <span class="o">=</span> <span class="nc">Author</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">kcReactiveRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;&gt;</span> <span class="nf">listAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">kcReactiveRepository</span><span class="o">.</span><span class="na">listAll</span><span class="o">(</span><span class="nc">Author</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">kcReactiveRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="nc">Author</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">deleteAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">kcReactiveRepository</span><span class="o">.</span><span class="na">deleteAll</span><span class="o">(</span><span class="nc">Author</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Uni</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">deleteById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">kcReactiveRepository</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="nc">Author</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><h2 id="3-테스트"><span class="mr-2"><strong>3. 테스트</strong></span><a href="#3-테스트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>코드 작성이 모두 끝났습니다. 기능이 잘 동작하는지 테스트를 수행해 보겠습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">fullTest</span><span class="o">()</span> <span class="o">{</span>

    <span class="kt">var</span> <span class="n">simpleAuthor</span> <span class="o">=</span> <span class="n">authorRepository</span>
            <span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="s">"홍길동"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">await</span><span class="o">()</span>
            <span class="o">.</span><span class="na">indefinitely</span><span class="o">();</span>

    <span class="nc">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">11</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">idx</span> <span class="o">-&gt;</span> <span class="o">{</span>
       <span class="kt">var</span> <span class="n">uni</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="s">"title"</span> <span class="o">+</span> <span class="n">idx</span><span class="o">,</span> <span class="s">"contents"</span><span class="o">+</span> <span class="n">idx</span><span class="o">,</span> <span class="n">simpleAuthor</span><span class="o">);</span>
       <span class="n">uni</span><span class="o">.</span><span class="na">await</span><span class="o">().</span><span class="na">indefinitely</span><span class="o">();</span>
    <span class="o">});</span>

    <span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>

    <span class="kt">var</span> <span class="n">authorList</span> <span class="o">=</span> <span class="n">authorRepository</span><span class="o">.</span><span class="na">listAll</span><span class="o">().</span><span class="na">await</span><span class="o">().</span><span class="na">indefinitely</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">postList</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">listAll</span><span class="o">().</span><span class="na">await</span><span class="o">().</span><span class="na">indefinitely</span><span class="o">();</span>

    <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">authorList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">,</span> <span class="s">"size of author list must be 1"</span><span class="o">);</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">postList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">10</span><span class="o">,</span> <span class="s">"size of post list must be 10"</span><span class="o">);</span>

    <span class="kt">long</span> <span class="n">authorId</span> <span class="o">=</span> <span class="n">authorList</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">findFirst</span><span class="o">().</span><span class="na">get</span><span class="o">().</span><span class="na">getId</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">postId</span> <span class="o">=</span> <span class="n">postList</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">findAny</span><span class="o">().</span><span class="na">get</span><span class="o">().</span><span class="na">getId</span><span class="o">();</span>

    <span class="kt">var</span> <span class="n">deleteNotExistAuthor</span> <span class="o">=</span> <span class="n">authorRepository</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="n">authorId</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="na">await</span><span class="o">().</span><span class="na">indefinitely</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">deleteExistPost</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="n">postId</span><span class="o">).</span><span class="na">await</span><span class="o">().</span><span class="na">indefinitely</span><span class="o">();</span>

    <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">deleteNotExistAuthor</span> <span class="o">==</span> <span class="mi">0</span><span class="o">,</span> <span class="s">"query result of delete empty author must be 0"</span><span class="o">);</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">deleteExistPost</span> <span class="o">==</span> <span class="mi">1</span><span class="o">,</span> <span class="s">"query result of delete post must be 1"</span><span class="o">);</span>

<span class="o">}</span>
</pre></table></code></div></div><ol><li>author과 post를 insert 합니다.<li>모든 author 과 post를 불러와 잘 insert 되었는지 확인합니다.<li>삭제를 통해 쿼리 수행 결과가 잘 넘어오는지 확인합니다.</ol><p>만약 webflux 에서 Mono, Flux 객체를 리턴해야 한다면</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">return</span> <span class="nc">ServerResponse</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">body</span><span class="o">(</span><span class="n">postRepository</span><span class="o">.</span><span class="na">listAll</span><span class="o">().</span><span class="na">convert</span><span class="o">().</span><span class="na">with</span><span class="o">(</span><span class="n">toMono</span><span class="o">()));</span>
</pre></table></code></div></div><p>위와같이 <code class="language-plaintext highlighter-rouge">mutiny-reactor</code> 패키지에 있는 <code class="language-plaintext highlighter-rouge">toMono()</code> 를 사용하여 Uni를 Mono, Flux로 변환하여 반환하면 되겠습니다.</p><h2 id="마무리"><span class="mr-2"><strong>마무리</strong></span><a href="#마무리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>기존의 JPA를 그리워 하면서 Webflux - Spring Data R2DBC 를 사용하고 계셨던 분들에게는 희소식이지 않을까 싶습니다. 또한 기존 JPA 스펙과 크게 다르지 않은 것으로 보아하니 기존의 JPA와 non-blocking 코드에 익숙하신 분들이라면 쉽게 익힐수 있을 것이라 생각합니다.</p><p>저도 ‘Webflux는 쓸만한 orm 라이브러리 나오면 제대로 파야지~’ 라고 생각하곤 했었는데 이제 제대로 한번 공부해봐야 겠습니다.</p><h2 id="참조"><span class="mr-2"><strong>참조</strong></span><a href="#참조" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://hibernate.org/reactive/documentation/1.1/reference/html_single/">https://hibernate.org/reactive/documentation/1.1/reference/html_single/</a><li><a href="https://itnext.io/integrating-hibernate-reactive-with-spring-5427440607fe?gif=true">https://itnext.io/integrating-hibernate-reactive-with-spring-5427440607fe?gif=true</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a> <a href="/tags/hibernate/" class="post-tag no-text-decoration" >Hibernate</a> <a href="/tags/webflux/" class="post-tag no-text-decoration" >Webflux</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hibernate+Reactive+-+keencho%27s+blog&url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fhibernate-reactive%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hibernate+Reactive+-+keencho%27s+blog&u=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fhibernate-reactive%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fkeencho.github.io%2Fposts%2Fhibernate-reactive%2F&text=Hibernate+Reactive+-+keencho%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/jpa-flush/">JPA & Hibernate Flush Mode</a><li><a href="/posts/aws-cicd-1/">AWS를 사용해 무중단 배포 자동화 환경 구축하기 - 1. 개요</a><li><a href="/posts/terraform-aws-infra-6/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 6. 운영환경 (백엔드)</a><li><a href="/posts/aapt2-arm/">Arm 아키텍처에서 AAPT2 빌드 도구 사용하기</a><li><a href="/posts/terraform-aws-infra-1/">Terraform으로 AWS 무중단 배포 인프라 구성하기 - 1. 개요</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/proxy-pattern/"><div class="card-body"> <em class="small" data-ts="1625310720" data-df="ll" > Jul 3, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>프록시 패턴 (Proxy Pattern)</h3><div class="text-muted small"><p> 프록시 패턴 프록시(Proxy) 는 대리자 라는 뜻입니다. 실생활서의 의미처럼 프로그램에서의 프록시도 누군가에게 어떤 일을 대신 시키는 것 이란 의미를 가지고 있습니다. 때때로 우리는 객체에 대한 액세스를 제어하는 기능을 필요합니다. 예를 들어 무겁고 많은 자원을 필요로 하는 클래스의 한두가지 메소드만 사용해야 하더라도 생성자로 전체 클래스를 인스턴...</p></div></div></a></div><div class="card"> <a href="/posts/singleton-pattern/"><div class="card-body"> <em class="small" data-ts="1625569920" data-df="ll" > Jul 6, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>싱글턴 패턴 (Singleton Pattern)</h3><div class="text-muted small"><p> 싱글턴 패턴 싱글턴 패턴은 생성자가 여러 차례 호출되더라도 실제로 생성되는 객체는 하나이고 최초 생성 이후 호출된 생성자는 최초의 생성자가 생성한 객체를 리턴하는 디자인 유형입니다. 구조 싱글턴 클래스는 자체 클래스의 동일한 인스턴스를 반환하는 getInstance() 라는 정적 메소드를 선언했습니다. 싱글턴의 생성자는 ...</p></div></div></a></div><div class="card"> <a href="/posts/observer-pattern/"><div class="card-body"> <em class="small" data-ts="1625829120" data-df="ll" > Jul 9, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>옵저버 패턴 (Observer Pattern)</h3><div class="text-muted small"><p> 옵저버 패턴 옵저버 패턴은 객체의 상태 변화를 관찰하는 관찰자들, 즉 옵저버의 목록을 객체에 등록하여 상태 변화가 있을 때마다 메스드 등을 통해 객체가 직접 목록의 각 옵저버에게 통지하도록 하는 디자인 패턴입니다. 구조 게시자는 다른 객체들에게 관심 이벤트를 발행합니다. 이 이벤트난 게시자가 상태를 변경하거나 어떤 동작을 실행할 때 발생합니...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/github-personal-repo/" class="btn btn-outline-primary" prompt="Older"><p>Github로 자바 라이브러리 배포하기</p></a> <a href="/posts/home-server/" class="btn btn-outline-primary" prompt="Newer"><p>홈서버 구축기</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/keencho">keencho</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/querydsl/">QueryDSL</a> <a class="post-tag" href="/tags/react/">React</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
